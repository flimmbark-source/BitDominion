var xs=Object.defineProperty;var Ys=(r,e,t)=>e in r?xs(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var d=(r,e,t)=>Ys(r,typeof e!="symbol"?e+"":e,t);class v{constructor(e=0,t=0){this.x=e,this.y=t}clone(){return new v(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}set(e,t){return this.x=e,this.y=t,this}add(e){return this.x+=e.x,this.y+=e.y,this}subtract(e){return this.x-=e.x,this.y-=e.y,this}scale(e){return this.x*=e,this.y*=e,this}length(){return Math.hypot(this.x,this.y)}lengthSq(){return this.x*this.x+this.y*this.y}distanceTo(e){return Math.hypot(this.x-e.x,this.y-e.y)}normalize(){const e=this.length();return e>0&&this.scale(1/e),this}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}clamp(e,t,i,s){return this.x=Math.max(e,Math.min(i,this.x)),this.y=Math.max(t,Math.min(s,this.y)),this}limit(e){const t=e*e,i=this.lengthSq();if(i>t&&i>0){const s=Math.sqrt(i);this.scale(e/s)}return this}}function xt(r){const e=r.replace("#",""),t=parseInt(e,16);return{r:t>>16&255,g:t>>8&255,b:t&255}}function Xs(r){const e=i=>Math.max(0,Math.min(255,Math.round(i))),t=i=>e(i).toString(16).padStart(2,"0");return`#${t(r.r)}${t(r.g)}${t(r.b)}`}function se(r,e,t){const i=Math.max(0,Math.min(1,t)),s=xt(r),n=xt(e);return Xs({r:s.r+(n.r-s.r)*i,g:s.g+(n.g-s.g)*i,b:s.b+(n.b-s.b)*i})}const M=1600,vs=800,U=1200,G=U,ys=60,O=36,N=new v(M-80,80),Zs=new v(M/2,U/2),Yt=20,bs=25,Js=3,en=new v(M/2+200,U/2),tn=34,sn=70,nn="#78350f",on="#b45309",an="#fbbf24",rn="#431407",ln=2.5,cn=Yt/2+30,hn=6,dn="rgba(130, 60, 200, 0.35)",un={r:200,g:150,b:255},pn=8,Mi=.35,ce=6,fn=.3,gn=.96,Ci=1,Ii=5,oe=10,mn=1.15,vn=160,Pt=1.35,yn=360,bn=1,wn=8,Xe=32,Ei=100,At=.4,Tn=.8,Rt=[1,3],V=.15,Sn=.22,Xt=16,kn=3,_n=40,Pi=.6,Ai=1.5,ws=18,Mn=40,Cn=120,In=1.3,Ts={scout:{base:"#C7364D",alert:"#FF7A84",accent:"#FFD166",detail:"#FFECD1"},tank:{base:"#5B3A24",alert:"#D38B41",accent:"#F1B85B",detail:"#F4E4C1"},priest:{base:"#423F9C",alert:"#B59CFF",accent:"#7CD3FF",detail:"#F1E8FF"}},$={scout:{cost:10,minSpeed:.25,maxSpeed:.45,detectionRadius:80,maxHp:2,size:4,attackDamage:1.5,attackRange:10,attackCooldown:.35,attackVisualDuration:.2,attackType:"melee"},tank:{cost:25,minSpeed:.125,maxSpeed:.225,detectionRadius:60,maxHp:5,size:5,attackDamage:2,attackRange:12,attackCooldown:1.2,attackVisualDuration:.45,attackType:"melee"},priest:{cost:20,minSpeed:.2,maxSpeed:.3,detectionRadius:70,maxHp:3,size:4,attackDamage:1,attackRange:80,attackCooldown:.8,attackVisualDuration:.3,attackType:"ranged"}},Ze=Math.max(...Object.values($).map(r=>r.size))/2,Ri=Math.min(...Object.values($).map(r=>r.cost)),le=3,En=140,Pn=80,Zt=25,Je=3,An="#DCC23C",Rn="#FFFFFF",Di=15,Dn=22,Ln="#000000",On="#14C814",Nn="#8200B4",Bn="#DCDCDC",Dt=220,et=16,Fn="rgba(220, 220, 220, 0.2)",qn="rgba(220, 220, 220, 0.75)",Hn=On,Wn="#50C878",Un="#DC3C3C",Gn="#1E5B31",$n="rgba(46, 120, 70, 0.9)",Vn="#9C6D3C",Kn="rgba(220, 170, 110, 0.9)",Qn="#D9B357",zn="#F2D48A",jn="#E8DBA9",xn="#FFB86C",Yn="#FFA552",Xn=3,Lt=xt(Nn),Li=6,Jt=280,Zn=1.5,Ot=30,Jn=10,eo=4,Oi=.5,Ni=4,to=Math.PI*1.6,io=45,so=.4,Bi=20,no=60,oo=.2,ao=160,ei=2,ro=12,lo=10,co=6,ho=9,uo=16,Fe=240,Fi=60,po=32,qi=35,fo=.12,go=.08,mo=3,Nt=[3,5],vo=18,yo=1,Hi=["scout","scout","tank","priest"],lt=120,bo=160,wo=1,Wi=.45,Ui=180,To=1.1,So=.5,ko=4.5,Gi=3,_o=44,Mo=.3,Co=.6,Io=60,Eo=.35,Po=1.2,$i=260,Ao=1.6,Ro=.85,Do=2,Vi=7,Lo=70,Ki=5.5,Oo=.55,No=90,Bo=.35,Qi=6.5,Fo=2.5,Bt=18,Ss=22,Ft=70,qo=75,Ho=90,Wo=24,ks=8,Uo=14,Go=.3,fi={watchtower:{width:8,height:8,cost:20,maxHp:3,buildTime:2},barricade:{width:10,height:4,cost:12,maxHp:4,buildTime:1},spike:{width:6,height:6,cost:10,maxHp:1,buildTime:.8},beacon:{width:6,height:6,cost:15,maxHp:2,buildTime:1},workshop:{width:10,height:10,cost:25,maxHp:4,buildTime:2.2}},zi=4,$o=1,Vo=3,Ko=10,ti=18,Qo=18,zo=1,qt=3,jo=.6,xo=.9,ji=160,xi=.6,Yo=1,Xo=420,Zo=6,Jo=1.25,ea=140,Yi=2,ta=10,ia=.7,sa=.8,na=5,Xi=.5,Ht=180,oa=.3,aa=4,ra=260,la=160,_s=2.5;class Zi{constructor(){d(this,"evilEnergy",0);d(this,"energyAccumulator",0);d(this,"lastDeployedWave",0)}update(e,t){this.accumulateEnergy(e)}beginWave(e,t){if(t<=this.lastDeployedWave||(this.lastDeployedWave=t,this.evilEnergy<Ri))return;const i=this.planWaveComposition(e,t);if(!i.length)return;const s=e.getWaveRallyPoint()??N.clone(),n=this.planWaveFormation(i,s);for(const{type:o,position:l}of n)if(!e.canSpawnMoreUnits()||!this.spawnUnit(e,o,l))break}registerKnightReveal(e){}planWaveComposition(e,t){const i=[];let s=this.evilEnergy;if(s<Ri)return i;const n=Math.max(0,Xt-e.getUnitCount());if(n===0)return i;const o=Math.min(n,Math.max(1,Math.floor((t+1)/2))),l=Math.min(n,Math.max(1,Math.floor((t+2)/3))),a=Math.min(n,Math.max(3,4+t)),c=(h,p)=>{for(let u=0;u<p;u++){if(i.length>=n)return;const f=$[h].cost;if(s<f)return;i.push(h),s-=f}};for(c("tank",o),c("priest",l),c("scout",a);s>=$.scout.cost&&i.length<n;)i.push("scout"),s-=$.scout.cost;return i}planWaveFormation(e,t){if(!e.length)return[];const i=t.clone().subtract(N);i.lengthSq()<1e-4&&i.set(0,1),i.normalize();const s=new v(-i.y,i.x).normalize(),n={scout:0,tank:0,priest:0};for(const l of e)n[l]+=1;const o={tank:this.buildTankFormation(n.tank,t,i,s),priest:this.buildPriestFormation(n.priest,t,i,s),scout:this.buildScoutFormation(n.scout,t,i,s)};return e.map(l=>{const a=o[l],c=a.length?a.shift():this.jitter(t,14);return{type:l,position:c}})}buildTankFormation(e,t,i,s){const n=[];for(let h=0;h<e;h++){const p=Math.floor(h/2),f=h%2-1/2,y=34+p*20,w=f*18,b=this.offsetFromRally(t,i,s,y,w);n.push(this.jitter(b,8))}return n}buildPriestFormation(e,t,i,s){const n=[];for(let h=0;h<e;h++){const p=Math.floor(h/3),f=h%3-2/2,y=-26+p*-18,w=f*16,b=this.offsetFromRally(t,i,s,y,w);n.push(this.jitter(b,6))}return n}buildScoutFormation(e,t,i,s){const n=[];for(let h=0;h<e;h++){const p=h%2===0?1:-1,u=Math.floor(h/2),f=p*(32+u*12),y=18+u%3*10,w=this.offsetFromRally(t,i,s,y,f);n.push(this.jitter(w,12))}return n}offsetFromRally(e,t,i,s,n){return e.clone().add(t.clone().scale(s)).add(i.clone().scale(n))}accumulateEnergy(e){if(this.energyAccumulator+=e*kn,this.energyAccumulator>=1){const t=Math.floor(this.energyAccumulator);this.evilEnergy+=t,this.energyAccumulator-=t}}spawnUnit(e,t,i){return!this.canAfford(t)||!e.spawnUnit(t,i)?!1:(this.evilEnergy-=$[t].cost,!0)}canAfford(e){return this.evilEnergy>=$[e].cost}jitter(e,t){const i=Math.random()*Math.PI*2,s=Math.random()*t;return e.clone().add(new v(Math.cos(i)*s,Math.sin(i)*s))}}let ca=1;function ha(r,e){const t=fi[r];return{id:ca++,type:r,position:e.clone(),state:"foundation",progress:0,hp:t.maxHp,dismantleProgress:0,repairProgress:0,auraMultiplier:1,data:{}}}function J(r){return fi[r]}function ne(r){const{width:e,height:t}=fi[r];return{halfWidth:e/2,halfHeight:t/2}}function Wt(r,e){return r.position.distanceTo(e)<=ti}const da=6,ua=ei*3,pa=Math.PI*.9;class fa{constructor(e,t,i,s="dark",n={}){d(this,"velocity",new v);d(this,"detecting",!1);d(this,"wanderTimer",0);d(this,"alive",!0);d(this,"hp");d(this,"behavior","idle");d(this,"id");d(this,"allegiance");d(this,"attackCooldownTimer",0);d(this,"attackVisualTimer",0);d(this,"attackVisualDuration",0);d(this,"lastAttackTarget",null);d(this,"lastAttackOrigin",null);d(this,"lineOfSightTimer",0);d(this,"searchTimer",0);d(this,"searchAngle",0);d(this,"searchRadius",0);d(this,"searchOrigin",null);d(this,"investigationTimer",0);d(this,"investigationTarget",null);d(this,"investigationArrived",!1);d(this,"investigationTravelTimer",0);d(this,"investigationOrbitAngle",0);d(this,"investigationOrbitRadius",0);d(this,"detectionTint",0);d(this,"priestProximityTimer",0);d(this,"priestRevealTimer",0);d(this,"roadAssistTimer",0);d(this,"buildingTargetId",null);d(this,"buildingFocusTimer",0);d(this,"buildingRetargetCooldown",0);d(this,"buildingAttackTimer",0);d(this,"slowTimer",0);d(this,"speedMultiplier",1);d(this,"dotEffects",[]);d(this,"lairCenter",null);d(this,"lairRadius",lt);d(this,"facingAngle",Math.random()*Math.PI*2);d(this,"hurtFlashTimer",0);d(this,"hurtFlashDuration",.22);if(this.pos=e,this.type=t,this.hp=$[t].maxHp,this.id=i,this.allegiance=n.allegiance??s,this.pickNewDirection(),this.allegiance==="wild"){const o=n.lairCenter??e;this.lairCenter=o.clone(),this.lairRadius=n.lairRadius??lt}else this.lairCenter=null,this.lairRadius=lt}update(e,t,i,s){if(this.updateDotEffects(e),!this.alive)return;const n=e*ys;this.hurtFlashTimer>0&&(this.hurtFlashTimer=Math.max(0,this.hurtFlashTimer-e));const o=$[this.type],l=this.allegiance==="dark",a=this.allegiance==="wild";this.slowTimer>0&&(this.slowTimer=Math.max(0,this.slowTimer-e),this.slowTimer===0&&(this.speedMultiplier=1)),this.buildingRetargetCooldown>0&&(this.buildingRetargetCooldown=Math.max(0,this.buildingRetargetCooldown-e)),l?this.updateBuildingFocus(e,i,s):this.clearBuildingTarget();const h=t.pos.clone().subtract(this.pos).length(),p=this.detecting;let u=h<=o.detectionRadius&&s.hasLineOfSight(this.pos,t.pos);a&&this.lairCenter&&this.lairCenter.distanceTo(t.pos)>this.lairRadius&&(u=!1);const f=this.canTankPersist(h,o);switch(u?this.detecting=!0:f||(this.detecting=!1),u&&h>0?(this.lineOfSightTimer+=e,this.lineOfSightTimer>=Oi&&this.lineOfSightTimer-e<Oi&&(l&&this.type==="scout"&&console.log(`[SCOUT] Howl! Knight spotted at (${t.pos.x.toFixed(0)}, ${t.pos.y.toFixed(0)})`),l&&i.registerKnightSighting(t.pos)),this.behavior="chasing",this.searchTimer=Ni,this.searchOrigin=t.pos.clone()):(l&&p&&this.behavior==="chasing"&&!f&&this.beginSearch(i),f?this.behavior="chasing":this.lineOfSightTimer=0),this.behavior==="investigating"&&this.detecting&&this.clearInvestigationState(),this.updateDetectionTint(n),this.updatePriestReveal(e,h,t,i,l),this.roadAssistTimer>0&&(this.roadAssistTimer=Math.max(0,this.roadAssistTimer-e)),this.behavior){case"chasing":s.isPointOnRoad(this.pos)&&(this.roadAssistTimer=Math.max(this.roadAssistTimer,2)),this.steerTowards(this.getChaseTarget(t,i),o.maxSpeed*this.speedMultiplier,n,V,this.roadAssistTimer>0);break;case"searching":if(!l){this.behavior="idle";break}s.isPointOnRoad(this.pos)&&(this.roadAssistTimer=Math.max(this.roadAssistTimer,2)),this.updateSearch(e,i,o,n,s,l);break;case"investigating":if(!l){this.behavior="idle";break}this.updateInvestigation(e,o,n);break;default:this.updateIdle(e,i,o,n);break}if(s.applyTerrainSteering(this,this.getHalfSize(),e,{entityType:"monster"}),this.pos.add(this.velocity.clone().scale(n)),s.resolveStaticCollisions(this.pos,this.getHalfSize(),{entityType:"monster"}),s.constrainToArena(this,this.getHalfSize(),{bounce:!0}),a&&this.lairCenter){const y=this.pos.clone().subtract(this.lairCenter);if(y.length()>this.lairRadius){const b=y.lengthSq()>0?y.normalize():new v(1,0);this.pos.copy(this.lairCenter.clone().add(b.scale(this.lairRadius))),this.velocity.scale(.35)}}this.velocity.lengthSq()>1e-4&&(this.facingAngle=Math.atan2(this.velocity.y,this.velocity.x)),this.attackCooldownTimer>0&&(this.attackCooldownTimer=Math.max(0,this.attackCooldownTimer-e)),this.attackVisualTimer>0&&(this.attackVisualTimer=Math.max(0,this.attackVisualTimer-e),this.attackVisualTimer===0&&(this.lastAttackTarget=null,this.lastAttackOrigin=null,this.attackVisualDuration=0))}startInvestigation(e){!this.alive||this.behavior==="chasing"||this.allegiance!=="dark"||(this.behavior="investigating",this.investigationTarget=e.clone(),this.investigationTimer=ei,this.investigationArrived=!1,this.investigationTravelTimer=0,this.investigationOrbitAngle=Math.random()*Math.PI*2,this.investigationOrbitRadius=5+Math.random()*6)}notifyNoise(e){!this.alive||this.allegiance!=="dark"||this.type!=="scout"||this.behavior!=="idle"||this.pos.distanceTo(e)<=ao&&this.startInvestigation(e)}receiveArcHit(e,t){return this.alive?(this.takeDamage(Math.max(0,t)),this.type==="tank"&&this.applyTankKnockback(e),!this.alive):!1}tryAttack(e,t,i,s){if(!this.alive||this.attackCooldownTimer>0)return;const n=$[this.type],o=n.attackType==="ranged",l=n.attackRange,a=this.buildingTargetId!=null?i.getBuildingById(this.buildingTargetId):null;if(a&&a.state==="active"){const{halfWidth:f,halfHeight:y}=ne(a.type),w=this.pos.distanceTo(a.position),b=Math.max(f,y),S=l+b;if(w<=S&&(!o||t.hasLineOfSight(this.pos,a.position)))for(this.buildingAttackTimer+=s;this.buildingAttackTimer>=Xi;){this.buildingAttackTimer-=Xi;const C=this.type==="tank"?2:1;i.damageBuilding(a.id,C),i.emitNoise(a.position,na),this.attackVisualTimer=n.attackVisualDuration,this.attackVisualDuration=n.attackVisualDuration,this.lastAttackTarget=a.position.clone(),this.lastAttackOrigin=this.pos.clone()}else this.buildingAttackTimer=0;return}this.buildingAttackTimer=0;let c=null,h=null,p=null;if(this.pos.distanceTo(e.pos)<=l&&(!o||t.hasLineOfSight(this.pos,e.pos))?(c="knight",h=e.pos.clone()):this.allegiance!=="wild"&&(p=t.findClosestVillager(this.pos,l),p&&(!o||t.hasLineOfSight(this.pos,p.pos))&&(c="villager",h=p.pos.clone())),!(!c||!h)){if(this.attackCooldownTimer=n.attackCooldown,this.attackVisualTimer=n.attackVisualDuration,this.attackVisualDuration=n.attackVisualDuration,this.lastAttackTarget=h.clone(),this.lastAttackOrigin=this.pos.clone(),o){const f=h.clone().subtract(this.pos);i.spawnDarkProjectile({position:this.pos,direction:f,damage:n.attackDamage,speed:ra,maxDistance:la,radius:_s,sourceUnitId:this.id});return}c==="knight"?e.hp=Math.max(0,e.hp-n.attackDamage):p&&t.damageVillager(p,n.attackDamage)}}takeDamage(e){e<=0||(this.hp=Math.max(0,this.hp-e),this.hurtFlashTimer=this.hurtFlashDuration,this.hp===0&&(this.alive=!1))}draw(e){if(!this.alive)return;const t=Ts[this.type],i=this.getHalfSize(),s=se(t.base,t.alert,this.detectionTint),n=this.detecting?se(s,"#FFFFFF",Math.min(.5,this.detectionTint*.6)):s;let o=n;const l=this.hurtFlashDuration>0?this.hurtFlashTimer/this.hurtFlashDuration:0;if(l>0&&(o=se(o,"#FFFFFF",Math.min(.9,.65+l*.5))),this.attackVisualTimer>0&&this.attackVisualDuration>0){const u=1-this.attackVisualTimer/this.attackVisualDuration,f=Math.max(0,Math.min(1,.6*(1-u)));o=se(n,"#FFFFFF",f)}const a=se(t.accent,"#FFFFFF",Math.min(.35,this.detectionTint*.4)),c=se(t.detail,"#FFFFFF",Math.min(.25,this.detectionTint*.3)),h=l>0?se(a,"#FFEED0",Math.min(.8,l*.9)):a,p=l>0?se(c,"#FFF7E8",Math.min(.7,l*.8)):c;switch(e.save(),e.translate(this.pos.x,this.pos.y),e.rotate(this.facingAngle),l>0?(e.shadowColor=`rgba(255, 206, 120, ${.45*l})`,e.shadowBlur=12*l):e.shadowBlur=0,this.type){case"scout":{e.fillStyle=o,e.beginPath(),e.moveTo(i*1.5,0),e.lineTo(-i*.9,-i*1.05),e.lineTo(-i*.4,0),e.lineTo(-i*.9,i*1.05),e.closePath(),e.fill(),e.fillStyle=h,e.beginPath(),e.moveTo(i*.8,0),e.lineTo(-i*.15,-i*.55),e.lineTo(-i*.15,i*.55),e.closePath(),e.fill(),e.fillStyle=p,e.beginPath(),e.arc(-i*.45,0,i*.25,0,Math.PI*2),e.fill(),e.strokeStyle=p,e.lineWidth=1,e.lineJoin="round",e.beginPath(),e.moveTo(i*1.5,0),e.lineTo(-i*.9,-i*1.05),e.lineTo(-i*.9,i*1.05),e.closePath(),e.stroke();break}case"tank":{const u=i*1.15,f=i*1.25;e.fillStyle=o,e.beginPath(),e.moveTo(u,0),e.lineTo(u*.45,-f),e.lineTo(-u*.45,-f),e.lineTo(-u,0),e.lineTo(-u*.45,f),e.lineTo(u*.45,f),e.closePath(),e.fill(),e.fillStyle=h,e.beginPath(),e.moveTo(u*.8,0),e.lineTo(u*.35,-f*.55),e.lineTo(-u*.35,-f*.55),e.lineTo(-u*.8,0),e.lineTo(-u*.35,f*.55),e.lineTo(u*.35,f*.55),e.closePath(),e.fill(),e.fillStyle=p,e.beginPath(),e.arc(0,0,i*.35,0,Math.PI*2),e.fill(),e.strokeStyle=p,e.lineWidth=1.4,e.lineJoin="round",e.beginPath(),e.moveTo(u,0),e.lineTo(u*.45,-f),e.lineTo(-u*.45,-f),e.lineTo(-u,0),e.lineTo(-u*.45,f),e.lineTo(u*.45,f),e.closePath(),e.stroke();break}case"priest":{e.fillStyle=o,e.beginPath(),e.ellipse(0,0,i*1.1,i*1.05,0,0,Math.PI*2),e.fill(),e.fillStyle=h,e.beginPath(),e.arc(0,0,i*.65,0,Math.PI*2),e.fill(),e.strokeStyle=p,e.lineWidth=1.2,e.beginPath(),e.arc(0,0,i*.85,0,Math.PI*2),e.stroke(),e.fillStyle=p,e.beginPath(),e.moveTo(0,-i*.3),e.lineTo(i*.3,0),e.lineTo(0,i*.3),e.lineTo(-i*.3,0),e.closePath(),e.fill();break}}if(e.restore(),this.type==="priest"&&this.priestRevealTimer>0){const u=Math.min(1,this.priestRevealTimer/Ai);e.save(),e.strokeStyle=`rgba(255, 255, 255, ${(.35+u*.35).toFixed(2)})`,e.lineWidth=1.5,e.beginPath(),e.arc(this.pos.x,this.pos.y,i+4,0,Math.PI*2),e.stroke(),e.restore()}this.attackVisualTimer>0&&this.lastAttackTarget&&this.drawAttackVisual(e)}drawAttackVisual(e){if(!this.lastAttackTarget)return;const t=$[this.type],i=this.lastAttackOrigin??this.pos,s=this.attackVisualDuration>0?this.attackVisualDuration:1,o=1-Math.min(1,Math.max(0,1-this.attackVisualTimer/s));switch(e.save(),this.type){case"scout":{const l=this.lastAttackTarget.clone().subtract(i);l.lengthSq()===0?l.set(1,0):l.normalize();const a=Math.min(t.attackRange+6,18),c=i.clone().add(l.clone().scale(2)),h=i.clone().add(l.clone().scale(a));e.strokeStyle=`rgba(255, 220, 200, ${.85*o})`,e.lineWidth=2,e.lineCap="round",e.beginPath(),e.moveTo(c.x,c.y),e.lineTo(h.x,h.y),e.stroke(),e.globalAlpha=.4*o,e.fillStyle="#FFD6D6",e.beginPath(),e.arc(this.lastAttackTarget.x,this.lastAttackTarget.y,2.5+1.5*(1-o),0,Math.PI*2),e.fill();break}case"tank":{const l=5+4*(1-o);e.strokeStyle=`rgba(210, 120, 80, ${.7*o})`,e.lineWidth=2.5,e.beginPath(),e.arc(this.lastAttackTarget.x,this.lastAttackTarget.y,l,0,Math.PI*2),e.stroke(),e.globalAlpha=.3*o,e.fillStyle="#D87448",e.beginPath(),e.arc(this.lastAttackTarget.x,this.lastAttackTarget.y,l*.7,0,Math.PI*2),e.fill();break}case"priest":{const l=this.lastAttackTarget.clone().subtract(i);l.lengthSq()===0?l.set(1,0):l.normalize();const a=6+4*(1-o),c=i.clone().add(l.clone().scale(a));e.strokeStyle=`rgba(200, 170, 255, ${.75*o})`,e.lineWidth=2,e.beginPath(),e.moveTo(i.x,i.y),e.lineTo(c.x,c.y),e.stroke(),e.globalAlpha=.5*o,e.fillStyle="#E6D8FF",e.beginPath(),e.arc(i.x,i.y,2.6+1.2*(1-o),0,Math.PI*2),e.fill();break}}e.restore()}pickNewDirection(){const e=$[this.type];let t=Math.random()*Math.PI*2;if(this.allegiance==="wild"&&this.lairCenter){const s=this.lairCenter.clone().subtract(this.pos);if(s.lengthSq()>0){const n=Math.atan2(s.y,s.x),o=(Math.random()-.5)*Math.PI*.6;t=n+o}}const i=(e.minSpeed+Math.random()*(e.maxSpeed-e.minSpeed))*this.speedMultiplier;this.velocity.set(Math.cos(t)*i,Math.sin(t)*i),this.wanderTimer=Rt[0]+Math.random()*(Rt[1]-Rt[0])}steerTowards(e,t,i,s=V,n=!1){const o=e.clone().subtract(this.pos).normalize().scale(t),l=Math.min(1,s*i*(n?.65:1));if(this.velocity.lerp(o,l),n){const a=this.velocity.length();if(a>1e-4){const c=this.velocity.clone().normalize().scale(Math.max(a,t*.65));this.velocity.lerp(c,Math.min(1,.12*i))}}}updateIdle(e,t,i,s){if(this.allegiance==="wild"){this.updateWildIdle(e,i,s);return}const n=t.getWaveRallyPoint();if(n){const a=this.pos.distanceTo(n),c=18,h=i.maxSpeed*this.speedMultiplier,p=this.type==="tank"?V*.55:V*.7;if(a>c)this.steerTowards(n,h,s,p,!0);else{const u=Math.max(i.minSpeed,h*.45);this.steerTowards(n,u,s,V*.5),this.velocity.scale(Math.max(0,1-e*1.4))}return}const o=t.getHighestSuspicionAnchor();let l=!1;if(o){const a=this.pos.distanceTo(o.position),c=Math.max(4,o.suspicion*.6);if(a<=Jt||o.suspicion>=c){l=!0;const h=1+Math.min(.6,o.suspicion/ws),p=Math.min(i.maxSpeed,Math.max(i.minSpeed,i.minSpeed*h))*this.speedMultiplier,u=this.type==="tank"?V*.4:V*.5;this.steerTowards(o.position,p,s,u)}}l||(this.wanderTimer-=e,this.wanderTimer<=0&&this.pickNewDirection())}updateWildIdle(e,t,i){this.wanderTimer-=e,this.wanderTimer<=0&&this.pickNewDirection(),this.lairCenter&&this.pos.distanceTo(this.lairCenter)>this.lairRadius*.7&&this.steerTowards(this.lairCenter,t.maxSpeed*this.speedMultiplier,i,V*.4)}updateSearch(e,t,i,s,n,o){if(this.searchTimer=Math.max(0,this.searchTimer-e),this.searchTimer===0||!this.searchOrigin){this.behavior="idle";return}this.searchAngle+=to*e,this.searchRadius+=io*e;const l=this.searchOrigin.clone().add(new v(Math.cos(this.searchAngle),Math.sin(this.searchAngle)).scale(this.searchRadius)),a=n.isPointOnRoad(this.pos);a&&(this.roadAssistTimer=Math.max(this.roadAssistTimer,2)),this.steerTowards(l,i.maxSpeed*.9*this.speedMultiplier,s,V*.6,a||this.roadAssistTimer>0),o&&Math.random()<e*.6&&t.registerKnightSighting(l)}updateInvestigation(e,t,i){if(!this.investigationTarget){this.finishInvestigation();return}this.investigationTravelTimer+=e;const s=this.pos.distanceTo(this.investigationTarget);if(!this.investigationArrived)if(s<=da)this.investigationArrived=!0,this.investigationTravelTimer=0,this.investigationTimer=ei;else{if(this.investigationTravelTimer>ua){this.finishInvestigation();return}this.steerTowards(this.investigationTarget,t.maxSpeed*.95*this.speedMultiplier,i,V*.8);return}if(this.investigationTimer=Math.max(0,this.investigationTimer-e),this.investigationTimer===0){this.finishInvestigation();return}this.investigationOrbitAngle+=e*pa;const n=Math.sin(this.investigationOrbitAngle*1.7)*1.2,o=Math.max(3,this.investigationOrbitRadius+n),l=new v(Math.cos(this.investigationOrbitAngle),Math.sin(this.investigationOrbitAngle)).scale(o),a=this.investigationTarget.clone().add(l);this.steerTowards(a,t.maxSpeed*.7*this.speedMultiplier,i,V*.6)}beginSearch(e){this.behavior="searching";const t=e.getHighestSuspicionAnchor();t&&(this.searchOrigin=t.position.clone()),this.searchAngle=Math.random()*Math.PI*2,this.searchRadius=0,this.searchTimer=Ni}canTankPersist(e,t){return this.type==="tank"&&e<=t.detectionRadius+Cn}finishInvestigation(){this.behavior="idle",this.clearInvestigationState()}clearInvestigationState(){this.investigationTimer=0,this.investigationTarget=null,this.investigationArrived=!1,this.investigationTravelTimer=0,this.investigationOrbitAngle=0,this.investigationOrbitRadius=0}updateBuildingFocus(e,t,i){let s=this.buildingTargetId!=null?t.getBuildingById(this.buildingTargetId):null;if(this.buildingTargetId!=null&&!s&&this.clearBuildingTarget(),s){const n=s.position.distanceTo(this.pos),o=i.hasLineOfSight(this.pos,s.position);this.buildingFocusTimer=Math.max(0,this.buildingFocusTimer-e),(this.buildingFocusTimer<=0||!o||n>Ht+32||s.state!=="active"||s.hp<=0)&&(this.clearBuildingTarget(),s=null)}if(!s&&this.buildingRetargetCooldown<=0){let n=null,o=Ht+1;for(const l of t.getBuildings()){if(l.state!=="active"||l.type!=="watchtower"&&l.type!=="beacon")continue;const a=l.position.distanceTo(this.pos);a>Ht||a>=o||i.hasLineOfSight(this.pos,l.position)&&(o=a,n=l)}this.buildingRetargetCooldown=1,n&&Math.random()<oa&&(this.buildingTargetId=n.id,this.buildingFocusTimer=aa)}}getChaseTarget(e,t){if(this.buildingTargetId!=null){const i=t.getBuildingById(this.buildingTargetId);if(i&&i.state==="active"&&i.hp>0)return i.position.clone()}return e.pos.clone()}clearBuildingTarget(){this.buildingTargetId=null,this.buildingFocusTimer=0,this.buildingAttackTimer=0}getCollisionRadius(){return this.getHalfSize()}applyDot(e,t){e<=0||t<=0||this.dotEffects.push({dps:e,remaining:t})}applySlow(e,t){const i=Math.min(1,Math.max(0,e));this.speedMultiplier=Math.min(this.speedMultiplier,i),this.slowTimer=Math.max(this.slowTimer,t)}updateDetectionTint(e){const t=this.detecting?1:0,i=Math.min(1,Sn*e);this.detectionTint+=(t-this.detectionTint)*i,this.detectionTint=Math.max(0,Math.min(1,this.detectionTint))}updatePriestReveal(e,t,i,s,n){if(this.type!=="priest"){this.priestProximityTimer=0,this.priestRevealTimer=0;return}let o=!1;t<=_n?(this.priestProximityTimer=Math.min(Pi,this.priestProximityTimer+e),this.priestProximityTimer>=Pi&&(o=this.priestRevealTimer<=0,this.priestRevealTimer=Ai)):this.priestProximityTimer=Math.max(0,this.priestProximityTimer-e),this.priestRevealTimer>0&&(this.priestRevealTimer=Math.max(0,this.priestRevealTimer-e),n&&s.registerKnightReveal(i.pos,{escalateSuspicion:o}))}applyTankKnockback(e){const t=this.pos.clone().subtract(e.pos);t.lengthSq()===0&&t.set(Math.random()-.5,Math.random()-.5),t.normalize().scale(In),this.velocity.add(t)}getHalfSize(){return $[this.type].size/2}updateDotEffects(e){if(!this.dotEffects.length)return;let t=0;for(const i of this.dotEffects)i.remaining=Math.max(0,i.remaining-e),t+=i.dps*e;this.dotEffects=this.dotEffects.filter(i=>i.remaining>0),t>0&&this.takeDamage(t)}}class Ji{constructor(){d(this,"pos",Zs.clone());d(this,"velocity",new v);d(this,"target",this.pos.clone());d(this,"hp",oe);d(this,"swingTimer",0);d(this,"swingCooldown",0);d(this,"swingAngle",null);d(this,"swingHits",new Set);d(this,"lastSwingProgress",0);d(this,"castleTimer",0);d(this,"bowEquipped",!1);d(this,"bowCooldownTimer",0);d(this,"bowCooldownModifier",1);d(this,"bowRange",vn);d(this,"speedMultiplier",1);d(this,"temporarySpeedMultiplier",1);d(this,"meleeEquipped",!1);d(this,"meleeDamage",1)}setTarget(e){this.target.copy(e)}update(e,t){const i=e*ys,s=this.target.clone().subtract(this.pos),n=s.length();this.velocity.scale(Math.pow(gn,i));const o=Math.min(1,fn*i);if(n>Ii){const l=s.normalize().scale(Ci*this.speedMultiplier*this.temporarySpeedMultiplier);this.velocity.lerp(l,o)}else this.velocity.lerp(new v,o),this.velocity.lengthSq()<.01&&this.velocity.set(0,0);t.applyTerrainSteering(this,ce/2,e,{entityType:"knight"}),this.velocity.limit(Ci*this.speedMultiplier*this.temporarySpeedMultiplier),n<=Ii&&this.velocity.lengthSq()<.01&&this.velocity.set(0,0),this.pos.add(this.velocity.clone().scale(i)),t.resolveStaticCollisions(this.pos,ce/2,{entityType:"knight"}),t.constrainToArena(this,ce/2),this.swingTimer>0&&(this.swingTimer=Math.max(0,this.swingTimer-e),this.swingTimer===0&&(this.swingAngle=null,this.swingCooldown=Tn,this.lastSwingProgress=0,this.swingHits.clear())),this.swingCooldown>0&&(this.swingCooldown=Math.max(0,this.swingCooldown-e)),this.bowCooldownTimer>0&&(this.bowCooldownTimer=Math.max(0,this.bowCooldownTimer-e))}tryAttack(e){if(!this.meleeEquipped)return[];if(this.swingTimer>0)return this.collectHits(e);if(this.swingCooldown>0)return[];let t=null,i=Xe+1;for(const s of e){if(!s.alive)continue;const n=s.pos.distanceTo(this.pos);n<=Xe&&n<i&&(t=s,i=n)}return t?(this.swingAngle=Math.atan2(t.pos.y-this.pos.y,t.pos.x-this.pos.x),this.swingTimer=At,this.swingHits.clear(),this.lastSwingProgress=0,[]):[]}hasBowEquipped(){return this.bowEquipped}grantBow(){this.bowEquipped||(this.bowEquipped=!0,this.bowCooldownTimer=0)}addSpeedMultiplier(e){e<=0||(this.speedMultiplier*=e)}setTemporarySpeedMultiplier(e){if(!Number.isFinite(e)||e<=0){this.temporarySpeedMultiplier=1;return}this.temporarySpeedMultiplier=e}multiplyBowCooldown(e){if(e<=0)return;const t=Math.max(.2,e),i=this.bowCooldownModifier;if(this.bowCooldownModifier=Math.max(.1,this.bowCooldownModifier*t),this.bowCooldownTimer>0){const s=this.bowCooldownTimer/(Pt*i),n=Pt*this.bowCooldownModifier;this.bowCooldownTimer=Math.max(0,n*s)}}getBowRange(){return this.bowRange}tryShootBow(e){if(!this.bowEquipped||this.bowCooldownTimer>0||!e.alive)return null;const t=e.pos.clone().subtract(this.pos),i=t.length();if(i<=0||i>this.bowRange||t.lengthSq()===0)return null;t.normalize();const s=t.clone().scale(yn);return this.bowCooldownTimer=Pt*this.bowCooldownModifier,{position:this.pos.clone(),velocity:s,damage:bn}}draw(e){const i=ce*.45*1.12,s=ce*.22*1.12;e.save(),e.translate(this.pos.x,this.pos.y),e.shadowColor="rgba(250, 220, 120, 0.65)",e.shadowBlur=18*1.12,e.fillStyle="#1C1C24",e.beginPath(),e.arc(0,0,i*1.15,0,Math.PI*2),e.fill(),e.shadowBlur=0,e.fillStyle="#3A7BFA",e.beginPath(),e.moveTo(-i*.95,0),e.quadraticCurveTo(-i*.6,i*1.2,-i*.15,i*1.25),e.lineTo(i*.4,i*1.25),e.quadraticCurveTo(i*.95,i*.7,i*.85,-i*.1),e.closePath(),e.fill(),e.fillStyle="#6EA7FF",e.beginPath(),e.arc(0,0,i,0,Math.PI*2),e.fill(),e.lineWidth=3.6*1.12,e.strokeStyle="#F5F5F7",e.stroke(),e.fillStyle="#5E2B91",e.beginPath(),e.arc(-i*.2,-i*.1,i*.65,Math.PI*.2,Math.PI*1.05),e.lineTo(-i*.05,i*.85),e.closePath(),e.fill(),e.lineWidth=2.2*1.12,e.strokeStyle="#F7E36C",e.beginPath(),e.moveTo(-i*.55,-i*.05),e.lineTo(i*.65,-i*.05),e.stroke(),e.fillStyle="#F0F3FF",e.beginPath(),e.arc(0,-i*.95,s*1.05,0,Math.PI*2),e.fill(),e.strokeStyle="#4B5678",e.lineWidth=1.8*1.12,e.stroke(),e.fillStyle="#2B9B4B",e.beginPath(),e.moveTo(-i*.25,-i*.25),e.lineTo(i*.7,-i*.4),e.lineTo(i*.55,i*.45),e.closePath(),e.fill(),e.fillStyle="#F9C74F",e.beginPath(),e.arc(i*.45,-i*.2,i*.26,0,Math.PI*2),e.fill(),e.strokeStyle="#AA6400",e.lineWidth=1.6*1.12,e.stroke(),e.restore()}drawSwing(e){if(!this.meleeEquipped||this.swingTimer<=0||this.swingAngle==null)return;const t=Xe,i=Ei*Math.PI/360,s=this.swingAngle,n=s-i,o=s+i,l=Math.max(1e-4,At),a=1-this.swingTimer/l,c=Math.min(1,Math.max(0,a)),h=c*c*(3-2*c),p=n+(o-n)*h,u=t-4,f=.25+.55*(1-h),y=.15+.45*(1-h);e.save(),e.globalCompositeOperation="lighter";const w=3;for(let A=0;A<w;A++){const B=A*.12,W=Math.max(0,h-B);if(W<=0)continue;const ve=n+(o-n)*W,ye=Math.max(.2,1-A*.35);e.strokeStyle=`rgba(40, 230, 170, ${(.35+f*.9)*ye})`,e.lineWidth=6-A*1.6,e.lineCap="round",e.beginPath(),e.arc(this.pos.x,this.pos.y,u-A*1.8,n,ve,!1),e.stroke()}e.globalCompositeOperation="source-over",e.strokeStyle=`rgba(240, 255, 255, ${y})`,e.lineWidth=2.5,e.beginPath(),e.arc(this.pos.x,this.pos.y,t-1,Math.max(n,p-.22),p,!1),e.stroke(),e.fillStyle=`rgba(255, 255, 255, ${.45+.35*(1-h)})`,e.beginPath(),e.arc(this.pos.x+Math.cos(p)*(t-2),this.pos.y+Math.sin(p)*(t-2),2.8+1.2*(1-h),0,Math.PI*2),e.fill(),e.save(),e.translate(this.pos.x,this.pos.y),e.rotate(p);const b=8,S=1.6,C=5,I=t-6,E=3.4;e.fillStyle="#2E2E2E",e.fillRect(-C,-1.4,C,2.8),e.fillStyle="#B5B5B5",e.fillRect(-S/2,-b/2,S,b),e.fillStyle="#F1F1F1",e.fillRect(0,-E/2,I,E),e.strokeStyle=`rgba(255, 255, 255, ${.6+.3*(1-h)})`,e.lineWidth=.8,e.beginPath(),e.moveTo(0,-E*.25),e.lineTo(I-1.8,-E*.25),e.moveTo(0,E*.25),e.lineTo(I-1.8,E*.25),e.stroke(),e.fillStyle="#FFFFFF",e.beginPath(),e.moveTo(I,0),e.lineTo(I-4,E/2+.4),e.lineTo(I-4,-2.1),e.closePath(),e.fill(),e.restore(),e.restore()}collectHits(e){if(!this.meleeEquipped||this.swingAngle==null)return[];const t=[],i=Ei*Math.PI/360,s=Math.max(1e-4,At),n=1-this.swingTimer/s,o=Math.min(1,Math.max(0,n)),l=o*o*(3-2*o);for(const a of e){if(!a.alive||this.swingHits.has(a)||a.pos.distanceTo(this.pos)>Xe)continue;const c=a.pos.clone().subtract(this.pos);let h=0;if(c.lengthSq()!==0){const f=(Math.atan2(c.y,c.x)-this.swingAngle+Math.PI)%(Math.PI*2)-Math.PI;if(Math.abs(f)>i)continue;h=(f+i)/(2*i)}h<=this.lastSwingProgress||h>l||(t.push(a),this.swingHits.add(a))}return this.lastSwingProgress=Math.max(this.lastSwingProgress,l),t}equipMeleeWeapon(e=1){this.meleeEquipped=!0,this.meleeDamage=Math.max(.1,e)}hasMeleeWeapon(){return this.meleeEquipped}getMeleeDamage(e=1){if(!this.meleeEquipped)return 0;const t=this.meleeDamage*e;return Number.isFinite(t)&&t>0?t:0}}class es{constructor(e){d(this,"progress",0);d(this,"channeling",!1);this.pos=e}update(e,t){let i=!1;return e.distanceTo(this.pos)<=Zt?(this.channeling||(i=!0),this.channeling=!0,this.progress=Math.min(Je,this.progress+t)):(this.channeling=!1,this.progress<Je&&(this.progress=Math.max(0,this.progress-t*.5))),{completed:this.progress>=Je,started:i}}draw(e){if(e.fillStyle=An,e.fillRect(this.pos.x-5,this.pos.y-5,10,10),!this.channeling)return;const t=Math.min(1,this.progress/Je),i=-Math.PI/2,s=i+t*Math.PI*2,n=this.pos.y-Dn;e.save(),e.lineWidth=3,e.strokeStyle="rgba(255, 255, 255, 0.15)",e.beginPath(),e.arc(this.pos.x,n,Di,0,Math.PI*2),e.stroke(),e.strokeStyle=Rn,e.beginPath(),e.arc(this.pos.x,n,Di,i,s),e.stroke(),e.restore()}}const ga=1.8,ma=2.6,ts=.25;function va(r){return function(){let t=r+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}}function tt(r,e,t){return Math.max(e,Math.min(t,r))}class Ut{constructor(){d(this,"trees",[]);d(this,"villages",[]);d(this,"tavern",{position:en.clone(),radius:tn,interactRadius:sn});d(this,"huts",[]);d(this,"losSegments",[]);d(this,"canopyEnabled",!0);d(this,"buildingObstacles",[]);const e=va(1361292237);this.buildVillages(e),this.buildForests(e)}beginFrame(e){for(const t of this.losSegments)t.ttl=Math.max(0,t.ttl-e);for(let t=this.losSegments.length-1;t>=0;t--)this.losSegments[t].ttl<=0&&this.losSegments.splice(t,1)}setBuildingObstacles(e){this.buildingObstacles=e}update(e,t){this.updateVillages(e,t),this.updateChests(t)}toggleCanopy(){this.canopyEnabled=!this.canopyEnabled}isCanopyVisible(){return this.canopyEnabled}isAnyVillageAlarmed(){return this.villages.some(e=>e.alarmed)}getAlarmedVillage(){for(const e of this.villages)if(e.alarmed)return e;return null}getTrees(){return this.trees}getTavern(){return this.tavern}getVillages(){return this.villages}getHuts(){return this.huts}applyTerrainSteering(e,t,i,s){const n=(s==null?void 0:s.entityType)??"monster",o=new v;for(const a of this.trees){const c=this.computeTreePush(e.pos,a,t);c&&o.add(c)}const l=this.computeTreePush(e.pos,this.tavern,t);l&&o.add(l);for(const a of this.huts){const c=this.computeHutPush(e.pos,a,t);c&&o.add(c)}for(const a of this.buildingObstacles){if(!a.solid||n==="knight"&&!a.blocksKnight)continue;const c=this.computeRectPush(e.pos,a.center,a.halfWidth,a.halfHeight,t,a.steerStrength);c&&o.add(c)}if(o.lengthSq()>0){const a=Math.min(1.2,i*60)*.6;e.velocity.add(o.scale(a))}}resolveStaticCollisions(e,t,i){const s=(i==null?void 0:i.entityType)??"monster";for(const u of this.trees){const f=u.radius+t,y=e.clone().subtract(u.position),w=y.lengthSq();if(w===0){const b=Math.random()*Math.PI*2;e.add(new v(Math.cos(b),Math.sin(b)).scale(f*.2));continue}if(w<f*f){const b=Math.sqrt(w);y.scale(1/b);const S=f-b;e.add(y.scale(S+.1))}}const n=this.tavern.radius+t,o=e.clone().subtract(this.tavern.position),l=o.lengthSq();if(l===0){const u=Math.random()*Math.PI*2;e.add(new v(Math.cos(u),Math.sin(u)).scale(n*.2))}else if(l<n*n){const u=Math.sqrt(l);o.scale(1/u);const f=n-u;e.add(o.scale(f+.1))}for(const u of this.huts){const f=this.computeHutCorrection(e,u,t);f&&e.add(f)}for(const u of this.buildingObstacles){if(!u.solid||s==="knight"&&!u.blocksKnight)continue;const f=this.computeRectCorrection(e,u.center,u.halfWidth,u.halfHeight,t);f&&e.add(f)}const a=t,c=t,h=M-t,p=U-t;e.clamp(a,c,h,p)}constrainToArena(e,t,i){const{bounce:s=!1}=i??{},n=t,o=t,l=M-t,a=U-t;e.pos.x<n?(e.pos.x=n,s?e.velocity.x=Math.abs(e.velocity.x)*.7:e.velocity.x=0):e.pos.x>l&&(e.pos.x=l,s?e.velocity.x=-Math.abs(e.velocity.x)*.7:e.velocity.x=0),e.pos.y<o?(e.pos.y=o,s?e.velocity.y=Math.abs(e.velocity.y)*.7:e.velocity.y=0):e.pos.y>a&&(e.pos.y=a,s?e.velocity.y=-Math.abs(e.velocity.y)*.7:e.velocity.y=0)}hasLineOfSight(e,t){const i={from:e.clone(),to:t.clone(),blocked:!1,ttl:Go};for(const s of this.trees)if(this.intersectsCircle(e,t,s.position,s.radius)){i.blocked=!0;break}if(!i.blocked){for(const s of this.huts)if(this.intersectsRect(e,t,s)){i.blocked=!0;break}}if(!i.blocked){for(const s of this.buildingObstacles)if(s.blocksVision&&!this.isPointInsideAabb(e,s.center,s.halfWidth,s.halfHeight)&&this.intersectsAabb(e,t,s.center,s.halfWidth,s.halfHeight)){i.blocked=!0;break}}return this.losSegments.push(i),!i.blocked}raycastObstacles(e,t,i){if(i<=0)return 0;const s=Math.sqrt(t.x*t.x+t.y*t.y);if(s===0)return i;const n=t.x/s,o=t.y/s;let l=1/0;for(const a of this.trees){const c=this.raycastCircle(e,n,o,a.position,a.radius,i);c!==null&&c<l&&(l=c)}for(const a of this.huts){const c=this.raycastRect(e,n,o,a.center,a.width/2,a.height/2,i);c!==null&&c<l&&(l=c)}for(const a of this.buildingObstacles){if(!a.blocksVision)continue;const c=this.raycastRect(e,n,o,a.center,a.halfWidth,a.halfHeight,i,{skipIfInside:!0});c!==null&&c<l&&(l=c)}return Number.isFinite(l)?Math.min(l,i):i}getLosSegments(){return this.losSegments}isPointOnRoad(e){return!1}drawTerrain(e){this.drawTavern(e),this.drawHuts(e),this.drawChests(e),this.drawTrees(e),this.drawVillagers(e)}drawCanopy(e){}drawDebug(e){e.save(),e.strokeStyle=$n,e.lineWidth=1;for(const t of this.trees)e.beginPath(),e.arc(t.position.x,t.position.y,t.radius,0,Math.PI*2),e.stroke();e.strokeStyle=Kn;for(const t of this.huts){const i=t.width/2,s=t.height/2;e.strokeRect(t.center.x-i,t.center.y-s,t.width,t.height)}e.fillStyle="#FF5555";for(const t of this.villages)e.beginPath(),e.arc(t.center.x,t.center.y,3,0,Math.PI*2),e.fill();e.strokeStyle="rgba(255, 255, 255, 0.6)",e.lineWidth=1;for(const t of this.losSegments)e.beginPath(),e.moveTo(t.from.x,t.from.y),e.lineTo(t.to.x,t.to.y),e.strokeStyle=t.blocked?"rgba(255, 120, 120, 0.9)":"rgba(120, 200, 255, 0.8)",e.stroke();e.restore()}buildForests(e){const s=U/800,n=Math.max(1,Math.round((M-O*2)/140)),o=Math.max(1,Math.round((U-O*2)/70)),l=(M-O*2)/n,a=(U-O*2)/o,c=4.5,h=bs+35,p=Math.max(7,Math.round(7*s)),u=Array.from({length:p},()=>({center:new v(O+e()*(M-O*2),O+e()*(U-O*2)),radius:140+e()*90,strength:.6+e()*.35})),f=Math.max(4,Math.round(4*s)),y=Array.from({length:f},()=>({center:new v(O+e()*(M-O*2),O+e()*(U-O*2)),radius:160+e()*110,strength:.5+e()*.25})),w=(S,C,I=!1)=>{let E=0;for(const A of C){const B=S.distanceTo(A.center);if(B>=A.radius)continue;const W=1-B/A.radius;E+=W*A.strength*(I?-1:1)}return E};for(let S=0;S<o;S++)for(let C=0;C<n;C++){const I=O+l*(C+.5),E=O+a*(S+.5),A=new v(I,E);let B=e()*.26;B+=w(A,u),B+=w(A,y,!0),B=tt(B,0,1);let W=0;if(B>.08&&(W=1,B>.25&&W++,B>.45&&W++,B>.65&&W++,B>.82&&W++),W===0)continue;const ve=c*(1.05-B*.45);for(let ye=0;ye<W;ye++){let Le=14;for(;Le-- >0;){const je=new v((e()-.5)*l*.95,(e()-.5)*a*.95),z=A.clone().add(je);z.x=tt(z.x,O,M-O),z.y=tt(z.y,O,U-O);const xe=12+e()*8;if(this.canPlaceTree(z,xe,Math.max(2,ve),h)){this.trees.push({position:z,radius:xe});break}}}}const b=Math.round(n*o*1.4);for(let S=0;S<b;S++){const C=new v(O+e()*(M-O*2),O+e()*(U-O*2)),I=10+e()*8,E=c*.75;this.canPlaceTree(C,I,Math.max(2,E),h)&&this.trees.push({position:C,radius:I})}}canPlaceTree(e,t,i,s){if(e.distanceTo(N)<s+t)return!1;for(const n of this.villages){const o=n.canopyRadius+t+i;if(e.distanceTo(n.center)<o)return!1}for(const n of this.huts){const o=n.width/2+t+i,l=n.height/2+t+i;if(Math.abs(e.x-n.center.x)<=o&&Math.abs(e.y-n.center.y)<=l)return!1}for(const n of this.trees){const o=n.radius+t+i;if(e.distanceTo(n.position)<o)return!1}return!0}buildVillages(e){const t=[{center:new v(210,U*.65),hutOffsets:[new v(-26,-12),new v(22,-14),new v(-20,18),new v(28,20),new v(0,30)],chestOffsets:[new v(-8,0),new v(20,-32)],villagers:5},{center:new v(590,U*.425),hutOffsets:[new v(-28,-18),new v(24,-12),new v(-22,20),new v(18,24),new v(0,32)],chestOffsets:[new v(-18,6),new v(24,-24)],villagers:4},{center:new v(M-260,U*.86),hutOffsets:[new v(-30,-18),new v(26,-16),new v(-24,22),new v(24,28),new v(0,40),new v(-18,36)],chestOffsets:[new v(-22,10),new v(26,-28)],villagers:6}];for(const i of t){const s=[];for(const a of i.hutOffsets){const c=i.center.clone().add(a),h=18+e()*6,p=16+e()*6;s.push({center:c,width:h,height:p}),this.huts.push({center:c.clone(),width:h,height:p})}const n=i.chestOffsets.map(a=>({position:i.center.clone().add(a),opened:!1})),o=[];for(let a=0;a<i.villagers;a++){const c=s[a%s.length],h=new v((e()-.5)*10,(e()-.5)*10),p=c.center.clone().add(h);o.push({pos:p,home:c.center.clone(),state:"idle",timer:0,wanderTarget:null,wanderTimer:0,panicTarget:null,hp:Xn,alive:!0,hurtTimer:0})}const l={center:i.center.clone(),huts:s,chests:n,villagers:o,alarmed:!1,canopyRadius:Ft};this.villages.push(l)}}drawTavern(e){const{position:t,radius:i}=this.tavern;e.save(),e.fillStyle="rgba(0, 0, 0, 0.12)",e.beginPath(),e.arc(t.x,t.y+6,i+8,0,Math.PI*2),e.fill(),e.fillStyle=nn,e.strokeStyle=rn,e.lineWidth=3,e.beginPath(),e.arc(t.x,t.y,i,0,Math.PI*2),e.fill(),e.stroke(),e.fillStyle=on,e.beginPath(),e.moveTo(t.x-i*.9,t.y-i*.4),e.lineTo(t.x,t.y-i*1.1),e.lineTo(t.x+i*.9,t.y-i*.4),e.closePath(),e.fill(),e.stroke(),e.fillStyle=an;const s=i*.45,n=i*.8;e.fillRect(t.x-s/2,t.y+i*.1,s,n),e.fillStyle="#fef3c7";const o=i*.7,l=i*.28;e.fillRect(t.x-o/2,t.y-i*.05,o,l),e.fillStyle="#92400e",e.font="bold 12px Inter",e.textAlign="center",e.textBaseline="middle",e.fillText("🍻",t.x,t.y+l*.3),e.restore()}updateVillages(e,t){const i=t.knight.pos;for(const s of this.villages){const n=i.distanceTo(s.center)<=qo;let o=null,l=Number.POSITIVE_INFINITY;for(const c of t.monsters){if(!c.alive)continue;const h=c.pos.distanceTo(s.center);h<=Ho&&h<l&&(o=c,l=h)}let a=!1;for(const c of s.villagers){if(c.hurtTimer>0&&(c.hurtTimer=Math.max(0,c.hurtTimer-e)),!c.alive)continue;const h=c.state;o?(c.state="flee",c.timer=ma,c.panicTarget=o.pos.clone()):n?(c.state="alert",c.timer=ga,c.panicTarget=i.clone()):c.timer>0?(c.timer=Math.max(0,c.timer-e),c.timer===0&&(c.state="idle",c.panicTarget=null)):(c.state="idle",c.panicTarget=null),c.state==="flee"&&h!=="flee"&&t.emitNoise(c.pos,ho),c.state!=="idle"&&(a=!0),this.updateVillagerMovement(c,e,s,o,i)}s.alarmed=a}}updateChests(e){const t=e.knight.pos;for(const i of this.villages)for(const s of i.chests)!s.opened&&s.position.distanceTo(t)<=Uo&&(s.opened=!0,e.emitNoise(s.position,uo),e.onChestOpened(s.position))}updateVillagerMovement(e,t,i,s,n){if(!e.alive)return;const o=ks*t;switch(e.state){case"idle":this.updateIdleVillager(e,t,o);break;case"alert":{const h=i.center.clone().add(n.clone().subtract(i.center).scale(.25)).subtract(e.pos);h.lengthSq()>1&&(h.normalize().scale(o*.8),e.pos.add(h));break}case"flee":{const c=(s==null?void 0:s.pos)??e.panicTarget??n,h=e.pos.clone().subtract(c);h.lengthSq()===0&&h.set(Math.random()-.5,Math.random()-.5),h.normalize().scale(o*1.4),e.pos.add(h);break}}const l=e.pos.clone().subtract(i.center);l.length()>Ft-6&&(l.normalize().scale(Ft-6),e.pos.copy(i.center.clone().add(l))),this.resolveStaticCollisions(e.pos,3,{entityType:"villager"})}updateIdleVillager(e,t,i){if(e.wanderTimer-=t,!e.wanderTarget||e.wanderTimer<=0){const n=Math.random()*Math.PI*2,o=Math.random()*Wo;e.wanderTarget=e.home.clone().add(new v(Math.cos(n),Math.sin(n)).scale(o)),e.wanderTimer=1.2+Math.random()*1.5}const s=e.wanderTarget;if(s){const n=s.clone().subtract(e.pos);n.lengthSq()<9?e.wanderTarget=null:(n.normalize().scale(i*.5),e.pos.add(n))}}computeTreePush(e,t,i){const s=t.radius+i,n=e.clone().subtract(t.position),o=n.lengthSq();if(o===0)return new v((Math.random()-.5)*Bt,(Math.random()-.5)*Bt);if(o>=s*s)return null;const l=Math.sqrt(o),a=(s-l)/s;return n.scale(1/l).scale(a*Bt)}computeHutPush(e,t,i){return this.computeRectPush(e,t.center,t.width/2,t.height/2,i,Ss)}computeHutCorrection(e,t,i){return this.computeRectCorrection(e,t.center,t.width/2,t.height/2,i)}computeRectPush(e,t,i,s,n,o){const l=i+n,a=s+n,c=e.x-t.x,h=e.y-t.y;if(Math.abs(c)>l||Math.abs(h)>a)return null;const p=l-Math.abs(c),u=a-Math.abs(h);if(p<u){const y=c>=0?1:-1;return new v(y*(p/Math.max(1,n))*o,0)}const f=h>=0?1:-1;return new v(0,f*(u/Math.max(1,n))*o)}computeRectCorrection(e,t,i,s,n){const o=i+n,l=s+n,a=e.x-t.x,c=e.y-t.y;if(Math.abs(a)>o||Math.abs(c)>l)return null;const h=o-Math.abs(a),p=l-Math.abs(c);if(h<p){const f=a>=0?1:-1;return new v(f*h,0)}const u=c>=0?1:-1;return new v(0,u*p)}isPointInsideAabb(e,t,i,s){return e.x>=t.x-i&&e.x<=t.x+i&&e.y>=t.y-s&&e.y<=t.y+s}intersectsCircle(e,t,i,s){const n=i.clone().subtract(e),o=t.clone().subtract(e),l=o.lengthSq();if(l===0)return n.length()<=s;const a=tt((n.x*o.x+n.y*o.y)/l,0,1);return new v(e.x+o.x*a,e.y+o.y*a).distanceTo(i)<=s}intersectsRect(e,t,i){const s=i.width/2,n=i.height/2,o=i.center.x-s,l=i.center.x+s,a=i.center.y-n,c=i.center.y+n;let h=0,p=1;const u=t.x-e.x,f=t.y-e.y,y=[[-u,e.x-o],[u,l-e.x],[-f,e.y-a],[f,c-e.y]];for(const[w,b]of y){if(w===0){if(b<0)return!1;continue}const S=b/w;if(w<0){if(S>p)return!1;S>h&&(h=S)}else if(w>0){if(S<h)return!1;S<p&&(p=S)}}return!0}intersectsAabb(e,t,i,s,n){const o=i.x-s,l=i.x+s,a=i.y-n,c=i.y+n;let h=0,p=1;const u=t.x-e.x,f=t.y-e.y,y=[[-u,e.x-o],[u,l-e.x],[-f,e.y-a],[f,c-e.y]];for(const[w,b]of y){if(w===0){if(b<0)return!1;continue}const S=b/w;if(w<0){if(S>p)return!1;S>h&&(h=S)}else if(w>0){if(S<h)return!1;S<p&&(p=S)}}return!0}raycastCircle(e,t,i,s,n,o){const l=e.x-s.x,a=e.y-s.y,c=l*l+a*a-n*n;if(c<=0)return 0;const h=l*t+a*i,p=h*h-c;if(p<0)return null;const u=Math.sqrt(p),f=-h-u;if(f>=0&&f<=o)return f;const y=-h+u;return y>=0&&y<=o?y:null}raycastRect(e,t,i,s,n,o,l,a){const{skipIfInside:c=!1}=a??{},h=s.x-n,p=s.x+n,u=s.y-o,f=s.y+o;if(c&&e.x>=h&&e.x<=p&&e.y>=u&&e.y<=f)return null;let y=0,w=l;if(t!==0){const b=(h-e.x)/t,S=(p-e.x)/t,C=Math.min(b,S),I=Math.max(b,S);y=Math.max(y,C),w=Math.min(w,I)}else if(e.x<h||e.x>p)return null;if(i!==0){const b=(u-e.y)/i,S=(f-e.y)/i,C=Math.min(b,S),I=Math.max(b,S);y=Math.max(y,C),w=Math.min(w,I)}else if(e.y<u||e.y>f)return null;return w<0||y>w?null:y<0?w>=0&&w<=l?w:null:y<=l?y:null}drawHuts(e){e.save(),e.fillStyle=Vn;for(const t of this.huts)e.fillRect(t.center.x-t.width/2,t.center.y-t.height/2,t.width,t.height);e.restore()}drawChests(e){e.save();for(const t of this.villages)for(const i of t.chests)e.fillStyle=i.opened?zn:Qn,e.fillRect(i.position.x-3,i.position.y-3,6,6);e.restore()}drawTrees(e){e.save(),e.fillStyle=Gn;for(const t of this.trees)e.beginPath(),e.arc(t.position.x,t.position.y,t.radius*.6,0,Math.PI*2),e.fill();e.restore()}drawVillagers(e){e.save();for(const t of this.villages)for(const i of t.villagers)if(i.alive){switch(i.state){case"alert":e.fillStyle=xn;break;case"flee":e.fillStyle=Yn;break;default:e.fillStyle=jn;break}if(e.fillRect(i.pos.x-2,i.pos.y-2,4,4),i.hurtTimer>0){const s=Math.min(1,i.hurtTimer/ts);e.globalAlpha=.6*s,e.strokeStyle="#FF5C5C",e.lineWidth=1,e.strokeRect(i.pos.x-3,i.pos.y-3,6,6),e.globalAlpha=1}}e.restore()}findClosestVillager(e,t){let i=null,s=t*t;for(const n of this.villages)for(const o of n.villagers){if(!o.alive)continue;const l=o.pos.x-e.x,a=o.pos.y-e.y,c=l*l+a*a;c<=s&&(i=o,s=c)}return i}damageVillager(e,t){!e.alive||t<=0||(e.hp=Math.max(0,e.hp-t),e.hurtTimer=ts,e.hp===0&&(e.alive=!1,e.state="idle",e.timer=0,e.panicTarget=null,e.wanderTarget=null))}drawVillageAlarms(e){e.save(),e.fillStyle="rgba(255, 70, 70, 0.95)";for(const t of this.villages){if(!t.alarmed)continue;const i=t.center.y-t.canopyRadius-14;e.beginPath(),e.moveTo(t.center.x,i),e.lineTo(t.center.x-6,i+11),e.lineTo(t.center.x+6,i+11),e.closePath(),e.fill(),e.fillRect(t.center.x-1.5,i+11,3,4)}e.restore()}}const x={steelSword:{id:"steelSword",name:"Knightblade",description:"Tempered steel blade that keeps the knight lethal up close with wide melee sweeps and reliable crowd control.",role:"Melee core — anchors bruiser builds and rewards staying in the fray.",cost:0,icon:"🗡️",unique:!0,category:"weapon",buildPaths:["Pair with Ember Torch or barricades to create a burning front line.","Stack Hunter Jerky for heavy-hitting melee crits."]},scoutBoots:{id:"scoutBoots",name:"Scout Boots",description:"Supple leather boots that grant +15% stride speed and convert completed rescues into bonus evolution progress.",role:"Mobility support — rewards questing and map control playstyles.",cost:55,icon:"🥾",unique:!0,category:"support",buildPaths:["Rush ranged items like Throwing Knives or Crossbow Charm to kite efficiently.","Chain with Smoke Bomb Satchel for escape-heavy trap builds."]},hunterJerky:{id:"hunterJerky",name:"Hunter Jerky",description:"Smoked stag strips fortify resolve with +20% weapon damage and increased kill mastery gains.",role:"Damage support — accelerates offensive evolutions.",cost:60,icon:"🥩",unique:!0,category:"support",buildPaths:["Combine with Throwing Knives for rapid Poison Dagger unlocks.","Feed Ember Torch or Knightblade with extra burn damage."]},throwingKnife:{id:"throwingKnife",name:"Throwing Knife",description:"Launches an automatic flurry of daggers toward the nearest foe, shredding front lines from range.",role:"Ranged pressure — excels at thinning waves before they reach you.",cost:0,icon:"🔪",unique:!0,category:"weapon",evolveRequirement:{type:"kills",count:25,label:"Knife kills"},evolution:{name:"Poison Daggers",description:"Adds a third dagger, inflicts venom DoT, and increases spread for lane coverage."},buildPaths:["Pair with mobility from Scout Boots to kite while blades clean up.","Add Hunter Jerky to accelerate kill requirements and boost damage."]},torch:{id:"torch",name:"Ember Torch",description:"Three flames orbit the knight, burning anything that ventures into melee range.",role:"Zone control — locks down melee clusters around the hero.",cost:35,icon:"🔥",unique:!0,category:"weapon",evolveRequirement:{type:"rescues",count:3,label:"Village rescues"},evolution:{name:"Inferno Ring",description:"Expands the orbit, increases burn damage, and brands enemies with lingering fire."},buildPaths:["Layer with Knightblade for an aggressive melee bruiser setup.","Guard choke points with traps while flames mop up stragglers."]},crossbowCharm:{id:"crossbowCharm",name:"Crossbow Charm",description:"Summons an ethereal arbalest that stalks the nearest target with precise bolts.",role:"Precision ranged — excels at sniping elite threats before they reach your lines.",cost:70,icon:"🏹",unique:!0,category:"weapon",evolveRequirement:{type:"kills",count:35,label:"Charm kills"},evolution:{name:"Repeating Arbalest",description:"Fires twin piercing bolts and shortens the reload for relentless boss pressure."},buildPaths:["Anchor a pure ranged kit with Throwing Knives for crossfire coverage.","Combine with Smoke Bomb Satchel to slow enemies into its firing lane."]},smokeBombSatchel:{id:"smokeBombSatchel",name:"Smoke Bomb Satchel",description:"Deploys periodic smoke clouds that slow pursuers and break line of sight.",role:"Control & traps — manipulates patrols and protects objective play.",cost:45,icon:"💨",unique:!0,category:"weapon",evolveRequirement:{type:"rescues",count:4,label:"Rescued villagers"},evolution:{name:"Cloak Field Weave",description:"Creates larger, longer-lasting fields that grant brief invisibility and stronger slows."},buildPaths:["Layer traps with Spike structures for a denial-heavy defense.","Pair with ranged weapons so slowed enemies stay inside damage zones."]}},Ms=["throwingKnife","torch","crossbowCharm","smokeBombSatchel","scoutBoots","hunterJerky"],Cs=r=>{const e=x[r];if(!e||e.category!=="weapon")throw new Error(`Missing weapon definition for ${r}`);return e},gi={throwingKnife_unlock:{id:"throwingKnife_unlock",weaponId:"throwingKnife",name:"Armory Draft",description:"Unlock Throwing Knife as an alternate starter loadout in future runs.",cost:35,tier:1,prerequisites:[]},throwingKnife_toxins:{id:"throwingKnife_toxins",weaponId:"throwingKnife",name:"Nightshade Coating",description:"Evolved daggers inflict +30% poison damage and extend duration by 3s.",cost:55,tier:2,prerequisites:["throwingKnife_unlock"]},throwingKnife_masterwork:{id:"throwingKnife_masterwork",weaponId:"throwingKnife",name:"Masterwork Blades",description:"Base daggers pierce one extra target before evolving.",cost:80,tier:3,prerequisites:["throwingKnife_toxins"]},torch_unlock:{id:"torch_unlock",weaponId:"torch",name:"Citadel Forge",description:"Unlock Ember Torch as a guaranteed starter option.",cost:30,tier:1,prerequisites:[]},torch_pyrebloom:{id:"torch_pyrebloom",weaponId:"torch",name:"Pyrebloom Resin",description:"Evolved Inferno Ring ignites enemies for an additional burn stack.",cost:50,tier:2,prerequisites:["torch_unlock"]},torch_cinderstorm:{id:"torch_cinderstorm",weaponId:"torch",name:"Cinderstorm Patterns",description:"Base flames rotate 20% faster before evolving.",cost:75,tier:3,prerequisites:["torch_pyrebloom"]},crossbowCharm_unlock:{id:"crossbowCharm_unlock",weaponId:"crossbowCharm",name:"Ghostfletching",description:"Unlock Crossbow Charm for the starting arsenal.",cost:40,tier:1,prerequisites:[]},crossbowCharm_overdraw:{id:"crossbowCharm_overdraw",weaponId:"crossbowCharm",name:"Overdraw Winch",description:"Evolved Repeating Arbalest bolts deal +25% damage to elites.",cost:60,tier:2,prerequisites:["crossbowCharm_unlock"]},crossbowCharm_barbedBolts:{id:"crossbowCharm_barbedBolts",weaponId:"crossbowCharm",name:"Barbed Bolts",description:"Base charm attacks bleed for 12 damage over 4 seconds before evolving.",cost:85,tier:3,prerequisites:["crossbowCharm_overdraw"]},smokeBombSatchel_unlock:{id:"smokeBombSatchel_unlock",weaponId:"smokeBombSatchel",name:"Pocket Furnace",description:"Unlock Smoke Bomb Satchel as a starting gadget.",cost:32,tier:1,prerequisites:[]},smokeBombSatchel_catalyst:{id:"smokeBombSatchel_catalyst",weaponId:"smokeBombSatchel",name:"Catalyst Powder",description:"Evolved Cloak Field Weave slows enemies an additional 20%.",cost:58,tier:2,prerequisites:["smokeBombSatchel_unlock"]},smokeBombSatchel_midnightVeil:{id:"smokeBombSatchel_midnightVeil",weaponId:"smokeBombSatchel",name:"Midnight Veil Stitching",description:"Base smoke clouds grant 0.5s of invisibility before evolving.",cost:78,tier:3,prerequisites:["smokeBombSatchel_catalyst"]}},ze=["throwingKnife","torch","crossbowCharm","smokeBombSatchel"].map(r=>{const e=Cs(r),t=Object.values(gi).filter(i=>i.weaponId===r).sort((i,s)=>i.tier-s.tier);return{weaponId:r,overview:`${e.role} Invest Relic Shards to tailor ${e.name} for future runs.`,upgrades:t.map(i=>i.id)}});function ya(r){return Object.values(gi).filter(e=>e.weaponId===r).sort((e,t)=>e.tier-t.tier)}function pt(r){const e=gi[r];if(!e)throw new Error(`Unknown meta upgrade: ${r}`);return e}function Is(r){return Cs(r)}const Gt=96,ba=80,be=12;function we(r,e,t,i,s,n,o,l){return r<o&&t>s&&e<l&&i>n}function it(r,e,t,i,s,n,o){const l=Math.max(r,Math.min(s,t)),a=Math.max(e,Math.min(n,i)),c=s-l,h=n-a;return c*c+h*h<=o*o}class wa{constructor(){d(this,"knight",new Ji);d(this,"units",[]);d(this,"darkLord",new Zi);d(this,"seals",[]);d(this,"brokenSeals",0);d(this,"state","running");d(this,"world",new Ut);d(this,"anchors",[]);d(this,"nextAnchorIndex",0);d(this,"lastKnownKnightPos",null);d(this,"noisePings",[]);d(this,"debugOverlay",!1);d(this,"lastPointerTime",0);d(this,"lastPointerPos",null);d(this,"shieldWasActive",!0);d(this,"shieldFlashTimer",0);d(this,"supplies",0);d(this,"supplyTimer",0);d(this,"buildings",[]);d(this,"projectiles",[]);d(this,"knightProjectiles",[]);d(this,"darkProjectiles",[]);d(this,"buildMode",!1);d(this,"buildSelection","watchtower");d(this,"buildCursor",null);d(this,"buildErrorMessage",null);d(this,"buildErrorTimer",0);d(this,"dismantleState",null);d(this,"hasWorkshopTech",!1);d(this,"projectileIdCounter",1);d(this,"knightProjectileIdCounter",1);d(this,"darkProjectileIdCounter",1);d(this,"buildOrder",["watchtower","barricade","spike","beacon","workshop"]);d(this,"canvasHudEnabled",!0);d(this,"ownedItems",new Set);d(this,"weaponStates",new Map);d(this,"supportItems",new Set);d(this,"phase","downtime");d(this,"phaseTimer",Fe);d(this,"waveIndex",0);d(this,"quests",[]);d(this,"creepCamps",[]);d(this,"questGivers",[]);d(this,"questIdCounter",1);d(this,"creepCampIdCounter",1);d(this,"questGiverIdCounter",1);d(this,"questMarkers",[]);d(this,"questMarkerIdCounter",1);d(this,"questObjectiveIdCounter",1);d(this,"questEntityIdCounter",1);d(this,"temporaryBuffs",[]);d(this,"weaponDamageBonus",0);d(this,"temporarySpeedBonus",0);d(this,"relicShards",0);d(this,"unlockedMetaUpgrades",new Set);d(this,"weaponOrbitVisuals",[]);d(this,"smokeFields",[]);d(this,"smokeFieldIdCounter",1);d(this,"hitFlashes",[]);d(this,"damageNumbers",[]);d(this,"deathParticles",[]);d(this,"hitFlashIdCounter",1);d(this,"damageNumberIdCounter",1);d(this,"deathParticleIdCounter",1);d(this,"unitLookup",new Map);d(this,"unitIdCounter",1);d(this,"totalKills",0);d(this,"rescueCount",0);d(this,"killMasteryBonus",0);d(this,"rescueMasteryBonus",0);d(this,"waveRallyPoint",null);d(this,"knightInTavern",!1);d(this,"nearbyCreepCampIds",new Set);d(this,"noiseListener",null);this.world=new Ut,this.anchors=this._generateAnchors(),this.seals=this._generateSeals(),this.shieldWasActive=this._isShieldActive(),this.world.setBuildingObstacles([]),this._initializeQuestGivers(),this._initializeKnightLoadout(),this._enterDowntime()}reset(){this.knight=new Ji,this.units=[],this.darkLord=new Zi,this.seals=this._generateSeals(),this.brokenSeals=0,this.state="running",this.world=new Ut,this.anchors=this._generateAnchors(),this.nextAnchorIndex=0,this.lastKnownKnightPos=null,this.noisePings=[],this.lastPointerPos=null,this.lastPointerTime=0,this.debugOverlay=!1,this.supplies=0,this.supplyTimer=0,this.buildings=[],this.projectiles=[],this.darkProjectiles=[],this.buildMode=!1,this.buildSelection="watchtower",this.buildCursor=null,this.buildErrorMessage=null,this.buildErrorTimer=0,this.dismantleState=null,this.hasWorkshopTech=!1,this.projectileIdCounter=1,this.knightProjectileIdCounter=1,this.darkProjectileIdCounter=1,this._initializeQuestGivers(),this._initializeKnightLoadout(),this.shieldWasActive=this._isShieldActive(),this.shieldFlashTimer=0,this.world.setBuildingObstacles([]),this.weaponStates.clear(),this.supportItems.clear(),this.phase="downtime",this.phaseTimer=Fe,this.waveIndex=0,this.quests=[],this.creepCamps=[],this.questIdCounter=1,this.creepCampIdCounter=1,this.questMarkers=[],this.questMarkerIdCounter=1,this.questObjectiveIdCounter=1,this.questEntityIdCounter=1,this.temporaryBuffs=[],this.weaponDamageBonus=0,this.temporarySpeedBonus=0,this.relicShards=0,this.weaponOrbitVisuals=[],this.smokeFields=[],this.smokeFieldIdCounter=1,this.hitFlashes=[],this.damageNumbers=[],this.deathParticles=[],this.hitFlashIdCounter=1,this.damageNumberIdCounter=1,this.deathParticleIdCounter=1,this.unitLookup.clear(),this.unitIdCounter=1,this.totalKills=0,this.rescueCount=0,this.killMasteryBonus=0,this.rescueMasteryBonus=0,this.waveRallyPoint=null,this.knightInTavern=!1,this.nearbyCreepCampIds.clear(),this._enterDowntime()}setCanvasHudEnabled(e){this.canvasHudEnabled=e}getSupplies(){return this.supplies}getOwnedItems(){return Array.from(this.ownedItems)}getHeroLoadout(){const e=[];for(const t of this.ownedItems){const i=x[t];if(!i)continue;const s={id:t,name:i.name,icon:i.icon,description:i.description,status:"",evolved:!1,category:i.category};if(i.category==="weapon"){const n=this.weaponStates.get(t),o=i.evolveRequirement;if(o){const l=n?o.type==="kills"?n.kills:n.rescues:0,a=Math.min(Math.floor(l),o.count),c=!!n&&!n.evolved&&l>=o.count;s.progress={current:a,required:o.count,label:o.label,ready:c},s.evolved=!!(n!=null&&n.evolved),n!=null&&n.evolved?s.status="Evolved":c?s.status="Ready to evolve":s.status=`${a}/${o.count} ${o.label}`}else s.status=n!=null&&n.evolved?"Evolved":"Awakening",s.evolved=!!(n!=null&&n.evolved)}else s.status="Passive";e.push(s)}return e}isItemOwned(e){return this.ownedItems.has(e)}getQuests(){return this.quests}getQuestLogEntries(){const e=t=>`${t.reward.supplies} gold • ${t.reward.description}`;return this.quests.map(t=>{const i=this.questGivers.find(s=>s.id===t.giverId)??null;return{id:t.id,giverId:t.giverId,giverName:(i==null?void 0:i.name)??"Unknown Patron",villageName:(i==null?void 0:i.villageName)??"Unknown Village",description:t.description,icon:t.icon,progress:t.progress,requiredTime:t.requiredTime,state:t.state==="completed"?"completed":"active",rewardText:e(t)}})}getQuestGivers(){return this.questGivers.map(e=>{const{state:t,activeQuest:i}=this._resolveQuestGiverState(e),s=n=>`${n.reward.supplies} gold • ${n.reward.description}`;return{id:e.id,name:e.name,villageName:e.villageName,dialog:e.greeting,state:t,offer:e.questOffer?{description:e.questOffer.description,icon:e.questOffer.icon,rewardText:s(e.questOffer)}:null,activeQuest:i?{id:i.id,description:i.description,icon:i.icon,progress:i.progress,requiredTime:i.requiredTime,rewardText:s(i)}:null}})}getNearbyQuestInteraction(){if(!this.questGivers.length)return null;const e=a=>`${a.reward.supplies} gold • ${a.reward.description}`,t=[];for(const a of this.questGivers){const c=a.position.distanceTo(this.knight.pos);if(c>Gt)continue;const{state:h,activeQuest:p}=this._resolveQuestGiverState(a);t.push({giver:a,state:h,activeQuest:p,distance:c})}if(!t.length)return null;const i=a=>a.state==="turnIn"?0:a.state==="offering"?1:a.state==="active"?2:3;t.sort((a,c)=>{const h=i(a)-i(c);return h!==0?h:a.distance-c.distance});const{giver:s,state:n,activeQuest:o,distance:l}=t[0];return{giverId:s.id,giverName:s.name,villageName:s.villageName,greeting:s.greeting,state:n,offer:s.questOffer?{description:s.questOffer.description,icon:s.questOffer.icon,rewardText:e(s.questOffer)}:null,activeQuest:o?{id:o.id,description:o.description,icon:o.icon,progress:o.progress,requiredTime:o.requiredTime,rewardText:e(o)}:null,distance:l}}acceptQuestFromGiver(e){const t=this.questGivers.find(s=>s.id===e);if(!t||t.activeQuestId!=null||!t.questOffer)return!1;const i=t.questOffer;return i.state="active",i.progress=0,this._activateQuestObjectives(i),this._refreshQuestProgress(i),this.quests.push(i),t.activeQuestId=i.id,t.questOffer=null,!0}turnInQuestFromGiver(e){const t=this.questGivers.find(n=>n.id===e);if(!t||t.activeQuestId==null)return!1;const i=this.quests.findIndex(n=>n.id===t.activeQuestId);if(i<0)return t.activeQuestId=null,!1;const s=this.quests[i];return s.state!=="completed"?!1:(this._addSupplies(s.reward.supplies),s.reward.buff&&this._addTemporaryBuff(s.reward.buff),this.rescueCount+=1,this._recordRescueProgress(1+this.rescueMasteryBonus),this.quests.splice(i,1),t.activeQuestId=null,t.questOffer=this._createQuestForVillage(t.id,t.villageIndex),!0)}getCreepCamps(){return this.creepCamps}getNearbyCreepCampIds(){return Array.from(this.nearbyCreepCampIds)}getTemporaryBuffs(){return this.temporaryBuffs}getRelicShards(){return this.relicShards}getUnlockedMetaUpgrades(){return Array.from(this.unlockedMetaUpgrades)}isMetaUpgradeUnlocked(e){return this.unlockedMetaUpgrades.has(e)}canUnlockMetaUpgrade(e){if(this.unlockedMetaUpgrades.has(e))return!1;const t=pt(e);return this.relicShards<t.cost?!1:t.prerequisites.every(i=>this.unlockedMetaUpgrades.has(i))}unlockMetaUpgrade(e){if(!this.canUnlockMetaUpgrade(e))return!1;const t=pt(e);return this.relicShards-=t.cost,this.unlockedMetaUpgrades.add(e),!0}getPhaseTimerInfo(){const e=this.phase==="downtime"?Fe:Fi;return{phase:this.phase,remaining:this.phaseTimer,duration:e,waveIndex:this.waveIndex}}canPurchaseItem(e){const t=x[e];return!t||t.unique&&this.ownedItems.has(e)?!1:this.supplies>=t.cost}purchaseItem(e){const t=x[e];return!t||t.unique&&this.ownedItems.has(e)||this.supplies<t.cost?!1:(this.supplies-=t.cost,this._grantItem(e),!0)}getBuildOrder(){return this.buildOrder}getSelectedBlueprint(){return this.buildSelection}getSelectedBlueprintIndex(){return this.buildOrder.indexOf(this.buildSelection)}isBuildModeActive(){return this.buildMode}getBuildErrorMessage(){return this.buildErrorTimer>0?this.buildErrorMessage:null}setBuildMode(e){this.buildMode!==e&&(this.buildMode=e,this.buildMode?this.buildCursor=this.lastPointerPos?this.lastPointerPos.clone():null:this.buildCursor=null,this._clearBuildError())}canAffordBlueprint(e){return this._canAfford(e)}getPhase(){return this.phase}isDowntime(){return this.phase==="downtime"}isKnightAtTavern(){return this.knightInTavern}isWaveActive(){return this.phase==="wave"}getDarkEnergy(){return this.darkLord.evilEnergy}getUnitCount(){return this.units.filter(e=>e.allegiance==="dark"&&e.alive).length}getWaveIndex(){return this.waveIndex}getTotalKills(){return this.totalKills}getWaveRallyPoint(){return this.waveRallyPoint?this.waveRallyPoint.clone():null}canSpawnMoreUnits(){return this._countDarkUnits()<Xt}spawnUnit(e,t,i){const s=(i==null?void 0:i.allegiance)??"dark";if(s==="dark"&&(!(i!=null&&i.ignorePhase)&&!this.isWaveActive()||!this.canSpawnMoreUnits()))return null;const n=$[e].size/2,l=(s==="dark"?this.getCastleEdgePoint(t):t.clone()).clamp(n,n,M-n,G-n),a=new fa(l,e,this.unitIdCounter++,s,{allegiance:s,lairCenter:i==null?void 0:i.lairCenter,lairRadius:i==null?void 0:i.lairRadius});return this.units.push(a),this.unitLookup.set(a.id,a),a}getCastleEdgePoint(e){const t=e?e.clone().subtract(N):this._randomUnitVector();t.lengthSq()===0&&t.set(Math.random()-.5,Math.random()-.5),t.normalize();const i=(Math.random()-.5)*10,s=t.scale(Mn+i);return N.clone().add(s)}getNextAnchor(){this.anchors.length===0&&(this.anchors=this._generateAnchors(),this.nextAnchorIndex=0);const e=this.anchors[this.nextAnchorIndex%this.anchors.length];return this.nextAnchorIndex=(this.nextAnchorIndex+1)%this.anchors.length,e.position.clone()}registerKnightReveal(e,t){this.lastKnownKnightPos=e.clone(),((t==null?void 0:t.escalateSuspicion)??!0)&&this._increaseSuspicion(e,ws),this.darkLord.registerKnightReveal(e)}registerKnightSighting(e){this.lastKnownKnightPos=e.clone(),this._increaseSuspicion(e,Jn)}getLastKnownKnightPos(){return this.lastKnownKnightPos?this.lastKnownKnightPos.clone():null}getHighestSuspicionAnchor(){if(!this.anchors.length)return null;let e=this.anchors[0];for(let t=1;t<this.anchors.length;t++)this.anchors[t].suspicion>e.suspicion&&(e=this.anchors[t]);return e.suspicion<=.1?null:{position:e.position.clone(),suspicion:e.suspicion}}getNearestAnchorTo(e){this.anchors.length||(this.anchors=this._generateAnchors(),this.nextAnchorIndex=0);let t=this.anchors[0];const i=t.position.x-e.x,s=t.position.y-e.y;let n=i*i+s*s;for(let o=1;o<this.anchors.length;o++){const l=this.anchors[o].position.x-e.x,a=this.anchors[o].position.y-e.y,c=l*l+a*a;c<n&&(t=this.anchors[o],n=c)}return t.position.clone()}isAnySealChanneling(){return this.seals.some(e=>e.channeling)}getChannelingSeal(){return this.seals.find(e=>e.channeling)??null}isAnyVillageAlarmed(){return this.world.isAnyVillageAlarmed()}getAlarmedVillageCenter(){const e=this.world.getAlarmedVillage();return e?e.center.clone():null}getBuildings(){return this.buildings}getBuildingById(e){return this.buildings.find(t=>t.id===e)??null}getActiveWatchtowerCount(){return this.buildings.filter(e=>e.type==="watchtower"&&e.state==="active").length}hasActiveBeacon(){return this.buildings.some(e=>e.type==="beacon"&&e.state==="active")}getActiveBeacons(){return this.buildings.filter(e=>e.type==="beacon"&&e.state==="active")}damageBuilding(e,t){const i=this.getBuildingById(e);!i||t<=0||(i.hp=Math.max(0,i.hp-t))}onPointerDown(e,t,i,s){const n=new v(e,t);if(this.buildMode&&(this.buildCursor=n.clone()),this.state==="running"){if(this.buildMode){if(i===0){if(this._tryPlaceBuilding(n)){this.knight.setTarget(n.clone()),typeof s=="number"?this.lastPointerTime=s:this.lastPointerTime=0,this.lastPointerPos=n.clone();return}}else if(i===2){this._exitBuildMode();return}}if(i===2){this._exitBuildMode();return}i===0&&(typeof s=="number"&&this.lastPointerTime>0&&s-this.lastPointerTime<=oo&&this.lastPointerPos&&this.lastPointerPos.distanceTo(n)>35&&this._emitNoise(n,co),this.knight.setTarget(n.clone()),typeof s=="number"?(this.lastPointerTime=s,this.lastPointerPos=n.clone()):(this.lastPointerTime=0,this.lastPointerPos=n.clone()))}}onPointerMove(e,t){this.buildMode&&(this.buildCursor=new v(e,t))}toggleAnchorDebug(){this.debugOverlay=!this.debugOverlay}toggleBuildMode(){this.setBuildMode(!this.buildMode)}selectBlueprint(e){e<0||e>=this.buildOrder.length||(this.buildSelection=this.buildOrder[e])}cancelBuildPreview(){this.setBuildMode(!1)}startDismantle(){let e=null,t=Number.POSITIVE_INFINITY;for(const i of this.buildings){if(i.state!=="active")continue;const s=i.position.distanceTo(this.knight.pos);s<=ti&&s<t&&(e=i,t=s)}e&&(this.dismantleState={buildingId:e.id,progress:0},e.dismantleProgress=0)}_setBuildError(e){this.buildErrorMessage=e,this.buildErrorTimer=2.5}_clearBuildError(){this.buildErrorMessage=null,this.buildErrorTimer=0}_exitBuildMode(){this.setBuildMode(!1)}toggleCanopy(){this.world.toggleCanopy()}update(e){if(this.world.beginFrame(e),this.buildErrorTimer>0&&(this.buildErrorTimer=Math.max(0,this.buildErrorTimer-e),this.buildErrorTimer===0&&(this.buildErrorMessage=null)),this._syncWorldObstacles(),this.state!=="running"){this._updateHitFlashes(e),this._updateDeathParticles(e),this._updateDamageNumbers(e),this._updateShield(e),this.world.update(e,{knight:this.knight,monsters:this.units,emitNoise:(i,s)=>this.emitNoise(i,s),onChestOpened:i=>this._onChestOpened(i)}),this.knightInTavern=!1;return}this._updatePhase(e),this._updateSupplies(e),this.knight.update(e,this.world),this._updateTavernState(),this._applyTavernHealing(e),this._applyBarricadeSlowdown(),this._updateSeals(e),this._updateShield(e);for(const i of this.units)i.update(e,this.knight,this,this.world),i.tryAttack(this.knight,this.world,this,e);if(this._updateWeapons(e),this.units=this.units.filter(i=>i.alive),this._syncUnitLookup(),this._updateBuildings(e),this._updateDismantle(e),this._updateProjectiles(e),this._updateDarkProjectiles(e),this._updateKnightProjectiles(e),this._updateSmokeFields(e),this._updateHitFlashes(e),this._updateDeathParticles(e),this._updateDamageNumbers(e),this.world.update(e,{knight:this.knight,monsters:this.units,emitNoise:(i,s)=>this.emitNoise(i,s),onChestOpened:i=>this._onChestOpened(i)}),this.knight.hp<=0){this.state="defeat";return}const t=this.knight.tryAttack(this.units);if(t.length){const i=this.knight.getMeleeDamage(1+this.weaponDamageBonus);if(i>0){let s=0;for(const n of t){const o=n.alive,l=n.hp,a=n.receiveArcHit(this.knight,i),c=Math.max(0,l-n.hp);c>0&&(this._spawnHitFlash(n.pos,n.getCollisionRadius(),{strong:!n.alive}),this._spawnDamageNumber(n.pos,c,{emphasis:!n.alive})),o&&a&&(s+=1,this._onUnitKilled(n))}s>0&&this._emitNoise(this.knight.pos,ro),this.units=this.units.filter(n=>n.alive),this._syncUnitLookup()}}this.darkLord.update(e,this),this._updateAnchors(e),this._updateNoise(e),this._updateVictory(e)}draw(e,t){const{center:i,zoom:s,viewportWidth:n,viewportHeight:o}=t;e.save(),e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,n,o),e.restore(),e.save(),e.translate(n/2,o/2),e.scale(s,s),e.translate(-i.x,-i.y),e.fillStyle=Ln,e.fillRect(0,0,M,G),this.world.drawTerrain(e),this._drawShield(e),this._drawCastle(e),this._drawBuildings(e),this._drawTavernInteraction(e),this._drawCreepLairHighlights(e);for(const l of this.seals)l.draw(e);for(const l of this.units)l.draw(e);this._drawProjectiles(e),this._drawDarkProjectiles(e),this._drawKnightProjectiles(e),this._drawSmokeFields(e),this._drawWeaponOrbits(e),this.knight.draw(e),this.knight.drawSwing(e),this._drawDeathParticles(e),this._drawHitFlashes(e),this._drawDamageNumbers(e),this.world.drawCanopy(e),this.world.drawVillageAlarms(e),this._drawQuestObjectives(e),this._drawQuestMarkers(e),this._drawQuestGivers(e),this._drawNoisePings(e),this._drawBuildPreview(e),this.debugOverlay&&this._drawDebugOverlay(e),e.restore(),this._drawDirectionalIndicators(e,t),this.canvasHudEnabled&&this._drawHud(e),this.state==="victory"?this._drawOverlay(e,"VICTORY",Wn,"Press R to restart"):this.state==="defeat"&&this._drawOverlay(e,"DEFEAT",Un,"Press R to restart")}_enterDowntime(){this.phase="downtime",this.phaseTimer=Fe,this.weaponOrbitVisuals=[],this.smokeFields=[],this.waveRallyPoint=null,this.nearbyCreepCampIds.clear(),this._generateDowntimeActivities()}_startWave(){this.phase!=="wave"&&(this.phase="wave",this.phaseTimer=Fi,this.waveIndex+=1,this.creepCamps=[],this.nearbyCreepCampIds.clear(),this.weaponOrbitVisuals=[],this.smokeFields=[],this._expireTemporaryBuffs(),this._removeRemainingWildUnits(),this.waveRallyPoint=this._chooseWaveRallyPoint(),this.darkLord.beginWave(this,this.waveIndex))}_updatePhase(e){this.phase==="downtime"?(this.phaseTimer=Math.max(0,this.phaseTimer-e),this._updateQuests(e),this._updateCreepCamps(e),this.phaseTimer<=0&&this._startWave()):(this.phaseTimer=Math.max(0,this.phaseTimer-e),this.phaseTimer<=0&&this._countDarkUnits()===0&&this._enterDowntime())}_updateTavernState(){const e=this.world.getTavern();this.knightInTavern=this.knight.pos.distanceTo(e.position)<=e.interactRadius}_applyTavernHealing(e){if(!this.knightInTavern||this.phase!=="downtime"||this.knight.hp>=oe)return;const t=Math.max(0,ln*e);t<=0||(this.knight.hp=Math.min(oe,this.knight.hp+t))}_generateDowntimeActivities(){this._refreshQuestOffers(),this.creepCamps=this._createCreepCamps()}_createQuestForVillage(e,t){const i=Math.random()<.5?"escort":"retrieve",s=this.questIdCounter++,n=this._chooseQuestLocation(i,t),o=this._createQuestReward(i,s),l=i==="escort"?{type:"escort",spawnPoint:n.clone(),destination:N.clone(),npcCount:3,escortSpeed:ks}:{type:"retrieve",spawnPoint:n.clone()},a=l.type==="escort"?l.npcCount:1;return{id:s,giverId:e,type:i,position:n,radius:po,requiredTime:a,progress:0,state:"available",description:i==="escort"?"Escort the villagers safely back toward the sanctuary.":"Recover relic shards from the forest shrine before the next assault.",icon:i==="escort"?"🛡️":"🔮",reward:o,objectiveTemplate:l,objectives:[]}}_refreshQuestOffers(){if(this.questGivers.length)for(const e of this.questGivers)e.activeQuestId!=null&&((this.quests.find(i=>i.id===e.activeQuestId)??null)||(e.activeQuestId=null)),e.activeQuestId==null&&(e.questOffer||(e.questOffer=this._createQuestForVillage(e.id,e.villageIndex)))}_activateQuestObjectives(e){e.objectives=[];const t=e.objectiveTemplate;switch(t.type){case"escort":e.objectives.push(this._instantiateEscortObjective(e,t));break;case"retrieve":e.objectives.push(this._instantiateRetrieveObjective(e,t));break}}_instantiateEscortObjective(e,t){const i=this._createQuestMarker(t.spawnPoint,e.id,e.icon),s=[];for(let n=0;n<t.npcCount;n++){const o=n/Math.max(1,t.npcCount)*Math.PI*2,l=new v(Math.cos(o),Math.sin(o)).scale(12),a=t.spawnPoint.clone().add(l);s.push({id:this.questEntityIdCounter++,position:a,state:"waiting",speed:t.escortSpeed,arrivalRadius:24})}return{id:this.questObjectiveIdCounter++,questId:e.id,type:"escort",markerId:i,state:"pending",destination:t.destination.clone(),npcs:s,progress:0,required:s.length}}_instantiateRetrieveObjective(e,t){const i=this._createQuestMarker(t.spawnPoint,e.id,e.icon),s={id:this.questEntityIdCounter++,position:t.spawnPoint.clone(),pickedUp:!1};return{id:this.questObjectiveIdCounter++,questId:e.id,type:"retrieve",markerId:i,state:"pending",pickup:s,progress:0,required:1}}_createQuestMarker(e,t,i){const s={id:this.questMarkerIdCounter++,questId:t,icon:i,position:e.clone(),visible:!0};return this.questMarkers.push(s),s.id}_getQuestMarker(e){return e==null?null:this.questMarkers.find(t=>t.id===e)??null}_updateQuestMarkerPosition(e,t){const i=this._getQuestMarker(e);i&&i.position.copy(t)}_removeQuestMarker(e){if(e==null)return;const t=this.questMarkers.findIndex(i=>i.id===e);t>=0&&this.questMarkers.splice(t,1)}_refreshQuestProgress(e){if(!e.objectives.length){e.progress=0,e.requiredTime=1;return}let t=0,i=0;for(const s of e.objectives)t+=s.required,i+=s.progress;e.requiredTime=Math.max(1,t),e.progress=Math.min(i,e.requiredTime)}_cleanupQuestObjectives(e){if(e.objectives.length)for(const t of e.objectives)t.markerId!=null&&(this._removeQuestMarker(t.markerId),t.markerId=null)}_updateEscortObjective(e,t){let i=0,s=null;for(const n of e.npcs){if(n.state==="arrived"){i+=1;continue}if(s||(s=n.position),n.position.distanceTo(this.knight.pos)<=Gt&&(n.state="moving"),n.state==="moving"){const l=e.destination.clone().subtract(n.position),a=l.length();if(a<=n.arrivalRadius){n.position.copy(e.destination),n.state="arrived",i+=1;continue}if(a>0){l.normalize();const c=Math.min(a,n.speed*t);n.position.add(l.scale(c))}}}s&&e.markerId!=null&&this._updateQuestMarkerPosition(e.markerId,s),e.progress=i,e.required=Math.max(1,e.npcs.length),i>=e.npcs.length?(e.state="completed",e.markerId!=null&&(this._removeQuestMarker(e.markerId),e.markerId=null)):e.state="pending"}_updateRetrieveObjective(e){if(e.pickup.pickedUp){e.progress=e.required,e.state="completed",e.markerId!=null&&(this._removeQuestMarker(e.markerId),e.markerId=null);return}e.markerId!=null&&this._updateQuestMarkerPosition(e.markerId,e.pickup.position),e.pickup.position.distanceTo(this.knight.pos)<=Gt*.75?(e.pickup.pickedUp=!0,e.progress=e.required,e.state="completed",e.markerId!=null&&(this._removeQuestMarker(e.markerId),e.markerId=null)):(e.progress=0,e.state="pending")}_resolveQuestGiverState(e){const t=e.activeQuestId!=null?this.quests.find(i=>i.id===e.activeQuestId)??null:null;return t?{state:t.state==="completed"?"turnIn":"active",activeQuest:t}:{state:e.questOffer?"offering":"waiting",activeQuest:null}}_drawQuestObjectives(e){if(this.quests.length){e.save();for(const t of this.quests)if(t.state==="active"){for(const i of t.objectives)if(i.type==="escort")for(const s of i.npcs)e.globalAlpha=s.state==="arrived"?.5:.95,e.fillStyle=s.state==="arrived"?"rgba(252, 211, 77, 0.4)":"#fcd34d",e.strokeStyle="#b45309",e.lineWidth=1.5,e.beginPath(),e.arc(s.position.x,s.position.y,6,0,Math.PI*2),e.fill(),e.stroke();else if(i.type==="retrieve"){if(i.pickup.pickedUp)continue;e.globalAlpha=.9,e.fillStyle="#a855f7",e.strokeStyle="#6b21a8",e.lineWidth=1.5,e.beginPath();const{x:s,y:n}=i.pickup.position;e.moveTo(s,n-6),e.lineTo(s+6,n),e.lineTo(s,n+6),e.lineTo(s-6,n),e.closePath(),e.fill(),e.stroke()}}e.restore()}}_drawQuestMarkers(e){if(this.questMarkers.length){e.save(),e.font="16px Inter",e.textAlign="center",e.textBaseline="middle";for(const t of this.questMarkers){if(!t.visible)continue;e.globalAlpha=.95;const i=t.position.y-22;e.fillStyle="rgba(253, 224, 71, 0.9)",e.beginPath(),e.arc(t.position.x,i,11,0,Math.PI*2),e.fill(),e.strokeStyle="rgba(251, 191, 36, 0.95)",e.lineWidth=2,e.stroke(),e.fillStyle="#1f2937",e.fillText(t.icon,t.position.x,i),e.beginPath(),e.moveTo(t.position.x,i+11),e.lineTo(t.position.x,t.position.y-4),e.stroke()}e.restore()}}_drawQuestGivers(e){if(this.questGivers.length){e.save(),e.font="12px Inter",e.textAlign="center",e.textBaseline="middle";for(const t of this.questGivers){const{state:i}=this._resolveQuestGiverState(t);let s="#9ca3af";i==="offering"?s="#fbbf24":i==="active"?s="#60a5fa":i==="turnIn"&&(s="#34d399"),e.fillStyle=s,e.beginPath(),e.arc(t.position.x,t.position.y-18,6,0,Math.PI*2),e.fill(),e.fillStyle="#ffffff",e.fillText("📜",t.position.x,t.position.y-18)}e.restore()}}_drawTavernInteraction(e){if(!this.isDowntime())return;const t=this.world.getTavern();e.save(),e.strokeStyle="rgba(251, 191, 36, 0.65)",e.lineWidth=2,e.setLineDash([8,6]),e.beginPath(),e.arc(t.position.x,t.position.y,t.interactRadius,0,Math.PI*2),e.stroke(),this.knightInTavern&&(e.fillStyle="rgba(253, 230, 138, 0.25)",e.beginPath(),e.arc(t.position.x,t.position.y,t.interactRadius,0,Math.PI*2),e.fill()),e.setLineDash([]),e.restore()}_drawCreepLairHighlights(e){if(this.nearbyCreepCampIds.size){e.save(),e.lineWidth=2,e.setLineDash([6,8]),e.strokeStyle="rgba(252, 211, 77, 0.85)",e.fillStyle="rgba(252, 211, 77, 0.15)";for(const t of this.creepCamps)t.cleared||!this.nearbyCreepCampIds.has(t.id)||(e.beginPath(),e.arc(t.position.x,t.position.y,t.radius,0,Math.PI*2),e.fill(),e.stroke());e.setLineDash([]),e.restore()}}_chooseQuestLocation(e,t){if(e==="escort"){const i=this.world.getVillages();if(i.length)return i[t%i.length].center.clone()}if(e==="retrieve"){const i=this.world.getTrees();if(i.length)return i[Math.floor(Math.random()*i.length)].position.clone()}return this._randomEncounterPoint()}_createQuestReward(e,t){const i=this.waveIndex+wo;return e==="escort"?{supplies:qi,description:"Fleetfoot blessing: temporary speed boost.",buff:{id:`speed-${t}`,description:"Fleetfoot blessing (+speed until next wave)",speedBonus:go,expiresAtWave:i}}:{supplies:qi,description:"Radiant oil: weapons burn brighter.",buff:{id:`damage-${t}`,description:"Radiant oil (+weapon damage until next wave)",damageBonus:fo,expiresAtWave:i}}}_chooseWaveRallyPoint(){const e=this.world.getVillages();if(!e.length)return N.clone();const t=(this.waveIndex-1)%e.length;return e[t].center.clone()}_createCreepCamps(){const e=[];for(let t=0;t<mo;t++){const i=this.creepCampIdCounter++,s=this._randomEncounterPoint(),n=lt,o=Math.floor(Nt[0]+Math.random()*(Nt[1]-Nt[0]+1)),l=[];for(let a=0;a<o;a++){const c=Math.PI*2*a/Math.max(1,o),h=12+Math.random()*18,p=s.clone().add(new v(Math.cos(c)*h,Math.sin(c)*h)),u=Hi[Math.floor(Math.random()*Hi.length)],f=this.spawnUnit(u,p,{allegiance:"wild",ignorePhase:!0,lairCenter:s,lairRadius:n});f&&l.push(f.id)}e.push({id:i,position:s,radius:n,unitIds:l,cleared:!1,rewardSupplies:vo,rewardRelicShards:yo,name:`Roaming pack ${i}`})}return e}_removeRemainingWildUnits(){if(!this.units.length)return;const e=[];for(const t of this.units){if(t.allegiance!=="dark"){this.unitLookup.delete(t.id);continue}e.push(t)}this.units=e}_updateQuests(e){if(this.quests.length){for(const t of this.quests)if(t.state==="active"){for(const i of t.objectives)switch(i.type){case"escort":this._updateEscortObjective(i,e);break;case"retrieve":this._updateRetrieveObjective(i);break}this._refreshQuestProgress(t),t.objectives.length&&t.objectives.every(i=>i.state==="completed")&&this._completeQuest(t)}}}_completeQuest(e){if(e.state==="active"){e.state="completed";for(const t of e.objectives)t.state="completed",t.progress=t.required,t.markerId!=null&&(this._removeQuestMarker(t.markerId),t.markerId=null);this._refreshQuestProgress(e),this._cleanupQuestObjectives(e)}}_recordRescueProgress(e){for(const t of this.weaponStates.values())t.rescues+=e,this._checkWeaponEvolution(t)}_addTemporaryBuff(e){this.temporaryBuffs.push(e),e.damageBonus&&(this.weaponDamageBonus+=e.damageBonus),e.speedBonus&&(this.temporarySpeedBonus+=e.speedBonus),this._applyTemporarySpeedBonus()}_expireTemporaryBuffs(){if(!this.temporaryBuffs.length){this._applyTemporarySpeedBonus();return}let e=0,t=0;const i=[];for(const s of this.temporaryBuffs){if(s.expiresAtWave>this.waveIndex){i.push(s);continue}s.damageBonus&&(e+=s.damageBonus),s.speedBonus&&(t+=s.speedBonus)}this.temporaryBuffs=i,e!==0&&(this.weaponDamageBonus=Math.max(0,this.weaponDamageBonus-e)),t!==0&&(this.temporarySpeedBonus=Math.max(0,this.temporarySpeedBonus-t)),this._applyTemporarySpeedBonus()}_applyTemporarySpeedBonus(){this.knight.setTemporarySpeedMultiplier(1+this.temporarySpeedBonus)}_updateCreepCamps(e){if(!this.creepCamps.length){this.nearbyCreepCampIds.clear();return}this.nearbyCreepCampIds.clear();for(const t of this.creepCamps){if(t.cleared)continue;const i=[];for(const n of t.unitIds){const o=this.unitLookup.get(n);o&&o.alive&&i.push(n)}t.unitIds=i,t.position.distanceTo(this.knight.pos)<=t.radius+ba&&this.nearbyCreepCampIds.add(t.id),t.unitIds.length||this._completeCreepCamp(t)}}_completeCreepCamp(e){e.cleared||(e.cleared=!0,this._addSupplies(e.rewardSupplies),this.relicShards+=e.rewardRelicShards)}_updateWeapons(e){if(this.weaponStates.size){this.weaponOrbitVisuals=[];for(const t of this.weaponStates.values())switch(t.id){case"throwingKnife":this._updateThrowingKnife(t,e);break;case"torch":this._updateTorch(t,e);break;case"crossbowCharm":this._updateCrossbowCharm(t,e);break;case"smokeBombSatchel":this._updateSmokeSatchel(t,e);break}}}_updateThrowingKnife(e,t){e.cooldown=Math.max(0,e.cooldown-t);const i=e.evolved?Wi*.75:Wi;if(e.cooldown>0)return;const s=this._findNearestEnemy(Ui,{requireLineOfSight:!1});if(!s)return;const n=s.pos.clone().subtract(this.knight.pos);if(n.lengthSq()===0)return;n.normalize();const o=e.evolved?3:2,l=e.evolved?.25:.18;for(let a=0;a<o;a++){const c=(a-(o-1)/2)*l,p=this._rotateVector(n,c).scale(Ui*4.2),u=e.evolved?{dot:{dps:So,duration:ko}}:void 0;this._spawnKnightProjectile({position:this.knight.pos.clone(),velocity:p,damage:To,source:"throwingKnife",effects:u,tint:e.evolved?"#8ef3a0":"#facc15"})}e.cooldown=i}_updateTorch(e,t){const i=(typeof e.data.angle=="number"?e.data.angle:0)+t*Math.PI*.9;e.data.angle=i;const s=e.evolved?Io:_o,n=Mo,o=(typeof e.data.tickTimer=="number"?e.data.tickTimer:0)+t;e.data.tickTimer=o;for(let a=0;a<Gi;a++){const c=i+a/Gi*Math.PI*2,h=this.knight.pos.clone().add(new v(Math.cos(c)*s,Math.sin(c)*s));this.weaponOrbitVisuals.push({position:h,radius:8,alpha:e.evolved?.65:.4})}if(o<n)return;e.data.tickTimer=o-n;const l=Co*(1+this.weaponDamageBonus);for(const a of this.units)if(a.alive&&a.pos.distanceTo(this.knight.pos)<=s+a.getCollisionRadius()){const c=a.hp;a.takeDamage(l);const h=Math.max(0,c-a.hp);h>0&&(this._spawnHitFlash(a.pos,a.getCollisionRadius(),{strong:!a.alive}),this._spawnDamageNumber(a.pos,h,{emphasis:e.evolved||!a.alive,color:e.evolved?"#FFB86C":"#FFD37A"})),a.alive?e.evolved&&a.applyDot(Eo,n*2):this._onUnitKilled(a)}}_updateCrossbowCharm(e,t){e.cooldown=Math.max(0,e.cooldown-t);const i=e.evolved?Ro:Po;if(e.cooldown>0)return;const s=this._findNearestEnemy($i,{requireLineOfSight:!0});if(!s)return;const n=s.pos.clone().subtract(this.knight.pos);if(n.lengthSq()===0)return;n.normalize();const o=e.evolved?2:1,l=e.evolved?.12:0;for(let a=0;a<o;a++){const c=l*(a-(o-1)/2),p=this._rotateVector(n,c).scale($i*3.4);this._spawnKnightProjectile({position:this.knight.pos.clone(),velocity:p,damage:Ao,source:"crossbowCharm",pierce:e.evolved?Do:void 0,tint:e.evolved?"#c0f2ff":"#fde68a",target:s})}this._emitNoise(this.knight.pos,wn*.6),e.cooldown=i}_updateSmokeSatchel(e,t){e.cooldown=Math.max(0,e.cooldown-t);const i=e.evolved?Math.max(3,Vi-1.5):Vi;e.cooldown>0||(this.smokeFields.push({id:this.smokeFieldIdCounter++,position:this.knight.pos.clone(),radius:e.evolved?No:Lo,timer:e.evolved?Qi:Ki,slowFactor:e.evolved?Bo:Oo,cloakTimer:e.evolved?Fo:0,baseDuration:e.evolved?Qi:Ki}),e.cooldown=i)}_generateAnchors(){const e=[];for(let t=0;t<Li;t++){const i=t/Li*Math.PI*2,s=N.clone().add(new v(Math.cos(i)*Jt,Math.sin(i)*Jt));s.clamp(Ze,Ze,M-Ze,G-Ze),e.push({position:s,suspicion:0})}return e}_countDarkUnits(){let e=0;for(const t of this.units)t.allegiance==="dark"&&t.alive&&(e+=1);return e}_syncUnitLookup(){for(const[e,t]of this.unitLookup)t.alive||this.unitLookup.delete(e)}_randomEncounterPoint(){const t=this.world.getVillages();for(let i=0;i<20;i++){const s=new v(70+Math.random()*(M-140),70+Math.random()*(G-140));if(s.distanceTo(N)<120)continue;let n=!1;for(const o of t)if(s.distanceTo(o.center)<bo){n=!0;break}if(!n&&!(s.distanceTo(this.knight.pos)<80))return s}return new v(M/2,G/2)}_findNearestEnemy(e,t){const i=(t==null?void 0:t.requireLineOfSight)??!1;let s=null,n=e;for(const o of this.units){if(!o.alive)continue;const l=o.pos.distanceTo(this.knight.pos);l>e||l>=n||i&&!this.world.hasLineOfSight(this.knight.pos,o.pos)||(s=o,n=l)}return s}_rotateVector(e,t){if(t===0)return e.clone();const i=Math.cos(t),s=Math.sin(t);return new v(e.x*i-e.y*s,e.x*s+e.y*i)}_onUnitKilled(e){this._spawnDeathBurst(e),this.totalKills+=1;for(const t of this.weaponStates.values())t.kills+=1+this.killMasteryBonus,this._checkWeaponEvolution(t)}_checkWeaponEvolution(e){if(e.evolved)return;const t=x[e.id],i=t==null?void 0:t.evolveRequirement;if(!i)return;(i.type==="kills"&&e.kills>=i.count||i.type==="rescues"&&e.rescues>=i.count)&&(e.evolved=!0,e.cooldown=0)}_increaseSuspicion(e,t){if(!(!this.anchors.length||t<=0))for(const i of this.anchors){const s=1/(i.position.distanceTo(e)+1),n=i.suspicion+t*s;i.suspicion=Math.min(Ot,n)}}_updateAnchors(e){if(this.anchors.length)for(const t of this.anchors)t.suspicion=Math.max(0,t.suspicion-Zn*e)}_emitNoise(e,t){if(t<=0)return;const i=e.clone();this.noisePings.push({position:i.clone(),age:0,duration:so}),this._increaseSuspicion(i,t);for(const s of this.units)s.notifyNoise(i);this.noiseListener&&this.noiseListener(t)}emitNoise(e,t){this._emitNoise(e,t)}setNoiseListener(e){this.noiseListener=e??null}_updateNoise(e){if(this.noisePings.length){for(const t of this.noisePings)t.age+=e;this.noisePings=this.noisePings.filter(t=>t.age<t.duration)}}_drawNoisePings(e){if(this.noisePings.length){e.save(),e.strokeStyle="rgba(220, 80, 80, 0.6)",e.lineWidth=2;for(const t of this.noisePings){const i=Math.min(1,t.age/t.duration),s=Bi+(no-Bi)*i;e.globalAlpha=1-i,e.beginPath(),e.arc(t.position.x,t.position.y,s,0,Math.PI*2),e.stroke()}e.restore()}}_drawDebugOverlay(e){this.world.drawDebug(e),this._drawAnchorDebug(e)}_drawAnchorDebug(e){if(this.anchors.length){e.save();for(const t of this.anchors){e.globalAlpha=.8,e.fillStyle="#FF8080",e.beginPath(),e.arc(t.position.x,t.position.y,3,0,Math.PI*2),e.fill();const i=20,s=4,o=Math.min(Ot,t.suspicion)/Ot;e.globalAlpha=.3,e.fillStyle="#FF5E5E",e.fillRect(t.position.x+6,t.position.y-i/2,s,i),e.globalAlpha=.65,e.fillStyle="#FF3030",e.fillRect(t.position.x+6,t.position.y+i/2-i*o,s,i*o)}e.restore()}}_randomUnitVector(){const e=Math.random()*Math.PI*2;return new v(Math.cos(e),Math.sin(e))}_generateSeals(){const e=[],i=En,s=Math.max(i,Math.min(M,G)/2-80),n=Math.max(0,s-i);for(let o=0;e.length<le&&o<800;o++){const l=Math.random()*Math.PI*2,a=i+(n>0?Math.random()*n:0),c=N.clone().add(new v(Math.cos(l)*a,Math.sin(l)*a));e.some(h=>h.pos.distanceTo(c)<Pn)||e.push(new es(c))}if(e.length<le){const o=Math.max(i,i+n/2);for(let l=e.length;l<le;l++){const a=l/le*Math.PI*2,c=N.clone().add(new v(Math.cos(a)*o,Math.sin(a)*o));e.push(new es(c))}}return e}_updateSeals(e){for(let t=this.seals.length-1;t>=0;t--){const i=this.seals[t],{completed:s,started:n}=i.update(this.knight.pos,e);n&&this._emitNoise(i.pos,lo),i.channeling&&this._increaseSuspicion(i.pos,eo*e),s&&(this.seals.splice(t,1),this.brokenSeals+=1,this._addSupplies(Vo))}}_updateVictory(e){if(this.brokenSeals<le){this.knight.castleTimer=0;return}this.knight.pos.distanceTo(N)<=bs?(this.knight.castleTimer+=e,this.knight.castleTimer>=Js&&(this.state="victory")):this.knight.castleTimer=0}_updateShield(e){const t=this._isShieldActive();this.shieldWasActive&&!t&&(this.shieldFlashTimer=Mi),this.shieldWasActive=t,this.shieldFlashTimer>0&&(this.shieldFlashTimer=Math.max(0,this.shieldFlashTimer-e))}_isShieldActive(){return this.brokenSeals<le}_drawShield(e){const t=this._isShieldActive();if(!t&&this.shieldFlashTimer<=0)return;const i=cn;if(e.save(),e.beginPath(),e.arc(N.x,N.y,i,0,Math.PI*2),t){e.lineWidth=hn,e.strokeStyle=dn,e.stroke(),e.restore();return}const s=this.shieldFlashTimer/Mi,n=Math.max(0,Math.min(1,s));e.lineWidth=pn+4*n;const o=.25+.55*n,{r:l,g:a,b:c}=un;e.strokeStyle=`rgba(${l}, ${a}, ${c}, ${o.toFixed(2)})`,e.stroke(),e.restore()}_drawCastle(e){const t=(Math.sin(performance.now()/300)+1)*.5,i=Yt+t*4,s={r:Math.min(255,Lt.r+t*40),g:Math.min(255,Lt.g+t*40),b:Math.min(255,Lt.b+t*40)};e.fillStyle=`rgb(${s.r.toFixed(0)}, ${s.g.toFixed(0)}, ${s.b.toFixed(0)})`,e.fillRect(N.x-i/2,N.y-i/2,i,i)}_drawBuildings(e){for(const t of this.buildings){const{halfWidth:i,halfHeight:s}=ne(t.type),n=t.position.x-i,o=t.position.y-s;if(t.state==="foundation")e.save(),e.strokeStyle="rgba(180, 180, 220, 0.6)",e.setLineDash([3,3]),e.strokeRect(n,o,i*2,s*2),e.restore();else switch(t.type){case"watchtower":{e.fillStyle="#6D6D75",e.fillRect(n,o,i*2,s*2);const l=Math.sin(performance.now()/180)>0?"#FFFFFF":"#D0D0FF";e.fillStyle=l,e.fillRect(t.position.x-1,t.position.y-s-1,2,2),t.auraMultiplier>1&&(e.strokeStyle="rgba(120, 190, 255, 0.6)",e.lineWidth=1.5,e.beginPath(),e.arc(t.position.x,t.position.y,i+4,0,Math.PI*2),e.stroke());break}case"barricade":e.fillStyle="#8C5B32",e.fillRect(n,o,i*2,s*2);break;case"spike":e.fillStyle="#1E1E24",e.fillRect(n,o,i*2,s*2);break;case"beacon":{const l=.4+.3*(Math.sin(performance.now()/160)+1)*.5;e.fillStyle=`rgba(200, 220, 255, ${l.toFixed(2)})`,e.beginPath(),e.arc(t.position.x,t.position.y,i,0,Math.PI*2),e.fill();break}case"workshop":e.fillStyle="#3A3A42",e.fillRect(n,o,i*2,s*2),e.fillStyle="#555566",e.fillRect(t.position.x-2,t.position.y-2,4,4);break}if(t.state==="foundation"){const l=Math.max(0,Math.min(1,t.progress));l>0&&(e.save(),e.strokeStyle="rgba(200, 220, 255, 0.8)",e.lineWidth=2,e.beginPath(),e.arc(t.position.x,t.position.y,Math.max(i,s)+6,-Math.PI/2,-Math.PI/2+Math.PI*2*l),e.stroke(),e.restore())}else{const l=J(t.type);if(l.maxHp>1){const h=Math.max(0,Math.min(1,t.hp/l.maxHp)),p=t.position.x-18/2,u=o-6;e.fillStyle="rgba(20, 20, 20, 0.6)",e.fillRect(p,u,18,4),e.fillStyle="#5CD46C",e.fillRect(p,u,18*h,4),e.strokeStyle="rgba(255, 255, 255, 0.4)",e.strokeRect(p,u,18,4)}if(t.repairProgress>0){e.strokeStyle="rgba(110, 200, 255, 0.7)",e.lineWidth=2;const a=Math.max(i,s)+6;e.beginPath(),e.arc(t.position.x,t.position.y,a,-Math.PI/2,-Math.PI/2+Math.PI*2*Math.max(0,Math.min(1,t.repairProgress))),e.stroke()}if(t.dismantleProgress>0){e.strokeStyle="rgba(255, 120, 120, 0.8)",e.lineWidth=2;const a=Math.max(i,s)+8;e.beginPath(),e.arc(t.position.x,t.position.y,a,-Math.PI/2,-Math.PI/2+Math.PI*2*Math.max(0,Math.min(1,t.dismantleProgress))),e.stroke()}}}}_drawProjectiles(e){if(this.projectiles.length){e.fillStyle="#FFFFFF";for(const t of this.projectiles)e.beginPath(),e.arc(t.position.x,t.position.y,1.5,0,Math.PI*2),e.fill()}}_drawDarkProjectiles(e){if(this.darkProjectiles.length){e.save(),e.strokeStyle="rgba(200, 170, 255, 0.6)",e.lineWidth=1.5,e.lineCap="round",e.fillStyle="#d8c6ff";for(const t of this.darkProjectiles){const i=t.velocity.clone(),s=i.length();if(s>0){i.scale(1/s);const n=t.position.clone().subtract(i.clone().scale(t.radius*2.5));e.beginPath(),e.moveTo(t.position.x,t.position.y),e.lineTo(n.x,n.y),e.stroke()}e.beginPath(),e.arc(t.position.x,t.position.y,t.radius,0,Math.PI*2),e.fill()}e.restore()}}_drawBuildPreview(e){if(!this.buildMode||!this.buildCursor)return;const t=this.buildCursor,{halfWidth:i,halfHeight:s}=ne(this.buildSelection),n=this._evaluatePlacement(this.buildSelection,t),o=this._canAfford(this.buildSelection),l=o&&n.valid;e.save(),e.globalAlpha=.55;for(const a of n.tiles){const c=o&&a.valid;e.fillStyle=c?"rgba(120, 220, 140, 0.55)":"rgba(220, 100, 100, 0.6)",e.fillRect(a.left,a.top,a.width,a.height)}e.restore(),e.save(),e.strokeStyle=l?"rgba(120, 220, 140, 0.9)":"rgba(220, 100, 100, 0.9)",e.lineWidth=1.5,e.strokeRect(t.x-i,t.y-s,i*2,s*2),e.beginPath();for(const a of n.tiles)e.rect(a.left,a.top,a.width,a.height);e.strokeStyle=l?"rgba(120, 220, 140, 0.4)":"rgba(220, 100, 100, 0.4)",e.stroke(),e.strokeStyle=l?"rgba(120, 220, 140, 0.9)":"rgba(220, 100, 100, 0.9)",e.beginPath(),e.moveTo(t.x-8,t.y),e.lineTo(t.x+8,t.y),e.moveTo(t.x,t.y-8),e.lineTo(t.x,t.y+8),e.stroke(),e.restore()}_drawDirectionalIndicators(e,t){const i=[];for(const f of this.questMarkers)f.visible&&i.push({position:f.position,color:"rgba(251, 191, 36, 0.95)",icon:f.icon});for(const f of this.creepCamps)f.cleared||i.push({position:f.position,color:"rgba(96, 165, 250, 0.95)",icon:"⚔"});if(!i.length)return;const{center:s,zoom:n,viewportWidth:o,viewportHeight:l}=t,a=36,c=o/2-a,h=l/2-a,p=14,u=40;if(!(c<=0||h<=0)){e.save(),e.font="16px Inter",e.textAlign="center",e.textBaseline="middle";for(const f of i){const y=(f.position.x-s.x)*n,w=(f.position.y-s.y)*n;if(Math.abs(y)<=c&&Math.abs(w)<=h)continue;let b=1;if(Math.abs(y)>c&&(b=Math.min(b,c/Math.abs(y))),Math.abs(w)>h&&(b=Math.min(b,h/Math.abs(w))),!Number.isFinite(b)||b<=0)continue;const S=o/2+y*b,C=l/2+w*b,I=Math.atan2(w,y);e.save(),e.translate(S,C),e.rotate(I),e.globalAlpha=.95,e.fillStyle=f.color,e.beginPath(),e.moveTo(0,0),e.lineTo(-26,p/2),e.lineTo(-26,-p/2),e.closePath(),e.fill(),e.lineWidth=2,e.strokeStyle="rgba(17, 24, 39, 0.9)",e.stroke(),e.restore();const E=S-Math.cos(I)*u,A=C-Math.sin(I)*u;e.save(),e.globalAlpha=.92,e.fillStyle="rgba(17, 24, 39, 0.85)",e.beginPath(),e.arc(E,A,12,0,Math.PI*2),e.fill(),e.lineWidth=2,e.strokeStyle=f.color,e.stroke(),e.fillStyle="#f9fafb",e.fillText(f.icon,E,A+.5),e.restore()}e.restore()}}_drawHud(e){e.save();const t=12,i=12,s=Math.max(0,Math.min(1,this.knight.hp/oe));e.fillStyle=Fn,e.fillRect(t,i,Dt,et),s>0&&(e.fillStyle=Hn,e.fillRect(t,i,Dt*s,et)),e.lineWidth=2,e.strokeStyle=qn,e.strokeRect(t,i,Dt,et);const n=i+et+12;e.font="18px Consolas, monospace",e.fillStyle=Bn,e.textAlign="left",e.textBaseline="top";const o=`HP: ${this.knight.hp}  Evil: ${this.darkLord.evilEnergy}  Units: ${this.units.length}/${Xt}  Seals: ${this.brokenSeals}/${le}  Gold: ${this.supplies}`;e.fillText(o,t,n);const l="B=Build  [1]Tower(20) [2]Barr(12) [3]Spike(10) [4]Beacon(15) [5]Workshop(25)   X=Dismantle";e.font="14px Consolas, monospace",e.textAlign="center",e.textBaseline="bottom",e.fillText(l,e.canvas.width/2,e.canvas.height-12),e.restore()}_syncWorldObstacles(){const e=this.buildings.filter(t=>t.type!=="spike").map(t=>{const{halfWidth:i,halfHeight:s}=ne(t.type),n=t.type!=="barricade",o=t.type!=="beacon";return{center:t.position.clone(),halfWidth:i,halfHeight:s,steerStrength:Ss,solid:!0,blocksKnight:n,blocksVision:o,type:t.type}});this.world.setBuildingObstacles(e)}_initializeQuestGivers(){this.questGivers=[],this.questGiverIdCounter=1;const e=this.world.getVillages(),t=["Rowan","Elara","Thorne","Maris","Galen","Bryn"];for(let i=0;i<e.length;i++){const s=e[i],n=this.questGiverIdCounter++,o=`Elder ${t[i%t.length]}`,l=`Village ${i+1}`,a=`The people of ${l} look to you for aid.`,c=this._createQuestForVillage(n,i);this.questGivers.push({id:n,villageIndex:i,position:s.center.clone(),name:o,villageName:l,greeting:a,questOffer:c,activeQuestId:null})}}_initializeKnightLoadout(){this.ownedItems.clear(),this.weaponStates.clear(),this.supportItems.clear(),this.weaponDamageBonus=0,this.temporarySpeedBonus=0,this.killMasteryBonus=0,this.rescueMasteryBonus=0,this.knightProjectiles=[],this.knightProjectileIdCounter=1,this.knight.setTemporarySpeedMultiplier(1),this._grantItem("steelSword")}_grantItem(e){const t=x[e];t&&(t.unique&&this.ownedItems.has(e)||(this.ownedItems.add(e),t.category==="weapon"&&!this.weaponStates.has(e)&&this.weaponStates.set(e,{id:e,cooldown:0,evolved:!1,kills:0,rescues:0,data:{}}),t.category==="support"&&this.supportItems.add(e),this._applyItemEffect(e)))}_applyItemEffect(e){switch(e){case"steelSword":this.knight.equipMeleeWeapon();break;case"scoutBoots":this.knight.addSpeedMultiplier(mn),this.rescueMasteryBonus+=1;break;case"hunterJerky":this.weaponDamageBonus+=.2,this.killMasteryBonus+=.25;break}}_addSupplies(e){e<=0||(this.supplies+=e)}_updateSupplies(e){for(this.supplyTimer+=e;this.supplyTimer>=zi;)this.supplyTimer-=zi,this._addSupplies($o)}_onChestOpened(e){this._addSupplies(Ko)}_applyBarricadeSlowdown(){const e=ce/2;for(const t of this.buildings){if(t.type!=="barricade"||t.state!=="active")continue;const{halfWidth:i,halfHeight:s}=ne(t.type),n=Math.abs(this.knight.pos.x-t.position.x),o=Math.abs(this.knight.pos.y-t.position.y);if(n<=i+e&&o<=s+e){this.knight.velocity.scale(xo);break}}}_initializeBuilding(e){switch(e.type){case"watchtower":e.data.cooldown=xi;break;case"beacon":e.data.timer=0;break;case"spike":e.data.used=!1;break}}_onBuildingActivated(e){switch(e.type){case"watchtower":e.data.cooldown=0;break;case"beacon":e.data.timer=0;break;case"spike":e.data.used=!1;break}}_removeBuildingsById(e){e.size&&(this.buildings=this.buildings.filter(t=>!e.has(t.id)),this.dismantleState&&e.has(this.dismantleState.buildingId)&&(this.dismantleState=null),this.projectiles=this.projectiles.filter(t=>!e.has(t.sourceId)),this._syncWorldObstacles())}_updateBuildings(e){if(!this.buildings.length){this.hasWorkshopTech=!1;return}const t=new Set;for(const s of this.buildings){if(s.hp<=0){t.add(s.id);continue}const n=J(s.type);s.state==="foundation"?Wt(s,this.knight.pos)&&(s.progress=Math.min(1,s.progress+e/n.buildTime),s.progress>=1&&(s.state="active",s.progress=1,s.hp=n.maxHp,this._onBuildingActivated(s))):s.progress=Math.min(1,s.progress),(s.state!=="active"||s.hp>=n.maxHp)&&(s.repairProgress=0)}const i=this.buildings.filter(s=>!t.has(s.id)&&s.state==="active"&&s.type==="workshop");this.hasWorkshopTech=i.length>0;for(const s of this.buildings){if(t.has(s.id)||s.state!=="active")continue;const n=J(s.type);if(s.hp<n.maxHp&&this.hasWorkshopTech&&this.supplies>=qt&&Wt(s,this.knight.pos))for(s.repairProgress+=e/zo;s.repairProgress>=1&&this.supplies>=qt&&s.hp<n.maxHp;)s.repairProgress-=1,this.supplies-=qt,s.hp=Math.min(n.maxHp,s.hp+1);else s.repairProgress=0;switch(s.type){case"watchtower":this._updateWatchtower(s,e,i);break;case"beacon":this._updateBeacon(s,e);break;case"spike":this._updateSpike(s)&&t.add(s.id);break}}t.size>0&&this._removeBuildingsById(t),this.units=this.units.filter(s=>s.alive)}_updateDismantle(e){if(!this.dismantleState){for(const i of this.buildings)i.dismantleProgress=0;return}const t=this.buildings.find(i=>{var s;return i.id===((s=this.dismantleState)==null?void 0:s.buildingId)});for(const i of this.buildings)(!t||i.id!==t.id)&&(i.dismantleProgress=0);if(!t||t.state!=="active"){this.dismantleState=null;return}if(!Wt(t,this.knight.pos)){t.dismantleProgress=0,this.dismantleState=null;return}if(t.dismantleProgress+=e/jo,t.dismantleProgress>=1){const i=Math.floor(J(t.type).cost*.75);this._addSupplies(i),this._removeBuildingsById(new Set([t.id])),this.dismantleState=null}}_updateProjectiles(e){if(!this.projectiles.length)return;const t=[];for(const i of this.projectiles){if(!this.buildings.some(c=>c.id===i.sourceId))continue;const s=i.velocity.clone(),n=s.length();if(n<=0)continue;s.scale(1/n);const o=n*e;if(this.world.raycastObstacles(i.position,s,o)+.001<o)continue;i.position.add(s.clone().scale(o));const a=this._findProjectileHit(i);if(a){const c=a.alive,h=a.hp;a.takeDamage(i.damage);const p=Math.max(0,h-a.hp);p>0&&(this._spawnHitFlash(a.pos,a.getCollisionRadius(),{strong:!a.alive}),this._spawnDamageNumber(a.pos,p,{emphasis:!a.alive})),c&&!a.alive&&(this._onUnitKilled(a),this.units=this.units.filter(u=>u.alive));continue}i.position.x<0||i.position.x>M||i.position.y<0||i.position.y>G||t.push(i)}this.projectiles=t}_updateDarkProjectiles(e){if(!this.darkProjectiles.length)return;const t=[];for(const i of this.darkProjectiles){const s=i.velocity.clone(),n=s.length();if(n<=0)continue;const o=s.scale(1/n),l=i.maxDistance-i.travelled;if(l<=0)continue;const a=Math.min(n*e,l),c=this.world.raycastObstacles(i.position,o,a),h=Math.min(a,c);if(i.position.add(o.clone().scale(h)),i.travelled+=h,c+.001<a)continue;let p=!1;if(this.knight.hp>0){const u=ce/2;i.position.distanceTo(this.knight.pos)<=u+i.radius&&(this.knight.hp=Math.max(0,this.knight.hp-i.damage),p=!0)}if(!p){const u=this._findVillagerHit(i.position,i.radius);u&&(this.world.damageVillager(u,i.damage),p=!0)}p||i.position.x<0||i.position.x>M||i.position.y<0||i.position.y>G||i.travelled>=i.maxDistance-.001||t.push(i)}this.darkProjectiles=t}spawnDarkProjectile(e){const t=e.direction.clone();if(t.lengthSq()===0)return;t.normalize();const i=t.clone().scale(e.speed),s={id:this.darkProjectileIdCounter++,position:e.position.clone(),velocity:i,damage:e.damage,radius:e.radius??_s,travelled:0,maxDistance:e.maxDistance,sourceUnitId:e.sourceUnitId};this.darkProjectiles.push(s)}_spawnKnightProjectile(e){const t={id:this.knightProjectileIdCounter++,position:e.position.clone(),velocity:e.velocity.clone(),target:e.target??null,damage:e.damage*(1+this.weaponDamageBonus),source:e.source,pierce:e.pierce,effects:e.effects,tint:e.tint};this.knightProjectiles.push(t)}_applyProjectileHit(e,t){var o,l;const i=t.alive,s=t.hp;t.takeDamage(e.damage);const n=Math.max(0,s-t.hp);n>0&&(this._spawnHitFlash(t.pos,t.getCollisionRadius(),{strong:!t.alive}),this._spawnDamageNumber(t.pos,n,{emphasis:!t.alive||e.damage>=5,color:e.tint})),(o=e.effects)!=null&&o.dot&&t.applyDot(e.effects.dot.dps,e.effects.dot.duration),(l=e.effects)!=null&&l.slow&&t.applySlow(e.effects.slow.factor,e.effects.slow.duration),i&&!t.alive&&this._onUnitKilled(t)}_updateKnightProjectiles(e){if(!this.knightProjectiles.length)return;const t=[];for(const i of this.knightProjectiles){const s=i.velocity.clone(),n=s.length();if(n<=0)continue;s.scale(1/n);const o=n*e;if(this.world.raycastObstacles(i.position,s,o)+.001<o)continue;i.position.add(s.clone().scale(o));const a=i.target;let c=!1;if(a&&a.alive&&a.pos.distanceTo(i.position)<=a.getCollisionRadius()+2.5)this._applyProjectileHit(i,a),c=!0;else{const h=this._findKnightProjectileHit(i);h&&(this._applyProjectileHit(i,h),c=!0)}if(c){i.pierce&&i.pierce>0&&(i.pierce-=1,t.push(i));continue}i.position.x<0||i.position.x>M||i.position.y<0||i.position.y>G||t.push(i)}this.knightProjectiles=t}_findVillagerHit(e,t){const i=this.world.getVillages();for(const s of i)for(const n of s.villagers)if(n.alive&&n.pos.distanceTo(e)<=t+3)return n;return null}_findKnightProjectileHit(e){for(const i of this.units){if(!i.alive)continue;if(i.pos.distanceTo(e.position)<=i.getCollisionRadius()+2.5)return i}return null}_updateSmokeFields(e){if(!this.smokeFields.length)return;const t=[];for(const i of this.smokeFields){i.timer=Math.max(0,i.timer-e),i.cloakTimer=Math.max(0,i.cloakTimer-e);for(const s of this.units)s.alive&&s.pos.distanceTo(i.position)<=i.radius&&(s.applySlow(i.slowFactor,.6),i.cloakTimer>0&&(s.detecting=!1));i.timer>0&&t.push(i)}this.smokeFields=t}_drawKnightProjectiles(e){if(this.knightProjectiles.length){e.save(),e.strokeStyle="#facc15",e.lineWidth=2,e.lineCap="round",e.fillStyle="#fde68a";for(const t of this.knightProjectiles){const i=t.velocity.clone(),s=i.length();if(s<=0)continue;i.scale(1/s);const n=t.position.clone().subtract(i.clone().scale(6));e.beginPath(),e.moveTo(t.position.x,t.position.y),e.lineTo(n.x,n.y),e.stroke(),e.beginPath(),e.arc(t.position.x,t.position.y,2.2,0,Math.PI*2),e.fill()}e.restore()}}_drawSmokeFields(e){if(this.smokeFields.length){e.save();for(const t of this.smokeFields){const i=t.baseDuration>0?t.timer/t.baseDuration:0,s=Math.max(0,Math.min(.45,i*.45));e.fillStyle=`rgba(148, 163, 184, ${s.toFixed(2)})`,e.beginPath(),e.arc(t.position.x,t.position.y,t.radius,0,Math.PI*2),e.fill()}e.restore()}}_drawWeaponOrbits(e){if(this.weaponOrbitVisuals.length){e.save();for(const t of this.weaponOrbitVisuals)e.fillStyle=`rgba(252, 211, 77, ${t.alpha.toFixed(2)})`,e.beginPath(),e.arc(t.position.x,t.position.y,t.radius,0,Math.PI*2),e.fill();e.restore()}}_updateHitFlashes(e){if(this.hitFlashes.length){for(const t of this.hitFlashes)t.age+=e;this.hitFlashes=this.hitFlashes.filter(t=>t.age<t.duration)}}_updateDeathParticles(e){if(this.deathParticles.length){for(const t of this.deathParticles)t.age+=e,t.position.x+=t.velocity.x*e,t.position.y+=t.velocity.y*e,t.velocity.x*=.88,t.velocity.y=t.velocity.y*.88+120*e;this.deathParticles=this.deathParticles.filter(t=>t.age<t.lifetime)}}_updateDamageNumbers(e){if(this.damageNumbers.length){for(const t of this.damageNumbers)t.age+=e,t.position.x+=t.velocity.x*e,t.position.y+=t.velocity.y*e,t.velocity.x*=.92,t.velocity.y=t.velocity.y*.9+14*e;this.damageNumbers=this.damageNumbers.filter(t=>t.age<t.duration)}}_spawnHitFlash(e,t,i={}){const s=i.strong??!1,n={id:this.hitFlashIdCounter++,position:e.clone(),radius:Math.max(14,t*(s?1.5:1.2)),age:0,duration:s?.3:.2,strong:s};this.hitFlashes.push(n)}_spawnDeathBurst(e){const t=Ts[e.type],i=t?[t.accent,t.detail,"#FFECC6"]:["#FFECC6","#FFD4A1"],s=Math.max(10,e.getCollisionRadius()*1.8),n=9+Math.floor(Math.random()*5);for(let o=0;o<n;o++){const l=Math.random()*Math.PI*2,a=60+Math.random()*120,c=new v(Math.cos(l)*a,Math.sin(l)*a-30),h={id:this.deathParticleIdCounter++,position:e.pos.clone(),velocity:c,radius:s*(.25+Math.random()*.55),age:0,lifetime:.6+Math.random()*.35,color:i[Math.floor(Math.random()*i.length)]};this.deathParticles.push(h)}}_spawnDamageNumber(e,t,i={}){if(!Number.isFinite(t)||t<=0)return;const s=i.emphasis??t>=5,n=i.color??(s?"#FFE08A":"#F6E7C2"),o={id:this.damageNumberIdCounter++,position:e.clone(),velocity:new v((Math.random()-.5)*22,-46-Math.random()*14),text:this._formatDamage(t),amount:t,age:0,duration:s?.95:.75,color:n,emphasis:s};this.damageNumbers.push(o)}_drawHitFlashes(e){if(this.hitFlashes.length){e.save(),e.globalCompositeOperation="lighter";for(const t of this.hitFlashes){const i=t.duration>0?t.age/t.duration:1,s=Math.max(0,Math.min(1,i)),n=(t.strong?.7:.5)*(1-s);if(n<=0)continue;const o=t.radius*(.8+.3*s),l=e.createRadialGradient(t.position.x,t.position.y,Math.max(1,o*.15),t.position.x,t.position.y,o);l.addColorStop(0,`rgba(255, 255, 230, ${(n*1.1).toFixed(3)})`),l.addColorStop(.45,`rgba(255, 210, 140, ${(n*.7).toFixed(3)})`),l.addColorStop(1,"rgba(255, 140, 80, 0)"),e.fillStyle=l,e.beginPath(),e.arc(t.position.x,t.position.y,o,0,Math.PI*2),e.fill()}e.restore()}}_drawDeathParticles(e){if(this.deathParticles.length){e.save(),e.globalCompositeOperation="lighter";for(const t of this.deathParticles){const i=t.lifetime>0?t.age/t.lifetime:1,s=Math.max(0,Math.min(1,i)),n=(1-s)*.85;if(n<=0)continue;const o=t.radius*(.9+.4*(1-s)),l=e.createRadialGradient(t.position.x,t.position.y,Math.max(1,o*.2),t.position.x,t.position.y,o);l.addColorStop(0,`rgba(255, 255, 255, ${(n*.9).toFixed(3)})`),l.addColorStop(.5,this._withAlpha(t.color,n*.9)),l.addColorStop(1,"rgba(0, 0, 0, 0)"),e.fillStyle=l,e.beginPath(),e.arc(t.position.x,t.position.y,o,0,Math.PI*2),e.fill()}e.restore()}}_drawDamageNumbers(e){if(this.damageNumbers.length){e.save(),e.textAlign="center",e.textBaseline="middle";for(const t of this.damageNumbers){const i=t.duration>0?t.age/t.duration:1,s=Math.max(0,Math.min(1,i)),n=1-s;if(n<=0)continue;const o=t.emphasis?1.1+.2*(1-s):1+.12*(1-s);e.save(),e.translate(t.position.x,t.position.y),e.scale(o,o),e.globalAlpha=n,e.font=`${t.emphasis?"700":"600"} 12px "Inter", sans-serif`,e.strokeStyle="rgba(17, 24, 39, 0.55)",e.lineWidth=2.2/o,e.strokeText(t.text,0,0),e.fillStyle=t.color,e.fillText(t.text,0,0),e.restore()}e.restore()}}_withAlpha(e,t){const i=Math.max(0,Math.min(1,t));if(/^#([0-9a-f]{3}){1,2}$/i.test(e)){let s=e.slice(1);s.length===3&&(s=s.split("").map(a=>a+a).join(""));const n=parseInt(s.slice(0,2),16),o=parseInt(s.slice(2,4),16),l=parseInt(s.slice(4,6),16);return`rgba(${n}, ${o}, ${l}, ${i.toFixed(3)})`}return`rgba(255, 244, 220, ${i.toFixed(3)})`}_formatDamage(e){const t=Math.round(e);return Math.abs(e-t)<.01?`${t}`:e>=1?e.toFixed(1).replace(/\.0$/,""):e.toFixed(2).replace(/0+$/,"").replace(/\.$/,"")}_updateWatchtower(e,t,i){const s=i.some(c=>c.position.distanceTo(e.position)<=ea);e.auraMultiplier=s?Jo:1;const n=xi/e.auraMultiplier,o=typeof e.data.cooldown=="number"?e.data.cooldown:n,l=Math.max(0,o-t);if(e.data.cooldown=l,l>0)return;const a=this._findTowerTarget(e);a&&(this._fireWatchtower(e,a),e.data.cooldown=n)}_updateBeacon(e,t){let s=(typeof e.data.timer=="number"?e.data.timer:0)+t;for(;s>=Yi;)s-=Yi,this._emitNoise(e.position,ta);e.data.timer=s}_updateSpike(e){if(e.data.used)return!0;const{halfWidth:t,halfHeight:i}=ne("spike");for(const s of this.units){if(!s.alive)continue;const n=s.getCollisionRadius(),o=Math.abs(s.pos.x-e.position.x),l=Math.abs(s.pos.y-e.position.y);if(o<=t+n&&l<=i+n){const a=s.alive,c=s.hp,h=s.type==="scout"?s.hp:1;s.takeDamage(h),s.type==="tank"&&s.alive&&s.applySlow(ia,sa);const p=Math.max(0,c-s.hp);return p>0&&(this._spawnHitFlash(s.pos,s.getCollisionRadius(),{strong:!s.alive}),this._spawnDamageNumber(s.pos,p,{emphasis:!s.alive})),a&&!s.alive&&this._onUnitKilled(s),this.units=this.units.filter(u=>u.alive),e.data.used=!0,!0}}return!1}_findTowerTarget(e){let t=null,i=ji+1;for(const s of this.units){if(!s.alive)continue;const n=s.pos.distanceTo(e.position);n>ji||n>=i||this.world.hasLineOfSight(e.position,s.pos)&&(t=s,i=n)}return t}_fireWatchtower(e,t){const i=t.pos.clone().subtract(e.position);if(i.lengthSq()===0)return;i.normalize();const s=i.clone().scale(Xo),n={id:this.projectileIdCounter++,position:e.position.clone(),velocity:s,target:t,damage:Yo,sourceId:e.id};this.projectiles.push(n),this._emitNoise(e.position,Zo)}_findProjectileHit(e){for(const i of this.units){if(!i.alive)continue;if(i.pos.distanceTo(e.position)<=i.getCollisionRadius()+3)return i}return null}_canAfford(e){return this.supplies>=J(e).cost}_tryPlaceBuilding(e){const t=this.buildSelection;if(!this._canAfford(t))return this._setBuildError("Not enough supplies for this structure."),!1;const i=this._evaluatePlacement(t,e);if(!i.valid)return this._setBuildError(i.reason??"Cannot place that structure here."),!1;const s=ha(t,e);return this._initializeBuilding(s),this.buildings.push(s),this.supplies-=J(t).cost,this._syncWorldObstacles(),this._clearBuildError(),!0}_evaluatePlacement(e,t){const{halfWidth:i,halfHeight:s}=ne(e),n=i*2,o=s*2,l=t.x-i,a=t.y-s,c=Math.max(1,Math.ceil(n/be)),h=Math.max(1,Math.ceil(o/be)),p=[];for(let T=0;T<h;T++)for(let R=0;R<c;R++){const P=l+R*be,L=a+T*be,F=Math.min(be,l+n-P),X=Math.min(be,a+o-L);p.push({left:P,top:L,width:F,height:X,valid:!0})}let u=null,f=!0;const y=(T,R,P)=>{if(!T)return;if(f=!1,u||(u=R),!P){for(const F of p)F.valid=!1;return}let L=!1;for(const F of p)P(F)&&(F.valid=!1,L=!0);if(!L)for(const F of p)F.valid=!1},w=l,b=a,S=l+n,C=a+o,I=w<0||b<0||S>M||C>G;y(I,"Must build within the valley bounds.",T=>{const R=T.left+T.width,P=T.top+T.height;return T.left<0||T.top<0||R>M||P>G});const E=Yt/2+ti,A=N.x-E,B=N.y-E,W=N.x+E,ve=N.y+E,ye=we(w,b,S,C,A,B,W,ve);y(ye,"Too close to the castle grounds.",T=>{const R=T.left+T.width,P=T.top+T.height;return we(T.left,T.top,R,P,A,B,W,ve)});const Le=Math.max(i,s);for(const T of this.seals){const R=Zt+Le,P=T.pos.distanceTo(t)<=R;y(P,"Interferes with a seal ritual.",L=>{const F=L.left+L.width,X=L.top+L.height;return it(L.left,L.top,F,X,T.pos.x,T.pos.y,Zt)})}for(const T of this.world.getHuts()){const R=T.width/2,P=T.height/2,L=T.center.x-R,F=T.center.y-P,X=T.center.x+R,Ye=T.center.y+P,It=we(w,b,S,C,L,F,X,Ye);y(It,"Cannot block village huts.",te=>{const Et=te.left+te.width,ie=te.top+te.height;return we(te.left,te.top,Et,ie,L,F,X,Ye)})}const je=Le+6,z=[];for(const T of this.world.getTrees()){const R=it(w,b,S,C,T.position.x,T.position.y,T.radius);y(R,"Blocked by a tree.",P=>{const L=P.left+P.width,F=P.top+P.height;return it(P.left,P.top,L,F,T.position.x,T.position.y,T.radius)}),T.position.distanceTo(t)<=T.radius+je&&z.push({position:T.position.clone(),radius:T.radius})}z.length>=3&&y(!0,"Too many trees crowd this site.",T=>{const R=T.left+T.width,P=T.top+T.height;return z.some(L=>it(T.left,T.top,R,P,L.position.x,L.position.y,L.radius+je))});const xe=Le;for(const T of this.buildings){const R=ne(T.type),P=T.position.x-R.halfWidth,L=T.position.y-R.halfHeight,F=T.position.x+R.halfWidth,X=T.position.y+R.halfHeight,Ye=we(w,b,S,C,P,L,F,X);y(Ye,"Overlaps with another structure.",ie=>{const zs=ie.left+ie.width,js=ie.top+ie.height;return we(ie.left,ie.top,zs,js,P,L,F,X)});const It=t.distanceTo(T.position),te=Math.max(R.halfWidth,R.halfHeight),Et=It<xe+te+Qo;y(Et,"Needs more space from nearby structures.",()=>!0)}return{valid:f,reason:u,tiles:p}}_drawOverlay(e,t,i,s){const{width:n,height:o}=e.canvas;e.fillStyle="rgba(0, 0, 0, 0.65)",e.fillRect(0,0,n,o),e.fillStyle=i,e.font="48px Consolas, monospace",e.textAlign="center",e.textBaseline="middle",e.fillText(t,n/2,o/2-30),e.fillStyle="#FFFFFF",e.font="20px Consolas, monospace",e.fillText(s,n/2,o/2+20),e.textAlign="left",e.textBaseline="alphabetic"}}const Es={watchtower:{icon:"🏹",name:"Watchtower",description:"Ranged tower that fires at invaders. Gains range from workshop auras."},barricade:{icon:"🛡️",name:"Barricade",description:"Sturdy barrier that blocks foes and slows the knight when nearby."},spike:{icon:"✴️",name:"Spike Trap",description:"Single-use trap that harms and slows monsters that pass over it."},beacon:{icon:"📡",name:"Lure Beacon",description:"Broadcasts false sightings, drawing patrols away from the castle."},workshop:{icon:"⚙️",name:"Workshop",description:"Empowers structures in a large radius and unlocks advanced tech."}},is={movement:{title:"Movement Basics",body:"Left-click the ground to guide Rowan. Use the camera if you need to scout ahead.",icon:"🧭",keys:["Left Click"]},combat:{title:"Hold the Line",body:"During waves, stay mobile and kite patrols. Rowan swings at nearby foes automatically when they get close.",icon:"⚔️",keys:["Left Click"]},building:{title:"Raise Defenses",body:"Press B or tap the hammer button to open the Workshop. Choose a structure, then left-click to place it.",icon:"🏗️",keys:["B","Left Click"]},noise:{title:"Noise & Suspicion",body:"Attacks, sprinting, and some buildings create pulses that alert patrols. Watch the orange rings and reposition if things get loud.",icon:"🔊"},quests:{title:"Village Quests",body:"Approach quest givers to accept side objectives. Finish them during downtime for supplies and buffs.",icon:"📜"},healing:{title:"Catch Your Breath",body:"Rest inside the Emberwatch inn during downtime to slowly restore Rowan’s health before the next assault.",icon:"💖"},arsenal:{title:"Check the Inventory",body:"Press I during downtime to open your Inventory and review weapon evolutions.",icon:"⚔️",keys:["I"]}};class Ta{constructor(e,t={}){d(this,"completed",new Set);d(this,"queue",[]);d(this,"active",null);d(this,"activeElement",null);this.layer=e,this.options=t}request(e,t){this.completed.has(e)||this.queue.includes(e)||this.active===e||(t!=null&&t.priority?this.queue.unshift(e):this.queue.push(e),this.maybeShowNext())}complete(e){var t,i;return this.completed.has(e)?!1:(this.completed.add(e),this.queue=this.queue.filter(s=>s!==e),this.active===e&&this.removeActiveHint(),(i=(t=this.options).onComplete)==null||i.call(t,e),this.maybeShowNext(),!0)}isCompleted(e){return this.completed.has(e)}isQueued(e){return this.queue.includes(e)||this.active===e}maybeShowNext(){if(!this.active)for(;this.queue.length;){const e=this.queue.shift();if(!(!e||this.completed.has(e))){this.showHint(e);break}}}showHint(e){var f,y;const t=is[e],i=document.createElement("div");i.className="tutorial-hint-card",i.dataset.step=e,i.setAttribute("role","dialog"),i.setAttribute("aria-modal","true");const s=document.createElement("div");s.className="tutorial-hint-header";const n=document.createElement("div");n.className="tutorial-hint-icon",n.textContent=t.icon,n.setAttribute("aria-hidden","true");const o=document.createElement("h2");o.className="tutorial-hint-title",o.textContent=t.title;const l=`tutorial-${e}-title`;o.id=l,s.append(n,o);const a=document.createElement("p");a.className="tutorial-hint-body",a.textContent=t.body;const c=`tutorial-${e}-body`;if(a.id=c,i.setAttribute("aria-labelledby",l),i.setAttribute("aria-describedby",c),i.append(s,a),t.keys&&t.keys.length>0){const w=document.createElement("div");w.className="tutorial-hint-keys";for(const b of t.keys){const S=document.createElement("span");S.className="tutorial-hint-key",S.textContent=b,w.appendChild(S)}i.appendChild(w)}const h=document.createElement("div");h.className="tutorial-hint-actions";const p=document.createElement("button");p.type="button",p.className="tutorial-hint-skip",p.textContent="Skip Tutorial",p.addEventListener("click",()=>{this.skipAll()});const u=document.createElement("button");u.type="button",u.className="tutorial-hint-dismiss",u.textContent="Got it",u.addEventListener("click",()=>{this.complete(e)}),h.append(p,u),i.appendChild(h),this.layer.appendChild(i),this.active=e,this.activeElement=i,(y=(f=this.options).onPause)==null||y.call(f),u.focus()}removeActiveHint(){var e,t;this.activeElement&&this.activeElement.parentElement===this.layer&&this.layer.removeChild(this.activeElement),this.active=null,this.activeElement=null,(t=(e=this.options).onResume)==null||t.call(e)}skipAll(){Object.keys(is).forEach(e=>{this.completed.add(e)}),this.queue=[],this.removeActiveHint()}}const Sa=Ms.length+1,mi=1.6,Ps=.75,As=2.5,ka=240,_a=0,Rs=document.querySelector("#app");if(!Rs)throw new Error("Missing #app root element");const Ds=Rs;function g(r){const e=document.querySelector(r);if(!e)throw new Error(`Missing element: ${r}`);return e}Ds.innerHTML=`
  <div class="game-shell">
    <div class="game-container" id="gameContainer">
      <canvas id="gameCanvas" class="game-canvas"></canvas>
      <div class="camp-marker-layer" id="campMarkerLayer"></div>
      <div class="dark-energy ui-panel" id="darkEnergyClock">
        <div class="panel-heading">
          <h2>Dark Energy</h2>
          <button class="info-button" id="downtimeInfo" type="button" aria-label="Downtime timing help">?</button>
        </div>
        <div class="bar"><div class="bar-fill" id="darkEnergyFill"></div></div>
        <p id="darkEnergyText">Gathering energy…</p>
      </div>
      <div class="lore-banner ui-panel" id="loreBanner">
        <div class="lore-banner-header">
          <h2>Emberwatch Briefing</h2>
          <button class="lore-banner-dismiss" id="loreBannerDismiss" type="button" aria-label="Hide story intro">×</button>
        </div>
        <p>
          Sir Rowan, last knight of Emberwatch, holds the breach as waves of dark energy spill from the Hollow Vale.
        </p>
        <p>
          The tavern cellar shelters Mirella's roaming workshop—an artisan crew that brews supplies while you raise defenses for the night.
        </p>
      </div>
      <div class="hud">
        <div class="ui-panel stats-panel">
          <div class="stat-row">
            <span class="stat-label gold">Gold</span>
            <span class="stat-value" id="heroGoldText">0</span>
            <span class="resource-gain" id="heroGoldGain" aria-live="polite"></span>
          </div>
          <div class="stat-row">
            <span class="stat-label shards">Relic Shards</span>
            <span class="stat-value" id="heroShardText">0</span>
            <span class="resource-gain" id="heroShardGain" aria-live="polite"></span>
          </div>
          <div class="stat-row">
            <span class="stat-label health">Health</span>
            <div class="health-bar">
              <div class="health-bar-fill" id="heroHealthBar"></div>
            </div>
            <span class="health-text" id="heroHealthText">${oe}/${oe}</span>
          </div>
        </div>
        <div class="hud-info-buttons" role="group" aria-label="Gameplay tips">
          <button class="info-button" id="mapControlsInfo" type="button" aria-label="Map controls help">?</button>
          <button class="info-button" id="noiseInfo" type="button" aria-label="Noise and suspicion help">?</button>
        </div>
        <button class="ui-panel build-toggle" id="buildPrompt" type="button">
          <span class="build-toggle-icon" aria-hidden="true">🔨</span>
          <span class="build-toggle-text">(B)uild</span>
        </button>
        <div class="build-feedback" id="buildErrorMessage" role="status" aria-live="polite"></div>
        <div class="ui-panel inventory" id="inventoryPanel"></div>
        <div class="ui-panel buffs-panel" id="buffsPanel">
          <div class="buffs-title">Temporary Blessings</div>
          <ul class="buffs-list" id="buffList"></ul>
        </div>
      </div>
      <div class="shop-panel ui-panel hidden" id="buildingShopPanel">
        <h2>Workshop Ledger</h2>
        <div class="shop-items" id="shopItemsContainer"></div>
      </div>
      <div class="shop-panel ui-panel hidden" id="itemShopPanel">
        <h2>Hero Arsenal</h2>
        <div class="shop-items" id="itemShopItemsContainer"></div>
      </div>
      <div class="tooltip" id="tooltipPanel"></div>
      <div class="game-over hidden" id="gameOverScreen">
        <h2 id="gameOverTitle">You Have Perished</h2>
        <p id="gameOverSubtext">Press R to try again.</p>
      </div>
      <div class="quest-dialog hidden" id="questDialog" aria-hidden="true">
        <div class="quest-dialog-panel">
          <div class="quest-dialog-header">
            <div class="quest-dialog-icon" id="questDialogIcon" aria-hidden="true">📜</div>
            <div class="quest-dialog-titles">
              <div class="quest-dialog-title" id="questDialogTitle">Quest Offer</div>
              <div class="quest-dialog-subtitle" id="questDialogSubtitle"></div>
            </div>
            <button class="quest-dialog-close" id="questDialogClose" type="button" aria-label="Dismiss quest prompt">×</button>
          </div>
          <div class="quest-dialog-body">
            <p class="quest-dialog-greeting" id="questDialogGreeting"></p>
            <p class="quest-dialog-description" id="questDialogDescription"></p>
            <p class="quest-dialog-reward" id="questDialogReward"></p>
            <div class="quest-dialog-progress hidden" id="questDialogProgress">
              <div class="quest-dialog-progress-bar" id="questDialogProgressFill"></div>
            </div>
          </div>
          <div class="quest-dialog-actions" id="questDialogActions">
            <button class="quest-action-button" id="questDialogPrimary" type="button">Accept Quest</button>
            <button class="quest-action-button secondary" id="questDialogSecondary" type="button">Not now</button>
          </div>
        </div>
      </div>
      <div class="quest-log-overlay hidden" id="questLogOverlay" aria-hidden="true">
        <div class="quest-log-panel">
          <div class="quest-log-header">
            <h2>Quest Log</h2>
            <button class="quest-log-close" id="questLogClose" type="button" aria-label="Close quest log">×</button>
          </div>
          <p class="quest-log-subtitle">Active contracts from allied villages.</p>
          <ul class="quest-log-list" id="questLogList"></ul>
        </div>
      </div>
      <div class="inventory-overlay hidden" id="inventoryOverlay" aria-hidden="true">
        <div class="inventory-modal" role="dialog" aria-modal="true" aria-labelledby="inventoryOverlayTitle">
          <div class="inventory-modal-header">
            <div>
              <h2 class="inventory-modal-title" id="inventoryOverlayTitle">Hero Inventory</h2>
              <p class="inventory-modal-subtitle">Inspect your loadout and monitor evolution progress.</p>
            </div>
            <button class="inventory-modal-close" id="inventoryOverlayClose" type="button" aria-label="Close inventory">×</button>
          </div>
          <div class="inventory-modal-body">
            <div class="inventory-modal-list" id="inventoryOverlayList" role="list"></div>
            <aside class="inventory-preview hidden" id="inventoryOverlayPreview">
              <div class="inventory-preview-header">
                <div class="inventory-preview-icon" id="inventoryPreviewIcon" aria-hidden="true">🗡️</div>
                <div class="inventory-preview-titles">
                  <h3 class="inventory-preview-title" id="inventoryPreviewTitle">Loadout Item</h3>
                  <div class="inventory-preview-progress" id="inventoryPreviewProgress"></div>
                </div>
              </div>
              <p class="inventory-preview-description" id="inventoryPreviewDescription"></p>
              <div class="inventory-preview-evolution hidden" id="inventoryPreviewEvolution">
                <h4 class="inventory-preview-evolution-title">Evolution Preview</h4>
                <div class="inventory-preview-evolution-name" id="inventoryPreviewEvolutionName"></div>
                <p class="inventory-preview-evolution-description" id="inventoryPreviewEvolutionDescription"></p>
              </div>
            </aside>
          </div>
        </div>
      </div>
      <div class="meta-overlay hidden" id="metaProgressionOverlay" aria-hidden="true">
        <div class="meta-panel" role="dialog" aria-modal="true" aria-labelledby="metaOverlayTitle">
          <div class="meta-header">
            <div class="meta-header-titles">
              <h2 class="meta-overlay-title" id="metaOverlayTitle">Relic Forge</h2>
              <p class="meta-overlay-subtitle">Spend Relic Shards to unlock weapon upgrades for future runs.</p>
            </div>
            <div class="meta-header-actions">
              <div class="meta-shard-counter">Relic Shards: <span id="metaShardCount">0</span></div>
              <button class="meta-overlay-close" id="metaOverlayClose" type="button" aria-label="Close relic forge">×</button>
            </div>
          </div>
          <div class="meta-body">
            <div class="meta-weapon-grid" id="metaWeaponList" role="list"></div>
            <div class="meta-weapon-detail hidden" id="metaWeaponDetail">
              <button class="meta-back-button" id="metaWeaponBack" type="button">← Back to Arsenal</button>
              <div class="meta-weapon-detail-header">
                <div class="meta-weapon-detail-icon" id="metaWeaponDetailIcon" aria-hidden="true">🔪</div>
                <div class="meta-weapon-detail-titles">
                  <h3 class="meta-weapon-detail-title" id="metaWeaponDetailTitle">Weapon</h3>
                  <p class="meta-weapon-detail-overview" id="metaWeaponDetailOverview"></p>
                </div>
              </div>
              <div class="meta-upgrade-grid" id="metaUpgradeList"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="item-detail-overlay hidden" id="itemDetailOverlay" aria-hidden="true">
        <div class="item-detail-panel" role="dialog" aria-modal="true" aria-labelledby="itemDetailTitle">
          <button class="item-detail-close" id="itemDetailClose" type="button" aria-label="Close item details">×</button>
          <div class="item-detail-header">
            <div class="item-detail-icon" id="itemDetailIcon" aria-hidden="true">🔥</div>
            <div class="item-detail-titles">
              <h2 class="item-detail-title" id="itemDetailTitle">Item</h2>
              <div class="item-detail-role" id="itemDetailRole"></div>
            </div>
          </div>
          <div class="item-detail-meta" id="itemDetailMeta"></div>
          <p class="item-detail-description" id="itemDetailDescription"></p>
          <div class="item-detail-section hidden" id="itemDetailEvolutionSection">
            <h3 class="item-detail-section-title">Evolution</h3>
            <div class="item-detail-evolution-name" id="itemDetailEvolutionName"></div>
            <p class="item-detail-evolution-description" id="itemDetailEvolutionDescription"></p>
            <p class="item-detail-requirement" id="itemDetailRequirement"></p>
            <p class="item-detail-status" id="itemDetailStatus"></p>
          </div>
          <div class="item-detail-section hidden" id="itemDetailTipsSection">
            <h3 class="item-detail-section-title">Build Paths</h3>
            <ul class="item-detail-tip-list" id="itemDetailTips"></ul>
          </div>
        </div>
      </div>
      <div class="tutorial-hint-layer" id="tutorialHintLayer" aria-live="polite"></div>
    </div>
  </div>
`;const D=g("#gameCanvas");D.width=M;D.height=vs;const Ls=D.getContext("2d");if(!Ls)throw new Error("Unable to create canvas rendering context");const qe=g("#gameContainer");function vi(){const r=getComputedStyle(Ds),e=parseFloat(r.paddingLeft)+parseFloat(r.paddingRight),t=parseFloat(r.paddingTop)+parseFloat(r.paddingBottom),i=Math.max(0,window.innerWidth-e),s=Math.max(0,window.innerHeight-t-_a),n=M/vs;let o=i,l=o/n;if(l>s&&(l=s,o=l*n),!Number.isFinite(o)||!Number.isFinite(l)||o<=0||l<=0){qe.style.removeProperty("--game-width"),qe.style.removeProperty("--game-height");return}qe.style.setProperty("--game-width",`${o}px`),qe.style.setProperty("--game-height",`${l}px`)}window.addEventListener("resize",vi);window.addEventListener("orientationchange",vi);vi();const k={center:{x:M/2,y:G/2},zoom:mi};function kt(){const r=D.width/k.zoom/2,e=D.height/k.zoom/2,t=r,i=M-r;t>i?k.center.x=M/2:k.center.x=Math.max(t,Math.min(i,k.center.x));const s=e,n=G-e;s>n?k.center.y=G/2:k.center.y=Math.max(s,Math.min(n,k.center.y))}const H={up:!1,down:!1,left:!1,right:!1};function ss(r){let e=0,t=0;if(H.left&&(e-=1),H.right&&(e+=1),H.up&&(t-=1),H.down&&(t+=1),e===0&&t===0)return;const i=Math.hypot(e,t);i>0&&(e/=i,t/=i);const s=ka/k.zoom;k.center.x+=e*s*r,k.center.y+=t*s*r,kt()}kt();const m=new wa;m.setCanvasHudEnabled(!1);function ii(r){r&&typeof r.zoom=="number"&&(k.zoom=Math.max(Ps,Math.min(As,r.zoom)));const{x:e,y:t}=m.knight.pos;k.center.x=e,k.center.y=t,kt()}ii({zoom:mi});const ee=g("#tooltipPanel"),Ma=g("#inventoryPanel"),Ca=g("#heroGoldText"),he=g("#heroGoldGain"),Ia=g("#heroShardText"),de=g("#heroShardGain"),Ea=g("#heroHealthBar"),Pa=g("#heroHealthText"),q=g("#buildPrompt"),Oe=g("#buildErrorMessage"),Aa=g("#darkEnergyFill"),Ra=g("#darkEnergyText"),Da=g("#downtimeInfo"),$t=g("#buffList"),Os=g("#campMarkerLayer"),La=g("#buildingShopPanel"),ns=g("#shopItemsContainer"),Oa=g("#itemShopPanel"),os=g("#itemShopItemsContainer"),Na=g("#gameOverScreen"),st=g("#gameOverTitle"),as=g("#gameOverSubtext"),ft=g("#questLogOverlay"),Vt=g("#questLogList"),Ba=g("#questLogClose"),Me=g("#inventoryOverlay"),Ns=g("#inventoryOverlayClose"),ct=g("#inventoryOverlayList"),$e=g("#inventoryOverlayPreview"),Fa=g("#inventoryPreviewIcon"),qa=g("#inventoryPreviewTitle"),Ha=g("#inventoryPreviewDescription"),rs=g("#inventoryPreviewProgress"),nt=g("#inventoryPreviewEvolution"),ls=g("#inventoryPreviewEvolutionName"),cs=g("#inventoryPreviewEvolutionDescription"),Ce=g("#metaProgressionOverlay"),yi=g("#metaOverlayClose"),Wa=g("#metaShardCount"),ke=g("#metaWeaponList"),_t=g("#metaWeaponDetail"),Bs=g("#metaWeaponBack"),Ua=g("#metaWeaponDetailIcon"),Ga=g("#metaWeaponDetailTitle"),$a=g("#metaWeaponDetailOverview"),Ue=g("#metaUpgradeList"),Ie=g("#itemDetailOverlay"),Fs=g("#itemDetailClose"),Va=g("#itemDetailIcon"),Ka=g("#itemDetailTitle"),Qa=g("#itemDetailRole"),za=g("#itemDetailMeta"),ja=g("#itemDetailDescription"),hs=g("#itemDetailEvolutionSection"),xa=g("#itemDetailEvolutionName"),Ya=g("#itemDetailEvolutionDescription"),Te=g("#itemDetailRequirement"),Se=g("#itemDetailStatus"),ds=g("#itemDetailTipsSection"),us=g("#itemDetailTips"),_e=g("#questDialog"),Xa=g("#questDialogIcon"),Za=g("#questDialogTitle"),Ja=g("#questDialogSubtitle"),er=g("#questDialogGreeting"),Kt=g("#questDialogDescription"),Qt=g("#questDialogReward"),ps=g("#questDialogProgress"),fs=g("#questDialogProgressFill"),ht=g("#questDialogPrimary"),dt=g("#questDialogSecondary"),tr=g("#questDialogClose"),ir=g("#tutorialHintLayer"),gt=g("#loreBanner"),sr=g("#loreBannerDismiss"),nr=g("#mapControlsInfo"),or=g("#noiseInfo"),qs="bitdominion.loreBannerDismissed";function Hs(r){if(gt.classList.add("hidden"),gt.setAttribute("aria-hidden","true"),!!r)try{window.localStorage.setItem(qs,"true")}catch(e){console.warn("Unable to persist lore banner dismissal",e)}}function ar(){gt.classList.remove("hidden"),gt.setAttribute("aria-hidden","false")}let Ws=!1;try{Ws=window.localStorage.getItem(qs)==="true"}catch(r){console.warn("Unable to read lore banner dismissal state",r)}Ws?Hs(!1):ar();sr.addEventListener("click",()=>{Hs(!0)});let si=!1;const _=new Ta(ir,{onPause:()=>{si=!0},onResume:()=>{si=!1}});_.request("movement",{priority:!0});m.setNoiseListener(r=>{r>0&&_.isCompleted("building")&&!_.isCompleted("noise")&&!_.isQueued("noise")&&_.request("noise",{priority:!0})});let He=m.getSupplies(),ot=m.getRelicShards(),ni=0,oi=0,ai=m.getTotalKills(),ri=m.isKnightAtTavern();function bi(){ni=0,he.textContent="",he.classList.remove("resource-gain--active")}function rr(r){r<=0||(ni+=r,he.textContent=`+${ni}`,he.classList.remove("resource-gain--active"),he.offsetWidth,he.classList.add("resource-gain--active"))}he.addEventListener("animationend",bi);function Us(){oi=0,de.textContent="",de.classList.remove("resource-gain--active")}function lr(r){r<=0||(oi+=r,de.textContent=`+${oi}`,de.classList.remove("resource-gain--active"),de.offsetWidth,de.classList.add("resource-gain--active"))}de.addEventListener("animationend",Us);const li=[];for(let r=0;r<Sa;r++){const e=document.createElement("div");e.className="inventory-slot empty",Ma.appendChild(e),li.push(e)}const ci=new Map,hi=new Map,Ne=new Map,Mt=document.createElement("div");Mt.className="camp-marker-empty hidden";Mt.textContent="Scouts report no roaming packs.";Os.appendChild(Mt);const at=new Set,Be=new Map;function Ee(r,e){ee.innerHTML=`<div class="title">${r}</div><div>${e}</div>`,ee.style.display="block"}function Q(){ee.style.display="none"}function wi(r,e,t){const i=()=>Ee(e,t),s=()=>Q();r.addEventListener("mouseenter",i),r.addEventListener("mouseleave",s),r.addEventListener("focus",i),r.addEventListener("blur",s),r.addEventListener("click",i)}function di(r){const e=Math.max(0,r);if(e<10)return`${e.toFixed(1)}s`;const t=Math.floor(e/60),i=Math.floor(e%60);return t<=0?`${i}s`:`${t}:${i.toString().padStart(2,"0")}`}wi(nr,"Map Controls","Use WASD to pan the camera, scroll to zoom in or out, and press Space to snap back to Rowan.");wi(or,"Noise & Suspicion","Orange pulses mark noise that raises suspicion. Patrols will investigate loud spots, so reposition or lure them away.");wi(Da,"Downtime & Waves",`This meter counts the ${di(Fe)} downtime window. Build, heal, and gear up before it fills and the next wave begins.`);document.addEventListener("pointermove",r=>{if(ee.style.display==="none")return;const e=r.clientX+16,t=r.clientY+18;ee.style.left=`${e}px`,ee.style.top=`${t}px`;const i=ee.getBoundingClientRect(),s=8;let n=e,o=t;n+i.width>window.innerWidth-s?n=Math.max(s,window.innerWidth-i.width-s):n<s&&(n=s),o+i.height>window.innerHeight-s&&(o=r.clientY-i.height-12),o<s&&(o=s),ee.style.left=`${n}px`,ee.style.top=`${o}px`});let mt=null;function Ti(){mt&&(mt=null,Ie.classList.add("hidden"),Ie.setAttribute("aria-hidden","true"))}function vt(r,e){const t=x[r];if(!t)return;Q(),mt=r;const i=t.cost>0?`${t.cost} Gold`:"Starting gear",s=t.category==="weapon"?"Weapon":"Support";if(Va.textContent=t.icon,Ka.textContent=t.name,Qa.textContent=t.role,za.textContent=`${s} • Cost: ${i}`,ja.textContent=t.description,t.evolution){hs.classList.remove("hidden"),xa.textContent=t.evolution.name,Ya.textContent=t.evolution.description;const n=t.evolveRequirement;if(n?(Te.textContent=`Requirement: ${n.count} ${n.label}`,Te.classList.remove("hidden")):(Te.textContent="",Te.classList.add("hidden")),e!=null&&e.progressText){const o=e.evolved?"Status":"Progress";Se.textContent=`${o}: ${e.progressText}`,Se.classList.remove("hidden")}else Se.textContent="",Se.classList.add("hidden")}else hs.classList.add("hidden"),Te.textContent="",Te.classList.add("hidden"),Se.textContent="",Se.classList.add("hidden");if(us.innerHTML="",t.buildPaths.length){for(const n of t.buildPaths){const o=document.createElement("li");o.textContent=n,us.appendChild(o)}ds.classList.remove("hidden")}else ds.classList.add("hidden");Ie.classList.remove("hidden"),Ie.setAttribute("aria-hidden","false"),Fs.focus()}Fs.addEventListener("click",()=>{Ti()});Ie.addEventListener("click",r=>{r.target===Ie&&Ti()});document.addEventListener("keydown",r=>{r.key==="Escape"&&mt&&(r.preventDefault(),Ti())});function cr(r){var i;$e.classList.remove("hidden"),$e.setAttribute("aria-hidden","false"),Fa.textContent=r.icon,qa.textContent=r.name,Ha.textContent=r.description;let e;r.category!=="weapon"?e="Passive effect active.":r.evolved?e="Evolved form active.":r.progress?e=r.progress.ready?"Ready to evolve! Visit the workshop or fulfill the trigger to ascend this weapon.":`${r.progress.current}/${r.progress.required} ${r.progress.label} to evolve.`:e="Awakening — continue fighting to unlock evolution clues.",rs.textContent=e,rs.classList.toggle("ready",!!((i=r.progress)!=null&&i.ready)&&!r.evolved);const t=x[r.id];t!=null&&t.evolution?(nt.classList.remove("hidden"),nt.setAttribute("aria-hidden","false"),ls.textContent=t.evolution.name,cs.textContent=t.evolution.description):(nt.classList.add("hidden"),nt.setAttribute("aria-hidden","true"),ls.textContent="",cs.textContent="")}function zt(r,e){const i=(e??m.getHeroLoadout()).find(n=>n.id===r);if(!i)return;j=r,ct.querySelectorAll(".inventory-card").forEach(n=>{n.classList.toggle("active",n.dataset.itemId===r)}),cr(i)}function ui(){var t,i;const r=m.getHeroLoadout(),e=r.map(s=>{const n=s.progress?`${s.progress.current}-${s.progress.ready?"ready":"waiting"}`:"none";return`${s.id}:${s.evolved?"evolved":"base"}:${n}`}).join("|");if(r.length>0&&re&&e===yt){j&&r.some(s=>s.id===j)&&zt(j,r);return}if(yt=e,ct.innerHTML="",!r.length){const s=document.createElement("p");s.className="inventory-modal-empty",s.textContent="You have not collected any gear yet.",ct.appendChild(s),$e.classList.add("hidden"),$e.setAttribute("aria-hidden","true"),j=null;return}for(const s of r){const n=document.createElement("button");n.type="button",n.className="inventory-card",n.dataset.itemId=s.id;const o=document.createElement("span");o.className="inventory-card-icon",o.textContent=s.icon,o.setAttribute("aria-hidden","true"),n.appendChild(o);const l=document.createElement("span");l.className="inventory-card-content",n.appendChild(l);const a=document.createElement("span");a.className="inventory-card-name",a.textContent=s.name,l.appendChild(a);const c=document.createElement("span");c.className="inventory-card-status",s.category==="weapon"&&((t=s.progress)!=null&&t.ready)?(c.classList.add("ready"),c.textContent="Ready to evolve!"):s.category==="weapon"&&s.progress?c.textContent=`${s.progress.current}/${s.progress.required} ${s.progress.label} to evolve`:s.evolved?c.textContent="Evolved form active":s.category!=="weapon"?c.textContent="Passive effect active":c.textContent="Awakening",l.appendChild(c);const h=mr(s);n.title=h.long,n.addEventListener("click",()=>zt(s.id)),ct.appendChild(n)}(!j||!r.some(s=>s.id===j))&&(j=((i=r[0])==null?void 0:i.id)??null),j&&zt(j,r)}function hr(){if(re){ui();return}re=!0,ae(!1),Ae(),Me.classList.remove("hidden"),Me.setAttribute("aria-hidden","false"),yt="",ui(),Ns.focus()}function Pe(){re&&(re=!1,Me.classList.add("hidden"),Me.setAttribute("aria-hidden","true"),$e.setAttribute("aria-hidden","true"),yt="")}function Ve(){Wa.textContent=`${m.getRelicShards()}`}function Ct(r){const e=ge.get(r);if(!e)return;const t=ze.find(o=>o.weaponId===r);if(!t)return;const i=t.upgrades.length,s=t.upgrades.filter(o=>m.isMetaUpgradeUnlocked(o)).length,n=e.querySelector(".meta-weapon-card-status");n&&(n.textContent=`${s}/${i} upgrades unlocked`),e.classList.toggle("complete",s===i&&i>0)}function dr(){ge.clear(),ke.innerHTML="";for(const r of ze){const e=Is(r.weaponId),t=document.createElement("button");t.type="button",t.className="meta-weapon-card",t.dataset.weaponId=r.weaponId;const i=document.createElement("span");i.className="meta-weapon-card-icon",i.textContent=e.icon,i.setAttribute("aria-hidden","true"),t.appendChild(i);const s=document.createElement("span");s.className="meta-weapon-card-text",t.appendChild(s);const n=document.createElement("span");n.className="meta-weapon-card-name",n.textContent=e.name,s.appendChild(n);const o=document.createElement("span");o.className="meta-weapon-card-role",o.textContent=e.role,s.appendChild(o);const l=document.createElement("span");l.className="meta-weapon-card-status",s.appendChild(l),t.addEventListener("click",()=>ur(r.weaponId)),ge.set(r.weaponId,t),ke.appendChild(t),Ct(r.weaponId)}ke.classList.remove("hidden"),_t.classList.add("hidden"),fe=null}function Si(){const r=m.getRelicShards();for(const[e,t]of Ke.entries()){const i=pt(e),s=m.isMetaUpgradeUnlocked(e),n=i.prerequisites.every(a=>m.isMetaUpgradeUnlocked(a)),o=r>=i.cost,l=t.closest(".meta-upgrade-card");l&&(l.classList.toggle("meta-upgrade-card--unlocked",s),l.classList.toggle("meta-upgrade-card--locked",!s)),s?(t.disabled=!0,t.textContent="Unlocked"):n?(t.disabled=!o,t.textContent=`Unlock (${i.cost} shards)`):(t.disabled=!0,t.textContent="Prerequisite required"),t.classList.toggle("affordable",!s&&n&&o)}}function ki(r){Ke.clear(),Ue.innerHTML="";const e=ya(r);if(!e.length){const t=document.createElement("p");t.className="meta-upgrade-empty",t.textContent="No relic upgrades available for this weapon yet.",Ue.appendChild(t);return}for(const t of e){const i=document.createElement("div");i.className="meta-upgrade-card",i.dataset.tier=`${t.tier}`;const s=document.createElement("div");s.className="meta-upgrade-tier",s.textContent=`Tier ${t.tier}`,i.appendChild(s);const n=document.createElement("div");n.className="meta-upgrade-name",n.textContent=t.name,i.appendChild(n);const o=document.createElement("p");o.className="meta-upgrade-description",o.textContent=t.description,i.appendChild(o);const l=document.createElement("p");if(l.className="meta-upgrade-prereq",t.prerequisites.length){const c=t.prerequisites.map(h=>pt(h).name).join(", ");l.textContent=`Requires: ${c}`}else l.textContent="Requires: None";i.appendChild(l);const a=document.createElement("button");a.type="button",a.className="meta-upgrade-action",a.dataset.upgradeId=t.id,a.addEventListener("click",()=>{m.unlockMetaUpgrade(t.id)&&(Ks(),ki(r),Ve(),Ct(r))}),i.appendChild(a),Ke.set(t.id,a),Ue.appendChild(i)}Si()}function ur(r){fe=r;const e=Is(r),t=ze.find(i=>i.weaponId===r);Ua.textContent=e.icon,Ga.textContent=e.name,$a.textContent=(t==null?void 0:t.overview)??e.role,ke.classList.add("hidden"),_t.classList.remove("hidden"),ge.forEach((i,s)=>{i.classList.toggle("active",s===r)}),ki(r),Bs.focus()}function pr(){if(pe){Ve();for(const r of ze)Ct(r.weaponId);fe?ki(fe):Si();return}pe=!0,Pe(),ae(!1),Ce.classList.remove("hidden"),Ce.setAttribute("aria-hidden","false"),dr(),Ve(),yi.focus()}function Ae(){pe&&(pe=!1,Ce.classList.add("hidden"),Ce.setAttribute("aria-hidden","true"),ke.classList.remove("hidden"),_t.classList.add("hidden"),fe=null,Ke.clear(),Ue.innerHTML="",ge.forEach(r=>r.classList.remove("active")))}function Re(){var t;const r=m.getHeroLoadout(),e=new Set;for(let i=0;i<li.length;i++){const s=li[i],n=r[i];if(n){e.add(n.id),s.innerHTML="",s.classList.add("has-item"),s.classList.remove("empty"),s.classList.toggle("item-evolved",n.evolved);const o=n.category==="weapon"?n.evolved?"Evolved form active":n.progress?n.progress.ready?"Ready to evolve!":`${n.progress.current}/${n.progress.required} ${n.progress.label} to evolve`:"Awakening":"Passive effect active",l=n.evolved?"Evolved":n.progress?`${n.progress.current}/${n.progress.required} ${n.progress.label}`:n.status,a=document.createElement("div");a.className="item-icon",a.textContent=n.icon,s.appendChild(a);const c=document.createElement("div");c.className="item-info",s.appendChild(c);const h=document.createElement("div");h.className="item-name",h.textContent=n.name,c.appendChild(h);const p=document.createElement("div");p.className="item-progress-text",p.textContent=o;const u=!!((t=n.progress)!=null&&t.ready)&&!n.evolved;p.classList.toggle("ready",u),c.appendChild(p),s.dataset.itemId=n.id,s.title=`${n.name} — ${o}`,s.classList.toggle("evolution-ready",u);const f=rt.get(n.id)??!1;if(u&&!f){vr(),s.classList.add("evolution-ready-flash");const b=()=>{s.classList.remove("evolution-ready-flash"),s.removeEventListener("animationend",b)};s.addEventListener("animationend",b)}else u||s.classList.remove("evolution-ready-flash");rt.set(n.id,u);const y=`${n.description}<br /><em>${o}</em>`;s.onmouseenter=()=>Ee(n.name,y),s.onmouseleave=Q,s.onclick=b=>{b.target instanceof HTMLElement&&(b.target.closest(".item-icon")||b.currentTarget===b.target)&&vt(n.id,{progressText:l,evolved:n.evolved})},a.setAttribute("role","button"),a.setAttribute("aria-label",`${n.name} details`),a.tabIndex=0;const w=()=>vt(n.id,{progressText:l,evolved:n.evolved});a.addEventListener("click",b=>{b.stopPropagation(),w()}),a.addEventListener("keydown",b=>{(b.key==="Enter"||b.key===" ")&&(b.preventDefault(),w())})}else s.innerHTML="",s.classList.remove("has-item","item-evolved","evolution-ready","evolution-ready-flash"),s.classList.add("empty"),s.removeAttribute("data-item-id"),s.removeAttribute("title"),s.onmouseenter=null,s.onmouseleave=null,s.onclick=null}for(const i of Array.from(rt.keys()))e.has(i)||rt.delete(i);re&&ui()}function fr(){ns.innerHTML="",ci.clear();const r=new Set;for(const e of m.getBuildOrder()){if(r.has(e))continue;r.add(e);const t=Es[e],i=J(e),s=document.createElement("button");s.className="shop-button",s.innerHTML=`<span>${t.icon} ${t.name}</span><span class="price">${i.cost} Gold</span>`,s.addEventListener("click",()=>{const n=m.getBuildOrder().indexOf(e);n>=0&&(m.selectBlueprint(n),m.setBuildMode(!0),yr(),Re())}),s.addEventListener("mouseenter",()=>Ee(t.name,`${t.description}<br />Cost: ${i.cost} supplies.`)),s.addEventListener("mouseleave",Q),ns.appendChild(s),ci.set(e,s)}}function De(){!m.isBuildModeActive()&&K&&(K=!1,Q());const r=m.getSupplies(),e=m.getSelectedBlueprint();for(const[i,s]of ci.entries()){const n=J(i),o=r>=n.cost;s.classList.toggle("disabled",!o),s.classList.toggle("selected",i===e)}const t=!m.isBuildModeActive()||!K;La.classList.toggle("hidden",t),gr()}function gr(){const r=m.getSelectedBlueprint(),e=Es[r];if(!e){q.classList.remove("build-active","build-unaffordable"),q.dataset.tooltipTitle="Workshop closed",q.dataset.tooltipBody="Select a structure in the workshop to prepare a build plan.",q.removeAttribute("aria-pressed"),q.title="(B)uild";return}const t=J(r),i=m.canAffordBlueprint(r),s=m.isBuildModeActive(),n=`${e.icon} ${e.name} — ${t.cost} supplies`;q.dataset.tooltipTitle=e.name,q.dataset.tooltipBody=`${e.description}<br />Cost: ${t.cost} supplies.`,q.title=n,q.setAttribute("aria-pressed",s?"true":"false"),q.classList.toggle("build-active",s),q.classList.toggle("build-unaffordable",!i)}let We=!1,gs=null,ut=!1,ue=!1,Y=null;const Ge=new Set;let Z=null,K=!1,re=!1,j=null;const rt=new Map;let pe=!1,fe=null;const Ke=new Map,ge=new Map;let jt=null,yt="";function mr(r){if(r.category!=="weapon")return{short:"Passive",long:`${r.name} — Passive effect active`};if(r.evolved)return{short:"Evolved",long:`${r.name} — Evolved form active`};const e=r.progress;if(!e)return{short:"Awakening",long:`${r.name} — Awakening`};if(e.ready)return{short:"Ready to Evolve",long:`${r.name} — Ready to Evolve!`};const t=`${e.current}/${e.required} ${e.label}`;return{short:t,long:`${r.name} — ${t} to Evolve`}}function vr(){try{if(!jt){const n=window.AudioContext||window.webkitAudioContext;if(!n)return;jt=new n}const r=jt;if(!r)return;const e=r.currentTime,t=.3,i=r.createOscillator();i.type="triangle",i.frequency.setValueAtTime(640,e),i.frequency.linearRampToValueAtTime(880,e+t);const s=r.createGain();s.gain.setValueAtTime(1e-4,e),s.gain.exponentialRampToValueAtTime(.18,e+.04),s.gain.exponentialRampToValueAtTime(1e-4,e+t),i.connect(s).connect(r.destination),i.start(e),i.stop(e+t)}catch(r){console.warn("Unable to play evolution cue",r)}}function bt(){m.isBuildModeActive()||m.setBuildMode(!0),K||(K=!0),!_.isCompleted("building")&&!_.isQueued("building")&&_.request("building",{priority:!0}),De()}function yr(){K&&(K=!1,Q()),De()}function wt(){m.isBuildModeActive()&&m.setBuildMode(!1),K&&(K=!1,Q()),De()}function ae(r){const e=r&&m.isDowntime();if(e&&(Pe(),Ae()),We===e){e||Q(),me();return}We=e,We&&m.isBuildModeActive()&&wt(),We||Q(),me()}function br(){os.innerHTML="",hi.clear();for(const r of Ms){const e=x[r],t=document.createElement("button");t.className="shop-button";const i=document.createElement("span");i.className="shop-button-label";const s=document.createElement("span");s.className="shop-item-icon",s.textContent=e.icon,s.setAttribute("role","button"),s.setAttribute("aria-label",`${e.name} details`),s.tabIndex=0;const n=document.createElement("span");n.className="shop-item-name",n.textContent=e.name,i.append(s,n);const o=document.createElement("span");o.className="price",t.append(i,o),t.addEventListener("click",()=>{m.purchaseItem(r)&&me()}),t.addEventListener("mouseenter",()=>Ee(e.name,`${e.description}<br /><em>${e.role}</em>`)),t.addEventListener("mouseleave",Q),s.addEventListener("click",l=>{l.stopPropagation(),vt(r)}),s.addEventListener("keydown",l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),vt(r))}),os.appendChild(t),hi.set(r,t)}me()}function me(){const r=m.isDowntime();for(const[t,i]of hi.entries()){const s=x[t],n=m.isItemOwned(t),o=m.canPurchaseItem(t),l=i.querySelector(".price");l&&(n?l.textContent="Owned":r?l.textContent=`${s.cost} Gold`:l.textContent="Closed during wave");const a=n||!o||!r;i.disabled=a;const c=!n&&(!o||!r);i.classList.toggle("disabled",c),i.classList.toggle("owned",n)}const e=We&&r;Oa.classList.toggle("hidden",!e)}function pi(){wr(),Tr()}function wr(){const r=m.getCreepCamps(),e=new Set(m.getNearbyCreepCampIds());let t=0;for(const a of r)at.has(a.id)||(t+=1);Mt.classList.toggle("hidden",t>0);const i=new Set;let s=1,n=1,o=0,l=0;if(t>0){const a=D.getBoundingClientRect(),c=qe.getBoundingClientRect();s=a.width/D.width,n=a.height/D.height,o=a.left-c.left,l=a.top-c.top}for(const a of r){if(at.has(a.id))continue;i.add(a.id);let c=Ne.get(a.id);c||(c=document.createElement("div"),c.className="camp-marker",c.innerHTML=`
        <div class="activity-item">
          <span class="activity-icon">🐾</span>
          <div class="activity-body">
            <div class="activity-title"></div>
            <div class="activity-subtext"></div>
          </div>
        </div>
      `,Os.appendChild(c),Ne.set(a.id,c));const h=c.querySelector(".activity-item"),p=c.querySelector(".activity-title"),u=c.querySelector(".activity-subtext");if(h&&h.classList.toggle("completed",a.cleared),p&&(p.textContent=a.name),u){const I=a.unitIds.length,E=a.rewardRelicShards===1?"shard":"shards";u.textContent=a.cleared?"Cleared":`${I} foes remain • ${a.rewardSupplies} gold & ${a.rewardRelicShards} ${E}`}const f=(a.position.x-k.center.x)*k.zoom+D.width/2,y=(a.position.y-k.center.y)*k.zoom+D.height/2,w=o+f*s,b=l+y*n;if(c.style.left=`${w}px`,c.style.top=`${b}px`,e.has(a.id)&&!a.cleared){c.classList.add("highlighted");const I=a.radius*k.zoom*n+12;c.style.transform=`translate(-50%, -100%) translateY(-${I}px)`}else c.classList.remove("highlighted"),c.style.transform="translate(-50%, -100%)";if(a.cleared){if(h&&!Be.has(a.id)){h.classList.add("defeated"),c.classList.add("defeated");const E=window.setTimeout(()=>{const A=c==null?void 0:c.querySelector(".activity-item");A==null||A.classList.remove("defeated"),c==null||c.remove(),Ne.delete(a.id),Be.delete(a.id),at.add(a.id)},2100);Be.set(a.id,E)}}else h&&(h.classList.remove("defeated"),c.classList.remove("defeated"));const C=f>=0&&f<=D.width&&y>=0&&y<=D.height;c.classList.toggle("hidden",!C)}for(const[a,c]of Ne.entries())if(!i.has(a)){const h=Be.get(a);h!=null&&(window.clearTimeout(h),Be.delete(a)),c.remove(),Ne.delete(a),at.delete(a)}}function Tr(){const r=m.getTemporaryBuffs();if($t.innerHTML="",!r.length){const e=document.createElement("li");e.className="activity-empty",e.textContent="No active blessings.",$t.appendChild(e);return}for(const e of r){const t=document.createElement("li");t.className="activity-item",t.innerHTML=`
      <span class="activity-icon">✨</span>
      <div class="activity-body">
        <div class="activity-title">${e.description}</div>
        <div class="activity-subtext">Expires after wave ${e.expiresAtWave}</div>
      </div>
    `,$t.appendChild(t)}}function Qe(){const r=m.getQuestLogEntries();if(Vt.innerHTML="",!r.length){const e=document.createElement("li");e.className="quest-log-empty",e.textContent="No active quests. Visit a village to discover new contracts.",Vt.appendChild(e);return}for(const e of r){const t=document.createElement("li");t.className=`quest-log-entry ${e.state}`;const i=document.createElement("div");i.className="quest-log-entry-header";const s=document.createElement("span");s.className="quest-log-entry-icon",s.textContent=e.icon,i.appendChild(s);const n=document.createElement("div");n.className="quest-log-entry-text";const o=document.createElement("div");o.className="quest-log-entry-title",o.textContent=`${e.giverName} — ${e.villageName}`;const l=document.createElement("div");l.className="quest-log-entry-description",l.textContent=e.description,n.appendChild(o),n.appendChild(l),i.appendChild(n),t.appendChild(i);const a=document.createElement("div");a.className="quest-log-entry-reward",a.textContent=e.rewardText,t.appendChild(a);const c=document.createElement("div");c.className="quest-log-entry-status",c.textContent=e.state==="completed"?"Ready to turn in":"In progress",t.appendChild(c);const h=document.createElement("div");h.className="quest-log-entry-progress";const p=document.createElement("span"),u=e.requiredTime>0?Math.min(1,e.progress/e.requiredTime):e.state==="completed"?1:0;p.style.width=`${u*100}%`,h.appendChild(p),t.appendChild(h),Vt.appendChild(t)}}function Tt(r){const e=!!r;if(ue===e){e&&Qe();return}ue=e,ft.classList.toggle("hidden",!e),ft.setAttribute("aria-hidden",e?"false":"true"),e&&Qe()}function Sr(r){var t,i;_.isCompleted("noise")&&!_.isCompleted("quests")&&!_.isQueued("quests")&&_.request("quests",{priority:!0}),Y=r,_e.classList.remove("hidden"),_e.setAttribute("aria-hidden","false"),Xa.textContent=((t=r.offer)==null?void 0:t.icon)??((i=r.activeQuest)==null?void 0:i.icon)??"📜",Za.textContent=r.giverName,Ja.textContent=r.villageName,er.textContent=r.greeting,r.state==="offering"&&r.offer?(Kt.textContent=r.offer.description,Qt.textContent=r.offer.rewardText,ht.textContent="Accept Quest",dt.textContent="Not now"):r.state==="turnIn"&&r.activeQuest?(Kt.textContent=r.activeQuest.description,Qt.textContent=r.activeQuest.rewardText,ht.textContent="Turn In Quest",dt.textContent="Later"):(Kt.textContent="",Qt.textContent="",ht.textContent="Close",dt.textContent="Later");const e=r.activeQuest;if(e){const s=r.state==="turnIn"?1:e.requiredTime>0?Math.min(1,e.progress/e.requiredTime):0;ps.classList.remove("hidden"),fs.style.width=`${s*100}%`}else ps.classList.add("hidden"),fs.style.width="0%"}function St(){if(_e.classList.contains("hidden")){Y=null;return}_e.classList.add("hidden"),_e.setAttribute("aria-hidden","true"),Y=null}function kr(){const r=m.getNearbyQuestInteraction();if(!(r&&(r.state==="offering"||r.state==="turnIn"))){Z!=null&&(!r||r.giverId!==Z)&&(Ge.delete(Z),Z=null),St();return}if(r.giverId!==Z&&(Z!=null&&Ge.delete(Z),Z=r.giverId),Ge.has(r.giverId)){St();return}Sr(r)}function _r(){if(!Y)return;const r=Y.giverId;let e=!1;Y.state==="offering"?(e=m.acceptQuestFromGiver(r),e&&(Re(),pi(),ue&&Qe())):Y.state==="turnIn"&&(e=m.turnInQuestFromGiver(r),e&&(Re(),pi(),ue&&Qe())),e&&(Ge.delete(r),Z=null,St(),Y=null)}function _i(){Y&&Ge.add(Y.giverId),St()}fr();br();Re();De();me();const Gs=r=>{const e=D.getBoundingClientRect(),t=D.width/e.width,i=D.height/e.height,s=(r.clientX-e.left)*t,n=(r.clientY-e.top)*i;return{x:s,y:n}},$s=(r,e)=>{const t=(r-D.width/2)/k.zoom+k.center.x,i=(e-D.height/2)/k.zoom+k.center.y;return{x:t,y:i}},Vs=r=>{const{x:e,y:t}=Gs(r),{x:i,y:s}=$s(e,t);return{x:Math.max(0,Math.min(M,i)),y:Math.max(0,Math.min(G,s))}};D.addEventListener("pointerdown",r=>{const{x:e,y:t}=Vs(r);r.button===2&&r.preventDefault();const i=m.getBuildings().length,s=m.isBuildModeActive();m.onPointerDown(e,t,r.button,r.timeStamp/1e3);const n=m.getBuildings().length;r.button===0&&!s&&_.complete("movement"),n>i&&_.complete("building")});D.addEventListener("pointermove",r=>{const{x:e,y:t}=Vs(r);m.onPointerMove(e,t)});D.addEventListener("wheel",r=>{r.preventDefault();const{x:e,y:t}=Gs(r),i=$s(e,t),s=Math.exp(-r.deltaY*.001),n=Math.max(Ps,Math.min(As,k.zoom*s));if(n===k.zoom)return;k.zoom=n;const o=e-D.width/2,l=t-D.height/2;k.center.x=i.x-o/k.zoom,k.center.y=i.y-l/k.zoom,kt()},{passive:!1});D.addEventListener("contextmenu",r=>{r.preventDefault()});q.addEventListener("click",()=>{ae(!1),m.isBuildModeActive()&&K?wt():bt()});q.addEventListener("mouseenter",()=>{const r=q.dataset.tooltipTitle,e=q.dataset.tooltipBody;r&&e?Ee(r,e):Ee("(B)uild","Select a structure in the workshop to prepare a build plan.")});q.addEventListener("mouseleave",Q);Ba.addEventListener("click",()=>Tt(!1));ft.addEventListener("click",r=>{r.target===ft&&Tt(!1)});Ns.addEventListener("click",()=>Pe());Me.addEventListener("click",r=>{r.target===Me&&Pe()});yi.addEventListener("click",()=>Ae());Ce.addEventListener("click",r=>{r.target===Ce&&Ae()});Bs.addEventListener("click",()=>{const r=fe;if(ke.classList.remove("hidden"),_t.classList.add("hidden"),fe=null,Ke.clear(),Ue.innerHTML="",ge.forEach(e=>e.classList.remove("active")),Ve(),r){const e=ge.get(r);e==null||e.focus()}else yi.focus()});ht.addEventListener("click",_r);dt.addEventListener("click",_i);tr.addEventListener("click",_i);window.addEventListener("keydown",r=>{if(r.key==="F1"){r.preventDefault(),m.toggleAnchorDebug();return}const e=r.key.toLowerCase(),t=r.code;if(e==="escape"){if(pe){Ae(),r.preventDefault();return}if(re){Pe(),r.preventDefault();return}if(ue){Tt(!1),r.preventDefault();return}if(!_e.classList.contains("hidden")){_i(),r.preventDefault();return}if(m.isBuildModeActive()){wt(),r.preventDefault();return}}e==="r"?(m.reset(),m.setCanvasHudEnabled(!1),ii({zoom:mi}),H.up=H.down=H.left=H.right=!1,Re(),De(),ae(!1),ut=!1,me(),He=m.getSupplies(),bi(),ai=m.getTotalKills(),ri=m.isKnightAtTavern()):e==="b"?(r.preventDefault(),ae(!1),m.isBuildModeActive()&&K?wt():bt()):e==="i"?(r.preventDefault(),re?Pe():hr()):e==="t"?(r.preventDefault(),pe?Ae():pr()):e==="q"?(r.preventDefault(),Tt(!ue)):e==="c"?m.toggleCanopy():t==="Space"?(r.preventDefault(),ii()):t==="KeyW"?(r.preventDefault(),H.up=!0):t==="KeyS"?(r.preventDefault(),H.down=!0):t==="KeyA"?(r.preventDefault(),H.left=!0):t==="KeyD"?(r.preventDefault(),H.right=!0):e==="x"&&m.startDismantle()});window.addEventListener("keyup",r=>{switch(r.code){case"KeyW":H.up=!1;break;case"KeyS":H.down=!1;break;case"KeyA":H.left=!1;break;case"KeyD":H.right=!1;break}});function Ks(){const r=m.getSupplies();r>He?rr(r-He):r<He&&bi(),He=r,Ca.textContent=`${r}`;const e=m.getRelicShards();if(e>ot?lr(e-ot):e<ot&&Us(),ot=e,Ia.textContent=`${e}`,Ve(),pe){for(const y of ze)Ct(y.weaponId);Si()}const t=Math.max(0,m.knight.hp),i=Math.max(0,Math.min(1,t/oe));Ea.style.width=`${i*100}%`,Pa.textContent=`${Math.ceil(t)}/${oe}`;const s=m.getTotalKills();s>ai&&_.isCompleted("movement")&&!_.isCompleted("combat")&&_.request("combat",{priority:!0}),ai=s;const{phase:n,remaining:o,duration:l,waveIndex:a}=m.getPhaseTimerInfo(),c=l>0?1-Math.max(0,Math.min(1,o/l)):1;Aa.style.width=`${c*100}%`;let h;n==="downtime"?h=`Downtime: Wave ${a+1} begins in ${di(o)}`:o>0?h=`Wave ${a} underway — ${di(o)} remaining`:h=`Wave ${a} underway — clear remaining forces!`,Ra.textContent=h;const p=m.isKnightAtTavern()&&m.isDowntime();p?(ut=!0,ae(!0)):ut&&(ae(!1),ut=!1),p&&!ri&&_.isCompleted("quests")&&!_.isCompleted("healing")&&!_.isQueued("healing")&&_.request("healing",{priority:!0}),ri=p,gs!==n&&(n==="wave"?(ae(!1),_.isCompleted("movement")&&!_.isCompleted("combat")&&!_.isQueued("combat")&&_.request("combat",{priority:!0})):n==="downtime"&&_.isCompleted("combat")&&!_.isCompleted("building")&&!_.isQueued("building")&&_.request("building",{priority:!0}),gs=n);const u=m.state==="victory"||m.state==="defeat";Na.classList.toggle("hidden",!u),u&&(m.state==="victory"?(st.textContent="Dominion Secured",st.style.color="#34d399",as.textContent="Press R to celebrate again."):(st.textContent="You Have Perished",st.style.color="#f87171",as.textContent="Press R to try again."));const f=m.getBuildErrorMessage();f?(Oe.textContent=f,Oe.classList.add("visible")):(Oe.textContent&&(Oe.textContent=""),Oe.classList.remove("visible")),Re(),De(),me(),pi(),ue&&Qe(),kr()}const Mr=Ls;let ms=performance.now();function Qs(r){const e=r-ms;ms=r;const t=Math.min(e/1e3,.2);si?ss(0):(ss(t),m.update(t));const i={center:k.center,zoom:k.zoom,viewportWidth:D.width,viewportHeight:D.height};m.draw(Mr,i),Ks(),requestAnimationFrame(Qs)}requestAnimationFrame(Qs);
